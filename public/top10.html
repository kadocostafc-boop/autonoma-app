<!doctype html><html lang="pt-BR"><head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Top 10 Profissionais ‚Ä¢ Aut√¥noma.app</title>
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#1f4bd8">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <link rel="icon" href="/favicon.ico">
  <link rel="stylesheet" href="/css/app.css">
  <style>
    .wrap{max-width:1120px;margin:0 auto;padding:16px}
    .grid{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:760px){.grid{grid-template-columns:1fr 1fr}}
    @media(min-width:1100px){.grid{grid-template-columns:1fr 1fr 1fr}}
    .card-pro{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:12px;display:flex;gap:10px;align-items:center}
    .photo{width:64px;height:64px;border-radius:12px;object-fit:cover;border:1px solid #e5e7eb;background:#f8fafc}
    .name{margin:0;font-weight:900}
    .muted{color:#64748b}
    .rating{color:#f59e0b}
    .btn{padding:8px 12px;border-radius:10px}
  </style>
</head><body>
  <header class="header">
    <img src="/icons/icon-192.png" alt="Aut√¥noma.app" class="logo"/>
    <div class="brand">
      <strong>Aut√¥noma<span class="dot">.app</span></strong>
      <span class="tag">Top 10</span>
    </div>
    <div style="margin-left:auto;display:flex;gap:8px">
      <a class="btn ghost" href="/">In√≠cio</a>
      <a class="btn outline" href="/clientes.html">Buscar</a>
      <a class="btn outline" href="/favoritos.html">Favoritos</a>
    </div>
  </header>

  <main class="wrap">
    <div class="card">
      <h1 style="margin:0">üèÜ Top 10 profissionais</h1>
      <p class="meta">Baseado em avalia√ß√µes, atendimento e relev√¢ncia recente.</p>
    </div>
    <section id="list" class="grid" aria-live="polite"></section>
    <div id="err" class="card meta" style="display:none">N√£o foi poss√≠vel carregar o Top 10.</div>
  </main>

  <script>
  (function(){
    const list = document.getElementById('list');
    const err  = document.getElementById('err');
    const NO_STORE = { cache:'no-store' };
    const esc = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    const estrelas = (n)=>{ const r=Math.round((Number(n)||0)*2)/2; const f=Math.floor(r),h=(r%1!==0); return "‚òÖ".repeat(f)+(h?"¬Ω":"")+"‚òÜ".repeat(5-f-(h?1:0)); };

    function card(p, idx){
      const id = p.id;
      const foto = p.foto || '/icons/icon-192.png';
      const nome = p.nome || 'Profissional';
      const serv = p.servico || p.profissao || '';
      const local = [p.bairro,p.cidade].filter(Boolean).join(' ‚Ä¢ ');
      const rate = Number(p.rating||0);
      const avals = Number(p.avaliacoes||0);
      return `
        <article class="card-pro">
          <div class="pill" style="min-width:32px;text-align:center;font-weight:800">#${idx+1}</div>
          <img class="photo" src="${esc(foto)}" alt="Foto de ${esc(nome)}" onerror="this.src='/icons/icon-192.png'">
          <div style="flex:1 1 auto;min-width:0">
            <h3 class="name">${esc(nome)}</h3>
            <div class="muted">${esc(serv)} ‚Ä¢ ${esc(local)}</div>
            <div class="rating">${estrelas(rate)} <span class="muted">(${avals})</span></div>
          </div>
          <a class="btn" href="/profissional/${encodeURIComponent(id)}">Ver</a>
        </article>
      `;
    }

    async function loadTop(){
      list.innerHTML = `<div class="meta">Carregando‚Ä¶</div>`;
      err.style.display='none';
      try{
        // 1) endpoint dedicado se existir
        let r = await fetch('/api/profissionais/top?limit=10&ts='+Date.now(), NO_STORE);
        let js = r.ok ? await r.json() : null;
        let items = (js && (js.items || js.top)) || [];

        // 2) fallback por score/featured
        if(!items.length){
          r = await fetch('/api/profissionais?featured=1&limit=10&sort=score&dir=desc&ts='+Date.now(), NO_STORE);
          js = r.ok ? await r.json() : null;
          items = js?.items || [];
        }
        // 3) fallback geral
        if(!items.length){
          r = await fetch('/api/profissionais?limit=10&sort=score&dir=desc&ts='+Date.now(), NO_STORE);
          js = r.ok ? await r.json() : null;
          items = js?.items || [];
        }

        if(!items.length){ list.innerHTML = `<div class="meta">Sem dados para exibir.</div>`; return; }
        list.innerHTML = items.map((p,i)=>card(p,i)).join('');
      }catch(_){
        list.innerHTML='';
        err.style.display='';
      }
    }

    // atualiza SW para evitar cache teimoso
    if('serviceWorker' in navigator){ navigator.serviceWorker.getRegistrations().then(rs=>rs.forEach(r=>r.update())).catch(()=>{}); }
    loadTop();
  })();
  </script>
</body></html>