<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin • Autônoma.app</title>
  <meta name="theme-color" content="#2d6cdf">
  <link rel="stylesheet" href="/css/app.css?v=admin-2025-09-08">
  <!-- Chart.js (gráficos bonitos) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>
    .header { display:flex; align-items:center; gap:12px; padding:12px 16px; }
    .header .logo { height:32px; width:auto; display:block; }
    .header .home { margin-left:auto }
    .wrap-max{ max-width:1120px; margin:0 auto; padding:16px; }

    .cards{ display:grid; grid-template-columns:1fr; gap:12px; }
    @media (min-width:920px){ .cards{ grid-template-columns: repeat(3, 1fr); } }
    .kpi{ background:#fff; border:1px solid #e5e7eb; border-radius:16px; padding:14px; }
    .kpi strong{ font-size:20px }
    .kpi .meta{ color:#64748b }

    .panel{ background:#fff; border:1px solid #e5e7eb; border-radius:16px; padding:14px; }
    .grid2{ display:grid; grid-template-columns:1fr; gap:16px; }
    @media (min-width:920px){ .grid2{ grid-template-columns: 2fr 1fr; } }
    .charts-col { display:grid; gap:16px; grid-template-rows: 1fr 1fr; }

    .chart-box{ background:#fafafa; border:1px solid #e5e7eb; border-radius:14px; padding:10px; }
    .chart-title{ margin:0 0 6px; font-size:14px; color:#334155; font-weight:600 }
    .chart-wrap{ position:relative; width:100%; height:280px; }
    @media (min-width:920px){ .chart-wrap { height:240px; } }

    .toolbar { display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:10px }
    .table{ width:100%; border-collapse: collapse; }
    .table th, .table td{ border-bottom:1px solid #e5e7eb; padding:8px; text-align:left; font-size:14px; vertical-align:middle }
    .table th{ background:#f8fafc; position:sticky; top:0; z-index:1 }

    .badge{ font-size:12px; padding:3px 8px; border-radius:999px; border:1px solid #e5e7eb; background:#f1f5f9 }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .meta{ color:#64748b }
    .warn{ color:#b91c1c }

    .avatar { width:38px; height:38px; border-radius:999px; object-fit:cover; object-position:center; border:1px solid #e5e7eb; background:#f1f5f9; }
    .namecell{ display:flex; align-items:center; gap:8px; min-width:220px }
    .rating-low{ color:#b91c1c; font-weight:600 }

    .status-pill{ font-size:12px; padding:2px 6px; border-radius:999px; border:1px solid #fecaca; background:#fee2e2; color:#991b1b }

    a:focus, button:focus, select:focus, input:focus { outline:3px solid #a5b4fc; outline-offset:2px; }

    /* ===== Denúncias ===== */
    .den-grid { display:grid; grid-template-columns: 1fr; gap:12px; }
    @media (min-width:980px){ .den-grid { grid-template-columns: 2fr 1fr; } }
    .chip { font-size:12px; padding:3px 8px; border-radius:999px; border:1px solid #e5e7eb; background:#f8fafc }
    .chip.aberta{ border-color:#93c5fd; background:#eff6ff; color:#1d4ed8 }
    .chip.em_analise{ border-color:#fde68a; background:#fffbeb; color:#92400e }
    .chip.resolvida{ border-color:#bbf7d0; background:#ecfccb; color:#166534 }
    .chip.descartada{ border-color:#fecaca; background:#fee2e2; color:#991b1b }
    .den-actions .btn{ padding:6px 8px; }
    .den-card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:10px; }

    /* ===== Badges de plano ===== */
    .plan-badge{ font-size:12px; padding:3px 8px; border-radius:999px; border:1px solid #e5e7eb; background:#f1f5f9; font-weight:800; margin-left:6px }
    .plan-badge.PRO{ background:#eef2ff; border-color:#6366f1 }
    .plan-badge.PREMIUM{ background:#fffbeb; border-color:#fbbf24 }
  </style>
</head>
<body>
  <header class="header">
    <a href="/" aria-label="Início">
      <img src="/img/logo.png" alt="Autônoma.app" class="logo" onerror="this.style.display='none'">
    </a>
    <div class="home">
      <a class="btn ghost" href="/">Início</a>
      <a class="btn outline" href="/admin/logout">Sair</a>
    </div>
  </header>

  <main class="wrap-max">
    <!-- KPIs -->
    <div class="cards" id="kpis">
      <div class="kpi"><div class="meta">Profissionais (ativos)</div><strong id="k_ativos">—</strong></div>
      <div class="kpi"><div class="meta">Suspensos</div><strong id="k_susp">—</strong></div>
      <div class="kpi"><div class="meta">Excluídos</div><strong id="k_exc">—</strong></div>
      <div class="kpi"><div class="meta">Visitas (total)</div><strong id="k_vis">—</strong></div>
      <div class="kpi"><div class="meta">Chamadas (total)</div><strong id="k_calls">—</strong></div>
      <div class="kpi"><div class="meta">Nota média geral</div><strong id="k_avg">—</strong></div>
    </div>

    <!-- Gráficos -->
    <div class="panel" style="margin-top:12px">
      <div class="grid2">
        <div>
          <h2 style="margin:6px 0 12px">Métricas (últimos 30 dias)</h2>
          <div class="chart-box">
            <p class="chart-title">Visitas • Chamadas • Cadastros</p>
            <div class="chart-wrap"><canvas id="chartLines" aria-label="Série temporal"></canvas></div>
          </div>
        </div>
        <div class="charts-col">
          <div class="chart-box">
            <p class="chart-title">Verificados</p>
            <div class="chart-wrap"><canvas id="chartPie" aria-label="Verificados"></canvas></div>
          </div>
          <div class="chart-box">
            <p class="chart-title">Top serviços</p>
            <div class="chart-wrap"><canvas id="chartBars" aria-label="Top serviços"></canvas></div>
          </div>
        </div>
      </div>
      <p id="errMet" class="meta warn" style="display:none; margin-top:8px">Falha ao carregar métricas do admin.</p>

      <div class="row" style="margin-top:10px">
        <button id="btnRecompute" class="btn outline">Recalcular verificações</button>
        <a id="btnCSV" class="btn" href="/api/admin/export/csv" target="_blank" rel="noopener">Exportar CSV</a>
        <a class="btn ghost" href="/api/admin/export?what=profissionais" target="_blank" rel="noopener">Profissionais CSV</a>
        <a class="btn ghost" href="/api/admin/export?what=metrics" target="_blank" rel="noopener">Métricas CSV</a>
      </div>
    </div>

    <!-- Filtros da lista -->
    <div class="panel" style="margin-top:12px">
      <div class="toolbar">
        <input id="f_q" class="input" placeholder="Buscar (nome, serviço, bairro…)" style="min-width:220px">
        <input id="f_cidade" class="input" placeholder="Cidade" list="lista-cidades" style="min-width:160px">
        <datalist id="lista-cidades"></datalist>
        <input id="f_serv" class="input" placeholder="Serviço/Profissão" style="min-width:160px">
        <select id="f_verif" class="input">
          <option value="all">Todos</option>
          <option value="true">Verificados</option>
          <option value="false">Não verificados</option>
        </select>
        <select id="f_status" class="input">
          <option value="all">Todos</option>
          <option value="ativos">Ativos</option>
          <option value="suspensos">Suspensos</option>
          <option value="excluidos">Excluídos</option>
        </select>
        <select id="f_sort" class="input">
          <option value="recent">Recentes</option>
          <option value="nome">Nome</option>
          <option value="cidade">Cidade</option>
          <option value="servico">Serviço</option>
          <option value="verificado">Verificado</option>
          <option value="avaliacoes">Avaliações</option>
          <option value="rating">Rating</option>
          <option value="visitas">Visitas</option>
          <option value="chamadas">Chamadas</option>
        </select>
        <select id="f_dir" class="input">
          <option value="desc">Desc</option>
          <option value="asc">Asc</option>
        </select>
        <button id="f_go" class="btn">Filtrar</button>
      </div>

      <!-- Tabela -->
      <div style="overflow:auto; max-height:540px">
        <table class="table" id="tab">
          <thead>
          <tr>
            <th>ID</th>
            <th>Profissional</th>
            <th>Cidade</th>
            <th>Bairro</th>
            <th>Serviço</th>
            <th>Verif.</th>
            <th>Rating</th>
            <th>Aval.</th>
            <th>Visitas</th>
            <th>Chamadas</th>
            <th>Ações</th>
          </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="row" style="justify-content:space-between; margin-top:10px">
        <div class="meta" id="listInfo">—</div>
        <div class="row">
          <button id="prev" class="btn ghost" aria-label="Página anterior">«</button>
          <span id="pageInfo" class="meta">1/1</span>
          <button id="next" class="btn ghost" aria-label="Próxima página">»</button>
        </div>
      </div>
      <p id="errList" class="meta warn" style="display:none">Erro ao carregar lista.</p>
    </div>

    <!-- Denúncias -->
    <div class="panel" style="margin-top:12px">
      <div class="den-grid">
        <div>
          <h2 style="margin:6px 0 12px">Denúncias</h2>
          <div class="toolbar">
            <select id="d_status" class="input">
              <option value="all">Todos os status</option>
              <option value="aberta">Abertas</option>
              <option value="em_analise">Em análise</option>
              <option value="resolvida">Resolvidas</option>
              <option value="descartada">Descartadas</option>
            </select>
            <input id="d_q" class="input" placeholder="Buscar por motivo/descrição/ID prof.">
            <button id="d_go" class="btn">Filtrar</button>
          </div>
          <div style="overflow:auto; max-height:420px">
            <table class="table" id="tabDen">
              <thead>
              <tr>
                <th>ID</th>
                <th>Quando</th>
                <th>Profissional</th>
                <th>Motivo</th>
                <th>Status</th>
                <th>Ações</th>
              </tr>
              </thead>
              <tbody id="tbodyDen"></tbody>
            </table>
          </div>
          <div class="row" style="justify-content:space-between; margin-top:10px">
            <div class="meta" id="denInfo">—</div>
            <div class="row">
              <button id="d_prev" class="btn ghost" aria-label="Página anterior">«</button>
              <span id="d_pageInfo" class="meta">1/1</span>
              <button id="d_next" class="btn ghost" aria-label="Próxima página">»</button>
            </div>
          </div>
          <p id="errDen" class="meta warn" style="display:none">Erro ao carregar denúncias.</p>
        </div>
        <div>
          <div class="den-card">
            <h3 style="margin:0 0 6px">Resumo</h3>
            <div class="meta" id="denResumo">—</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Pagamentos (últimos) -->
    <div class="panel" style="margin-top:12px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2 style="margin:6px 0 12px">Pagamentos (últimos)</h2>
        <div class="row">
          <button id="pay_reload" class="btn outline">Recarregar</button>
          <a class="btn" href="/api/admin/export?what=payments" target="_blank" rel="noopener">Exportar pagamentos CSV</a>
        </div>
      </div>
      <div id="pay_list" class="meta">—</div>
    </div>
  </main>

  <script>
  (function(){
    const $ = (id)=> document.getElementById(id);

    // ======= KPIs =======
    const kAtivos=$('k_ativos'), kSusp=$('k_susp'), kExc=$('k_exc'),
          kVis=$('k_vis'), kCalls=$('k_calls'), kAvg=$('k_avg');

    // ======= Chart.js canvases =======
    const cLines=$('chartLines'), cPie=$('chartPie'), cBars=$('chartBars');
    const errMet=$('errMet');

    // Recompute / CSV
    const btnRecompute=$('btnRecompute'), btnCSV=$('btnCSV');

    // Lista profissionais
    const f_q=$('f_q'), f_cidade=$('f_cidade'), f_serv=$('f_serv'),
          f_verif=$('f_verif'), f_status=$('f_status'),
          f_sort=$('f_sort'), f_dir=$('f_dir'), f_go=$('f_go');
    const tbody=$('tbody'), listInfo=$('listInfo'),
          prev=$('prev'), next=$('next'), pageInfo=$('pageInfo');
    const dlCidades=$('lista-cidades');
    let PAGE=1, PAGES=1;

    // Denúncias
    const d_status=$('d_status'), d_q=$('d_q'), d_go=$('d_go');
    const tbodyDen=$('tbodyDen'), denInfo=$('denInfo'),
          d_prev=$('d_prev'), d_next=$('d_next'), d_pageInfo=$('d_pageInfo');
    const errDen=$('errDen');
    let D_PAGE=1, D_PAGES=1;

    let metricsCache=null;

    async function apiJSON(url, opt){
      const r = await fetch(url, { cache:'no-store', ...(opt||{}) });
      if(!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }
    function escapeHtml(s){
      return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;")
        .replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");
    }
    async function postJSON(url, body){
      const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body||{}) });
      if (!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }

    // ====== Chart.js instances ======
    let lineChart, pieChart, barChart;

    function buildOrUpdateCharts(m){
      // ---- Dados
      const days = (m.timeseries?.days||[]);
      const labels = days.map(d => String(d.date||'').slice(5));
      const visits = days.map(d => Number(d.visits||0));
      const calls  = days.map(d => Number(d.calls||0));
      const signups= days.map(d => Number(d.signups||0));

      const vYes = Number(m.verified?.yes||0);
      const vNo  = Number(m.verified?.no ||0);

      const topServ = (m.top?.servicos||[]);
      const barLabels = topServ.map(x => String(x.name||''));
      const barValues = topServ.map(x => Number(x.value||0));

      // ---- Estilos
      const baseOpts = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { labels:{ boxWidth: 12 } },
          tooltip: { mode: 'index', intersect: false }
        },
        interaction: { mode: 'index', intersect: false }
      };

      // ---- Line
      const lineData = {
        labels,
        datasets: [
          { label:'Visitas', data:visits, borderWidth:2, tension:0.25 },
          { label:'Chamadas', data:calls, borderWidth:2, tension:0.25 },
          { label:'Cadastros', data:signups, borderWidth:2, tension:0.25 }
        ]
      };
      const lineOpts = {
        ...baseOpts,
        scales: {
          x: { grid:{ display:false } },
          y: { beginAtZero:true, grid:{ color:'#eef2f7' } }
        }
      };
      if (lineChart) { lineChart.data = lineData; lineChart.update(); }
      else { lineChart = new Chart(cLines.getContext('2d'), { type:'line', data:lineData, options:lineOpts }); }

      // ---- Pie (doughnut)
      const pieData = {
        labels:['Verificados','Não verificados'],
        datasets:[{ data:[vYes, vNo] }]
      };
      const pieOpts = {
        ...baseOpts,
        plugins:{ legend:{ position:'bottom' } },
        cutout: '58%'
      };
      if (pieChart) { pieChart.data = pieData; pieChart.update(); }
      else { pieChart = new Chart(cPie.getContext('2d'), { type:'doughnut', data:pieData, options:pieOpts }); }

      // ---- Bars
      const barData = {
        labels: barLabels,
        datasets: [{ label:'Profissionais', data: barValues, borderWidth:1 }]
      };
      const barOpts = {
        ...baseOpts,
        scales: {
          x: { grid:{ display:false } },
          y: { beginAtZero:true, grid:{ color:'#eef2f7' } }
        }
      };
      if (barChart) { barChart.data = barData; barChart.update(); }
      else { barChart = new Chart(cBars.getContext('2d'), { type:'bar', data:barData, options:barOpts }); }
    }

    async function loadMetrics(){
      try{
        const m = await apiJSON('/api/admin/metrics');
        metricsCache = m;
        kAtivos.textContent = String(m.ativos||0);
        kSusp.textContent   = String(m.suspensos||0);
        kExc.textContent    = String(m.excluidos||0);
        kVis.textContent    = String(m.visitas||0);
        kCalls.textContent  = String(m.chamadas||0);
        kAvg.textContent    = m.mediaGeral ? Number(m.mediaGeral).toFixed(2) : '—';
        buildOrUpdateCharts(m);
        errMet.style.display='none';
      }catch(e){
        errMet.style.display='';
      }
    }

    btnRecompute.addEventListener('click', async ()=>{
      btnRecompute.disabled = true;
      try{
        const r = await postJSON('/api/admin/recompute', {});
        alert('Recalcular verificações: '+ (r.changed||0)+' alterados.');
        loadMetrics();
      }catch{ alert('Falha ao recalcular.'); }
      finally{ btnRecompute.disabled=false; }
    });

    // ====== Lista de profissionais ======
    async function loadCidades(){
      try{
        const list = await apiJSON('/api/geo/cidades');
        dlCidades.innerHTML = (list||[]).map(c=>`<option value="${escapeHtml(c)}">`).join('');
      }catch{}
    }
    function updateCSVLink(){
      const qs = new URLSearchParams({
        q: f_q.value.trim(),
        cidade: f_cidade.value.trim(),
        servico: f_serv.value.trim(),
        verificado: f_verif.value,
        status: f_status.value,
        sort: f_sort.value,
        dir: f_dir.value
      });
      btnCSV.href = '/api/admin/export/csv?'+qs.toString();
    }
    [f_q,f_cidade,f_serv,f_verif,f_status,f_sort,f_dir].forEach(el=>{
      el.addEventListener('change', updateCSVLink);
      el.addEventListener('input', updateCSVLink);
    });

    async function loadList(page=1){
      PAGE = page;
      const qs = new URLSearchParams({
        q: f_q.value.trim(),
        cidade: f_cidade.value.trim(),
        servico: f_serv.value.trim(),
        verificado: f_verif.value,
        status: f_status.value,
        sort: f_sort.value,
        dir: f_dir.value,
        page: String(PAGE),
        limit: "20"
      });
      try{
        const data = await apiJSON('/api/admin/profissionais?'+qs.toString());
        renderList(data);
        $('errList').style.display='none';
      }catch{
        $('errList').style.display='';
      }
      updateCSVLink();
    }

    function renderList(data){
      const items = data.items||[];
      tbody.innerHTML = items.map(p=>{
        const foto = p.foto || 'https://via.placeholder.com/100?text=Foto';
        const svc = (p.servico||p.profissao||'');
        const ver = p.verificado ? '✅' : '—';
        const ratingStr = (p.rating!=null) ? Number(p.rating).toFixed(2) : '—';
        const ratingClass = (p.rating!=null && Number(p.rating)<3) ? 'rating-low' : '';
        const statusChip = p.excluido ? '<span class="status-pill">Excluído</span>'
                          : (p.suspenso ? '<span class="status-pill" style="border-color:#fde68a;background:#fef3c7;color:#92400e">Suspenso</span>' : '');
        const plano = String(p.plano||'free').toLowerCase();
        const badgePlano = plano==='premium' ? '<span class="plan-badge PREMIUM">PREMIUM</span>'
                          : (plano==='pro' ? '<span class="plan-badge PRO">PRO</span>' : '');
        return `<tr>
          <td>${p.id}</td>
          <td>
            <div class="namecell">
              <img class="avatar" src="${foto}" alt="Foto de ${escapeHtml(p.nome)}" onerror="this.style.display='none'">
              <div>
                <div style="font-weight:600">${escapeHtml(p.nome)} ${badgePlano}</div>
                ${statusChip}
              </div>
            </div>
          </td>
          <td>${escapeHtml(p.cidade||'')}</td>
          <td>${escapeHtml(p.bairro||'')}</td>
          <td>${escapeHtml(svc)}</td>
          <td>${ver}</td>
          <td class="${ratingClass}">${ratingStr}</td>
          <td>${p.avalCount||0}</td>
          <td>${p.visitas||0}</td>
          <td>${p.chamadas||0}</td>
          <td class="row">
            ${p.excluido ? `
              <button class="btn outline" data-act="restaurar" data-id="${p.id}">Restaurar</button>
            ` : `
              ${p.suspenso ? `<button class="btn outline" data-act="ativar" data-id="${p.id}">Ativar</button>`
                            : `<button class="btn outline" data-act="suspender" data-id="${p.id}">Suspender</button>`}
              <button class="btn ghost" data-act="excluir" data-id="${p.id}">Excluir</button>
            `}
            <a class="btn" href="/profissional/${p.id}" target="_blank" rel="noopener">Abrir</a>
          </td>
        </tr>`;
      }).join('');
      listInfo.textContent = `Total: ${data.total} • Página ${data.page}/${data.pages}`;
      PAGES = data.pages;
      pageInfo.textContent = `${data.page}/${data.pages}`;

      tbody.querySelectorAll('button[data-act]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id = btn.getAttribute('data-id');
          const act = btn.getAttribute('data-act');
          try{
            if (act==='suspender'){
              const motivo = prompt('Motivo da suspensão (opcional):','');
              await postJSON(`/api/admin/profissionais/${id}/suspender`, { motivo });
            } else if (act==='ativar'){
              await postJSON(`/api/admin/profissionais/${id}/ativar`, {});
            } else if (act==='excluir'){
              if (!confirm('Tem certeza que deseja excluir?')) return;
              const r = await fetch(`/api/admin/profissionais/${id}`, { method:'DELETE' });
              if(!r.ok) throw new Error('HTTP '+r.status);
            } else if (act==='restaurar'){
              await postJSON(`/api/admin/profissionais/${id}/restaurar`, {});
            }
          }catch(_){ alert('Ação não concluída.'); }
          loadList(PAGE);
        });
      });
    }
    prev.addEventListener('click', ()=>{ if (PAGE>1) loadList(PAGE-1); });
    next.addEventListener('click', ()=>{ if (PAGE<PAGES) loadList(PAGE+1); });
    f_go.addEventListener('click', ()=> loadList(1));

    // ===== Denúncias (admin) =====
    async function loadDenuncias(page=1){
      D_PAGE = page;
      const qs = new URLSearchParams({
        status: d_status.value,
        q: d_q.value.trim(),
        page: String(D_PAGE),
        limit: "20"
      });
      try{
        const data = await apiJSON('/api/admin/denuncias?'+qs.toString());
        renderDenuncias(data);
        errDen.style.display='none';
      }catch{
        errDen.style.display='';
      }
    }
    function renderDenuncias(data){
      const items = data.items||[];
      tbodyDen.innerHTML = items.map(d=>{
        const when = (d.createdAt||'').replace('T',' ').slice(0,16);
        const prof = d.profissional || {};
        const status = String(d.status||'aberta');
        const chip = `<span class="chip ${status}">${escapeHtml(status.replace('_',' '))}</span>`;
        const profIdText = (prof.id!=null) ? ('#'+ String(prof.id)) : '';
        return `<tr>
          <td>${d.id}</td>
          <td><span class="meta">${escapeHtml(when)}</span></td>
          <td>
            <div>${profIdText} ${prof.nome ? escapeHtml(prof.nome) : ''}</div>
            <div class="meta">${escapeHtml(prof.cidade||'')} • ${escapeHtml(prof.bairro||'')}</div>
          </td>
          <td>${escapeHtml(d.motivo||'—')}</td>
          <td>${chip}</td>
          <td class="den-actions row">
            <button class="btn outline" data-s="em_analise" data-id="${d.id}">Em análise</button>
            <button class="btn outline" data-s="resolvida" data-id="${d.id}">Resolvida</button>
            <button class="btn ghost" data-s="descartada" data-id="${d.id}">Descartar</button>
          </td>
        </tr>`;
      }).join('');
      denInfo.textContent = `Total: ${data.total} • Página ${data.page}/${data.pages}`;
      D_PAGES = data.pages;
      d_pageInfo.textContent = `${data.page}/${data.pages}`;

      tbodyDen.querySelectorAll('button[data-s]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id = btn.getAttribute('data-id');
          const status = btn.getAttribute('data-s');
          try{
            await postJSON(`/api/admin/denuncias/${id}/status`, { status });
          }catch(_){ alert('Falha ao atualizar status.'); }
          loadDenuncias(D_PAGE);
        });
      });
    }
    d_prev.addEventListener('click', ()=>{ if (D_PAGE>1) loadDenuncias(D_PAGE-1); });
    d_next.addEventListener('click', ()=>{ if (D_PAGE<D_PAGES) loadDenuncias(D_PAGE+1); });
    d_go.addEventListener('click', ()=> loadDenuncias(1));

    // ===== Pagamentos (últimos) =====
    function moneyBR(v){
      const n = Number(v||0);
      return n.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    function renderPayment(p){
      const id   = escapeHtml(String(p.id||p.pid||'—')); // aceita id ou pid
      const pro  = escapeHtml(String(p.proId||'—'));
      const meth = escapeHtml(String(p.method||'').toUpperCase());   // PIX|CARD
      const st   = escapeHtml(String(p.status||'—'));                // paid|pending|...
      const gross= moneyBR(p.amount);
      const fees = moneyBR(p.fees || p.appFee || 0);
      const net  = moneyBR(p.net || p.toPro || 0);
      const when = (p.createdAt||'').replace('T',' ').slice(0,19).replace(/-/g,'/');
      return `
        <div class="kpi" style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start">
          <div>
            <div><strong>Pagamento #${id}</strong> — Pro #${pro}</div>
            <div class="meta">Data: ${escapeHtml(when)}</div>
            <div class="row" style="margin-top:6px">
              <span class="badge">Método <strong>${meth}</strong></span>
              <span class="badge">Status <strong>${st}</strong></span>
            </div>
          </div>
          <div style="text-align:right">
            <div>Bruto: R$ ${gross}</div>
            <div>Taxas: R$ ${fees}</div>
            <div><strong>Líquido: R$ ${net}</strong></div>
          </div>
        </div>
      `;
    }
    async function loadPayments(){
      try{
        const arr = await apiJSON('/api/admin/payments?limit=10');
        $('pay_list').innerHTML = (arr||[]).map(renderPayment).join('') || '<div class="meta">Nenhum pagamento ainda.</div>';
      }catch(e){
        $('pay_list').innerHTML = '<div class="warn">Falha ao carregar pagamentos.</div>';
      }
    }
    $('pay_reload').addEventListener('click', loadPayments);

    // Boot
    (async function init(){
      await loadMetrics();
      await loadCidades();
      updateCSVLink();
      await loadList(1);
      await loadDenuncias(1);
      await loadPayments();
      // Re-render charts ao redimensionar
      window.addEventListener('resize', ()=> {
        if (metricsCache) buildOrUpdateCharts(metricsCache);
      });
    })();
  })();
  </script>
</body>
</html>