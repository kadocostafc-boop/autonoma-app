<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin — Autônoma</title>

  <link rel="stylesheet" href="/public.css.global.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>

<header>
  <div class="container header-content">
    <span class="logo">Autônoma — Admin</span>
    <a href="/" class="btn btn-outline">Sair</a>
  </div>
</header>

<section class="container">
  <h1>Painel Administrativo</h1>

  <!-- MÉTRICAS -->
  <div class="grid grid-4" style="margin-top:1.5rem">

    <div class="card">
      <h3>Profissionais</h3>
      <p id="totalProfissionais">—</p>
    </div>

    <div class="card">
      <h3>Clientes</h3>
      <p id="totalClientes">—</p>
    </div>

    <div class="card">
      <h3>Avaliações</h3>
      <p id="totalAvaliacoes">—</p>
    </div>

    <div class="card">
      <h3>Denúncias</h3>
      <p id="totalDenuncias">—</p>
    </div>

  </div>

  <!-- FILTROS -->
  <div class="card" style="margin-top:2rem">
    <h3>Filtrar Profissionais</h3>

    <select id="estadoFiltro"></select>
    <select id="cidadeFiltro"></select>
    <select id="statusFiltro">
      <option value="">Todos</option>
      <option value="ATIVO">Ativos</option>
      <option value="SUSPENSO">Suspensos</option>
    </select>

    <button class="btn btn-primary btn-sm" onclick="carregarProfissionais()">Filtrar</button>
  </div>

  <!-- LISTA PROFISSIONAIS -->
  <div class="card" style="margin-top:2rem">
    <h3>Profissionais</h3>
    <table>
      <thead>
        <tr>
          <th>Nome</th>
          <th>Cidade</th>
          <th>Plano</th>
          <th>Avaliação</th>
          <th>Status</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="listaProfissionais"></tbody>
    </table>
  </div>

</section>

<footer>
  © 2026 Autônoma.app
</footer>

<script>
  async function carregarDashboard() {
    const res = await fetch('/api/admin/dashboard')
    const data = await res.json()

    if (!data.ok) {
      alert('Acesso negado')
      location.href = '/'
      return
    }

    document.getElementById('totalProfissionais').innerText = data.totalProfissionais
    document.getElementById('totalClientes').innerText = data.totalClientes
    document.getElementById('totalAvaliacoes').innerText = data.totalAvaliacoes
    document.getElementById('totalDenuncias').innerText = data.totalDenuncias

    carregarEstados()
    carregarProfissionais()
  }

  async function carregarEstados() {
    const res = await fetch('/api/geo/estados')
    const data = await res.json()

    const select = document.getElementById('estadoFiltro')
    select.innerHTML = '<option value="">Estado</option>'

    data.estados.forEach(e => {
      const opt = document.createElement('option')
      opt.value = e
      opt.textContent = e
      select.appendChild(opt)
    })
  }

  async function carregarProfissionais() {
    const estado = estadoFiltro.value
    const cidade = cidadeFiltro.value
    const status = statusFiltro.value

    const res = await fetch(`/api/admin/profissionais?estado=${estado}&cidade=${cidade}&status=${status}`)
    const data = await res.json()

    const tbody = document.getElementById('listaProfissionais')
    tbody.innerHTML = ''

    data.profissionais.forEach(p => {
      const tr = document.createElement('tr')
      tr.innerHTML = `
        <td>${p.nome}</td>
        <td>${p.cidade}</td>
        <td>${p.plano}</td>
        <td>${p.avaliacao}</td>
        <td>${p.ativo ? 'Ativo' : 'Suspenso'}</td>
        <td>
          <button onclick="toggleStatus('${p.id}')" class="btn btn-sm">${p.ativo ? 'Suspender' : 'Ativar'}</button>
          <button onclick="verPerfil('${p.id}')" class="btn btn-sm btn-outline">Perfil</button>
        </td>
      `
      tbody.appendChild(tr)
    })
  }

  async function toggleStatus(id) {
    if (!confirm('Confirmar ação?')) return
    await fetch(`/api/admin/profissional/${id}/status`, { method:'POST' })
    carregarProfissionais()
  }

  function verPerfil(id) {
    window.open(`/perfil.html?id=${id}`, '_blank')
  }

  carregarDashboard()
</script>

</body>
</html>