<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Avaliar Profissional ‚Ä¢ Aut√¥noma.app</title>
  <meta name="theme-color" content="#2563eb">
  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <link rel="icon" href="/favicon.ico">
  <link rel="stylesheet" href="/css/app.css?v=avaliar-2025-09-08b">
  <style>
    /* Herdando o visual padr√£o das p√°ginas (cards, bot√µes, etc.) */
    .wrap{max-width:1120px;margin:0 auto;padding:16px}
    .header{display:flex;align-items:center;gap:12px;padding:12px 16px;background:#0b1f63}
    .header .logo{height:32px;width:auto;display:block;filter:brightness(1.05)}
    .topbar-links{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
    .btn{border:none;background:#2563eb;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:8px;font-weight:800}
    .btn.ghost{background:#f1f5f9;color:#111827}
    .btn.outline{background:#fff;color:#0f172a;border:1px solid #e5e7eb}
    .btn-wa{background:#16a34a}
    .btn:hover{filter:brightness(.98)}
    .card-soft{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:14px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:920px){ .grid{grid-template-columns:1fr 1fr} }
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .meta{color:#64748b}
    /* Header do profissional */
    .pro-head{display:flex;align-items:center;gap:10px}
    .avatar{width:54px;height:54px;border-radius:999px;object-fit:cover;border:1px solid #e5e7eb;background:#fff}
    .h-title{margin:0;font-size:18px;font-weight:800}
    .h-meta{margin:0;color:#64748b;font-size:13px}
    /* Form */
    label{font-weight:700;display:block;margin:10px 0 6px}
    .input, select, textarea{width:100%;padding:10px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;font-size:15px}
    textarea{resize:vertical;min-height:90px}
    .msg{font-size:14px}
    .msg.ok{color:#166534}
    .msg.err{color:#b91c1c}
    /* Lista de coment√°rios */
    .list{display:grid;grid-template-columns:1fr;gap:8px}
    @media(min-width:720px){ .list{grid-template-columns:1fr 1fr} }
    .item{padding:10px;border:1px solid #e5e7eb;border-radius:12px;background:#f8fafc}
    .rating{color:#f59e0b}
    footer { padding:28px 12px; background:#0b1f63; margin-top:16px }
    .foot-links { display:flex; flex-wrap:wrap; gap:12px; justify-content:center; }
    .foot-links a { color:#cde1ff; font-size:14px; text-decoration:none; }
    .foot-links a:hover { text-decoration:underline; }
  </style>
</head>
<body>
  <!-- Topbar igual √†s outras p√°ginas -->
  <header class="header" role="banner">
    <a href="/" aria-label="In√≠cio">
      <img class="logo" src="/img/logo.png" alt="Aut√¥noma.app" onerror="this.style.display='none'">
    </a>
    <nav class="topbar-links" aria-label="Navega√ß√£o">
      <a class="btn ghost" href="/">In√≠cio</a>
      <a class="btn ghost" href="/clientes.html">Buscar</a>
      <a class="btn ghost" href="/top10.html">üèÜ Top 10</a>
      <a class="btn outline" href="/painel_login.html">Entrar</a>
    </nav>
  </header>

  <main class="wrap">
    <div class="grid">
      <!-- Coluna esquerda: formul√°rio -->
      <section class="card-soft">
        <div class="pro-head">
          <img id="foto" class="avatar" src="/icons/icon-192.png" alt="Foto do profissional">
          <div>
            <p id="nome" class="h-title">Profissional</p>
            <p id="meta" class="h-meta">‚Äî</p>
          </div>
          <div class="row" style="margin-left:auto">
            <a id="btnWA" class="btn btn-wa" target="_blank" rel="noopener">WhatsApp</a>
            <a id="backPerfil" class="btn outline" href="/clientes.html">Voltar ao perfil</a>
          </div>
        </div>

        <h1 style="font-size:20px;margin:12px 0 6px">Avaliar Profissional</h1>
        <p class="meta">D√™ uma nota de 1 a 5 e, se quiser, escreva um coment√°rio.</p>

        <form id="f" autocomplete="on" novalidate>
          <label for="nomeCli">Seu nome <span class="meta">(opcional)</span></label>
          <input id="nomeCli" name="nome" class="input" placeholder="Digite seu nome">

          <label for="notaSel">Nota</label>
          <select id="notaSel" class="input">
            <option value="0" selected>Selecione‚Ä¶</option>
            <option value="5">5 - Excelente</option>
            <option value="4">4 - Muito bom</option>
            <option value="3">3 - Bom</option>
            <option value="2">2 - Regular</option>
            <option value="1">1 - Ruim</option>
          </select>

          <label for="coment">Coment√°rio</label>
          <textarea id="coment" name="comentario" class="input" placeholder="Conte como foi sua experi√™ncia"></textarea>

          <div class="row" style="margin-top:10px">
            <button id="send" class="btn" type="submit">Enviar avalia√ß√£o</button>
            <a id="voltarPerfil2" class="btn outline" href="#">Voltar ao perfil</a>
          </div>
          <p id="status" class="msg" aria-live="polite"></p>
        </form>
      </section>

      <!-- Coluna direita: coment√°rios -->
      <aside class="card-soft">
        <h2 style="margin:0 0 8px">Coment√°rios recentes</h2>
        <div id="reviews" class="list"></div>
        <p id="noReviews" class="meta" style="display:none">Ainda n√£o h√° coment√°rios.</p>
      </aside>
    </div>
  </main>

  <footer>
    <nav class="foot-links" aria-label="Links do rodap√©">
      <a href="/termos.html">Termos</a>
      <a href="/privacidade.html">Privacidade</a>
      <a href="/top10.html">Top 10</a>
      <a href="/planos.html">Planos</a>
      <a href="/politica-de-seguranca.html">Seguran√ßa</a>
      <a href="/favoritos.html">Favoritos</a>
    </nav>
  </footer>

  <script>
  (function(){
    // ===== Utils =====
    const $ = s => document.querySelector(s);
    const esc = s => String(s||"").replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]));
    const stars = n => { const r=Math.round((Number(n)||0)*2)/2; const f=Math.floor(r),h=(r%1!==0); return "‚òÖ".repeat(f)+(h?"¬Ω":"")+"‚òÜ".repeat(5-f-(h?1:0)); };

    function getId(){
      const url = new URL(location.href);
      const qid = url.searchParams.get('id');
      if (qid) return qid;
      const parts = location.pathname.split('/').filter(Boolean);
      const i = parts.indexOf('avaliar');
      if (i>=0 && parts[i+1]) return parts[i+1];
      return '';
    }
    const PRO_ID = getId();
    if(!PRO_ID){ location.href='/clientes.html'; return; }

    async function getJSON(u){
      const r = await fetch(u,{cache:'no-store'});
      if(!r.ok) throw new Error('http '+r.status);
      return r.json();
    }

    function waLink(p){
      if(!p || !p.whatsapp) return null;
      const d = String(p.whatsapp).replace(/\D/g,'');
      const num = d.startsWith('55') ? d : ('55'+d);
      const partes = ['Ol√°, vi seu perfil no Aut√¥noma.app'];
      const svc = p.servico || p.profissao;
      partes.push(svc ? 'e gostaria de contratar seus servi√ßos de '+svc : 'e gostaria de contratar seus servi√ßos');
      if (p.cidade) partes.push('em '+p.cidade);
      const msg = partes.join(' ') + '. Podemos conversar?';
      return `https://wa.me/${num}?text=${encodeURIComponent(msg)}`;
    }

    async function loadPro(pid){
      const tries = [
        `/api/profissional/${encodeURIComponent(pid)}`,
        `/api/public/profissional?id=${encodeURIComponent(pid)}`,
        `/api/profissionais?id=${encodeURIComponent(pid)}`
      ];
      for (const u of tries){
        try{
          const js = await getJSON(u);
          if(js?.item) return js.item;
          if(js && (js.id!=null || js.nome)) return js;
        }catch(_){}
      }
      throw new Error('notfound');
    }

    async function fetchReviews(pid){
      const tries = [
        `/api/profissional/${encodeURIComponent(pid)}/avaliacoes`,
        `/api/avaliacoes?proId=${encodeURIComponent(pid)}`,
        `/api/public/avaliacoes?proId=${encodeURIComponent(pid)}`
      ];
      for (const u of tries){
        try{
          const js = await getJSON(u);
          if (Array.isArray(js)) return js;
          if (Array.isArray(js?.items)) return js.items;
          if (Array.isArray(js?.avaliacoes)) return js.avaliacoes;
        }catch(_){}
      }
      return [];
    }

    function normalizeAval(a){
      const nome = a.autor || a.nome || a.cliente || a.user || 'Cliente';
      const nota = a.nota ?? a.rating ?? a.estrelas ?? a.score ?? 0;
      const texto = a.texto || a.comentario || a.comment || a.mensagem || '';
      const when  = a.createdAt || a.data || '';
      return { nome:String(nome), nota:Number(nota), texto:String(texto), when:String(when) };
    }

    function renderReviews(list){
      const box = $('#reviews'), empty = $('#noReviews');
      if(!list.length){ box.innerHTML=''; empty.style.display=''; return; }
      empty.style.display='none';
      box.innerHTML = list.slice(0,10).map(x=>{
        const a = normalizeAval(x);
        return `
          <div class="item">
            <div class="row" style="justify-content:space-between">
              <strong>${esc(a.nome)}</strong>
              <span class="rating">${stars(a.nota)}</span>
            </div>
            ${a.texto?`<p class="meta" style="margin:6px 0 0">${esc(a.texto)}</p>`:''}
          </div>
        `;
      }).join('');
    }

    // ===== Envio =====
    const f = $('#f'), status = $('#status'), sendBtn = $('#send');
    function setStatus(msg, ok){ status.textContent = msg||''; status.className='msg'+(ok===true?' ok':ok===false?' err':''); }

    f.addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      const nome = String($('#nomeCli').value||'').trim();
      const nota = Number($('#notaSel').value||0);
      const comentario = String($('#coment').value||'').trim();

      if (nota<1 || nota>5){ setStatus('Selecione uma nota de 1 a 5.', false); return; }

      sendBtn.disabled = true; setStatus('Enviando...', null);
      try{
        const r = await fetch(`/api/profissional/${encodeURIComponent(PRO_ID)}/avaliar`,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ nome, nota, comentario })
        });
        if(!r.ok) throw new Error('http '+r.status);
        setStatus('‚úÖ Obrigado pela sua avalia√ß√£o!', true);
        f.reset();
        // recarrega coment√°rios
        try{ const arr = await fetchReviews(PRO_ID); renderReviews(arr); }catch(_){}
      }catch(e){
        setStatus('‚ùå Erro ao enviar. Tente novamente.', false);
      }finally{
        sendBtn.disabled = false;
      }
    });

    // ===== Boot =====
    (async function init(){
      // perfil
      try{
        const p = await loadPro(PRO_ID);
        $('#foto').src = p.foto || '/icons/icon-192.png';
        $('#nome').textContent = p.nome || 'Profissional';
        $('#meta').textContent = [p.servico || p.profissao, [p.bairro, p.cidade].filter(Boolean).join(' ‚Ä¢ ')].filter(Boolean).join(' ‚Ä¢ ') || '‚Äî';
        const perfilUrl = '/profissional/' + encodeURIComponent(PRO_ID);
        $('#backPerfil').href = perfilUrl;
        $('#voltarPerfil2').href = perfilUrl;
        const wa = waLink(p);
        const waBtn = $('#btnWA');
        if (wa){ waBtn.href = wa; } else { waBtn.classList.add('outline'); waBtn.textContent='WhatsApp indispon√≠vel'; waBtn.removeAttribute('href'); }
      }catch(_){}

      // coment√°rios
      try{
        const arr = await fetchReviews(PRO_ID);
        renderReviews(arr);
      }catch(_){}
    })();
  })();
  </script>
</body>
</html>