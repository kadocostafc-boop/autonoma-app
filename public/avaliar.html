<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Avaliar • Autônoma.app</title>
  <link rel="stylesheet" href="/css/app.css" />
  <link rel="icon" href="/img/icon-192.png">
  <meta name="theme-color" content="#0b2a6f" />
  <style>
    /* Ajustes suaves usando a mesma base visual do admin */
    .page { min-height: 100dvh; display: grid; place-items: start center; padding: 24px; background: var(--bg, #0b1f55); }
    .card-wrap { width: 100%; max-width: 680px; }
    .pro-head { display: grid; grid-template-columns: 64px 1fr; gap: 12px; align-items: center; }
    .pro-head img { width: 64px; height: 64px; object-fit: cover; border-radius: 12px; border: 2px solid rgba(255,255,255,.15); background:#fff; }
    .muted { color: #7e8aa6; font-size: .92rem; }
    .list { list-style: none; padding: 0; margin: 0; display: grid; gap: 12px; }
    .list li { background: #0e2a66; border: 1px solid rgba(255,255,255,.08); border-radius: 14px; padding: 12px; }
    .stars { color: #ffc83d; letter-spacing: .5px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    @media (max-width: 480px){
      .pro-head { grid-template-columns: 56px 1fr; }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="card card-wrap">
      <div class="pro-head" id="pro-head">
        <img id="pro-foto" alt="Foto" src="/img/placeholder-user.png" />
        <div>
          <h1 id="title" style="margin:0">Avaliar profissional</h1>
          <div class="muted" id="pro-sub">Carregando…</div>
        </div>
      </div>

      <form id="form-av" style="margin-top:16px">
        <label for="autor">Seu nome (opcional)</label>
        <input id="autor" name="autor" placeholder="Ex.: João Silva" />

        <label for="nota" style="margin-top:8px">Nota</label>
        <select id="nota" name="nota" required>
          <option value="5">5 - Excelente</option>
          <option value="4">4 - Muito bom</option>
          <option value="3">3 - Bom</option>
          <option value="2">2 - Regular</option>
          <option value="1">1 - Ruim</option>
        </select>

        <label for="comentario" style="margin-top:8px">Comentário</label>
        <textarea id="comentario" name="comentario" required minlength="5" rows="4" placeholder="Conte rapidamente como foi a sua experiência"></textarea>

        <div class="row" style="margin-top:12px">
          <button class="btn" type="submit" id="btn-send">Enviar avaliação</button>
          <a id="btn-perfil" class="btn ghost" href="/clientes.html">Voltar</a>
        </div>
      </form>
    </div>

    <div class="card card-wrap" style="margin-top:16px">
      <h2 style="margin-top:0">Comentários recentes</h2>
      <ul class="list" id="list-avs">
        <li class="muted">Carregando…</li>
      </ul>
      <div class="row" style="margin-top:10px">
        <a class="btn ghost" id="btn-ver-perfil" href="#">Ver perfil completo</a>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const $ = (sel) => document.querySelector(sel);
      const qs = new URLSearchParams(location.search);
      // Suporta /avaliar.html?id=123 ou rota bonitinha /avaliar/123
      let id = Number(qs.get("id") || "");
      if (!id) {
        const m = location.pathname.match(/\/avaliar\/(\d+)/);
        if (m) id = Number(m[1]);
      }
      if (!id) {
        $("#title").textContent = "Avaliar profissional";
        $("#pro-sub").textContent = "ID do profissional não informado.";
        $("#form-av").style.display = "none";
        return;
      }

      const perfilUrl = `/perfil.html?id=${id}`;
      $("#btn-perfil").href = perfilUrl;
      $("#btn-ver-perfil").href = perfilUrl;

      // Carrega dados do profissional
      fetch(`/api/profissional/${id}`)
        .then(r => r.ok ? r.json() : Promise.reject())
        .then(json => {
          if (!json || !json.ok) throw new Error("notfound");
          const p = json;
          $("#title").textContent = `Avaliar ${p.nome}`;
          $("#pro-sub").textContent = [p.servico || "", p.cidade ? `• ${p.cidade}` : ""].filter(Boolean).join(" ");
          if (p.foto) $("#pro-foto").src = p.foto;
        })
        .catch(() => {
          $("#pro-sub").textContent = "Profissional não encontrado.";
        });

      // Carrega comentários recentes
      function stars(n){ n = Math.max(1, Math.min(5, Number(n)||0)); return "★".repeat(n)+"☆".repeat(5-n); }
      function loadAvs(){
        fetch(`/api/avaliacoes/${id}?page=1&limit=20`)
          .then(r => r.ok ? r.json() : Promise.reject())
          .then(({ok, items}) => {
            const ul = $("#list-avs");
            if (!ok || !items || !items.length) {
              ul.innerHTML = `<li class="muted">Sem comentários ainda.</li>`;
              return;
            }
            ul.innerHTML = items.slice().reverse().map(a => {
              const dt = a.at ? new Date(a.at).toLocaleString() : "";
              const nome = (a.autor || "Cliente").toString().replace(/[<>&"]/g,"");
              const com  = (a.comentario || "").toString().replace(/[<>&"]/g,"");
              const st = stars(a.nota);
              return `<li>
                <div class="row" style="justify-content:space-between">
                  <b>${nome}</b>
                  <span class="stars">${st}</span>
                </div>
                <div class="muted" style="margin-top:2px">${dt}</div>
                <div style="margin-top:6px">${com}</div>
              </li>`;
            }).join("");
          })
          .catch(() => {
            $("#list-avs").innerHTML = `<li class="muted">Não foi possível carregar os comentários.</li>`;
          });
      }
      loadAvs();

      // Envio do formulário (POST compat do servidor)
      $("#form-av").addEventListener("submit", async (ev) => {
        ev.preventDefault();
        const btn = $("#btn-send");
        btn.disabled = true; btn.textContent = "Enviando…";
        try {
          const form = new URLSearchParams();
          form.set("autor", $("#autor").value.trim());
          form.set("nota", $("#nota").value);
          form.set("comentario", $("#comentario").value.trim());

          const resp = await fetch(`/profissional/${id}/avaliar`, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: form.toString()
          });

          if (resp.ok) {
            // redireciona para o perfil com flag de sucesso
            location.href = `/perfil.html?id=${id}&ok=1`;
            return;
          } else {
            const txt = await resp.text();
            alert("Não foi possível enviar sua avaliação.\n\n" + (txt || ""));
          }
        } catch (e) {
          alert("Erro de rede. Tente novamente.");
        } finally {
          btn.disabled = false; btn.textContent = "Enviar avaliação";
        }
      });
    })();
  </script>
</body>
</html>