<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Cadastro de Profissional | Autônoma</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="/css/global.css" />

  <style>
    .container {
      max-width: 420px;
      margin: 40px auto;
      padding: 20px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    }
    h1 { text-align: center; margin-bottom: 20px; }
    label { display:block; margin-top:12px; font-weight:600; }
    input, button {
      width:100%; padding:10px; margin-top:6px;
      border-radius:6px; border:1px solid #ddd;
    }
    button { background:#111; color:#fff; margin-top:20px; cursor:pointer; }
    .foto-preview img {
      width:120px; height:120px; border-radius:50%;
      object-fit:cover; display:none; margin:auto;
    }
    .autocomplete-list {
      border:1px solid #ddd; border-radius:6px;
      max-height:160px; overflow-y:auto;
    }
    .autocomplete-item {
      padding:8px; cursor:pointer;
    }
    .autocomplete-item:hover { background:#f2f2f2; }
    .tags { display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; }
    .tag {
      background:#111; color:#fff;
      padding:4px 8px; border-radius:12px;
      font-size:13px; cursor:pointer;
    }
  </style>
</head>

<body>

<div class="container">
  <h1>Cadastro Profissional</h1>

  <form id="formCadastro">

    <label>Nome</label>
    <input name="nome" required>

    <label>Email</label>
    <input name="email" type="email" required>

    <label>WhatsApp</label>
    <input name="whatsapp" required>

    <label>Senha</label>
    <input name="senha" type="password" required>

    <label>Serviços</label>
    <input id="servicoInput" placeholder="Digite e pressione Enter">
    <div id="servicoList" class="autocomplete-list" style="display:none"></div>
    <div class="tags" id="servicoTags"></div>

    <input type="hidden" name="servicos" id="servicosHidden">

    <label>Cidade</label>
    <input name="cidade" id="cidade" required>

    <label>Estado</label>
    <input name="estado" id="estado" required>

    <label>Bairro</label>
    <input name="bairro" id="bairro">

    <label>Foto</label>
    <input type="file" name="foto" id="fotoInput" accept="image/*">
    <div class="foto-preview">
      <img id="fotoPreview">
    </div>

    <button>Cadastrar</button>
  </form>
</div>

<script>
/* ===============================
   PREVIEW FOTO
================================ */
fotoInput.onchange = () => {
  fotoPreview.src = URL.createObjectURL(fotoInput.files[0])
  fotoPreview.style.display = 'block'
}

/* ===============================
   GEOLOCALIZAÇÃO
================================ */
navigator.geolocation?.getCurrentPosition(async pos => {
  const res = await fetch(
    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}`
  )
  const d = await res.json()
  cidade.value = d.address.city || d.address.town || ''
  estado.value = d.address.state || ''
})

/* ===============================
   SERVIÇOS INTELIGENTES
================================ */
const sugestoes = [
  'Eletricista','Encanador','Faxineira','Pedreiro',
  'Pintor','Jardineiro','Montador de móveis',
  'Diarista','Marceneiro','Técnico de informática'
]

const selecionados = new Set()

servicoInput.addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    e.preventDefault()
    adicionarServico(servicoInput.value)
  }
})

function adicionarServico(nome) {
  nome = nome.trim()
  if (!nome || selecionados.has(nome)) return
  selecionados.add(nome)

  const tag = document.createElement('div')
  tag.className = 'tag'
  tag.textContent = nome
  tag.onclick = () => {
    selecionados.delete(nome)
    tag.remove()
    atualizarHidden()
  }

  servicoTags.appendChild(tag)
  servicoInput.value = ''
  atualizarHidden()
}

function atualizarHidden() {
  servicosHidden.value = JSON.stringify([...selecionados])
}

/* ===============================
   SUBMIT
================================ */
formCadastro.onsubmit = async e => {
  e.preventDefault()
  atualizarHidden()

  const formData = new FormData(formCadastro)

  const res = await fetch('/api/auth/register', {
    method:'POST', body:formData
  })
  const data = await res.json()

  if (!data.ok) return alert(data.message)
  alert('Cadastro realizado!')
  location.href = '/painel.html'
}
</script>

</body>
</html>
