<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Cadastro de Profissional • Autônoma.app</title>

  <!-- Canonical + SEO -->
  <link rel="canonical" href="https://autonomaapp.com.br/cadastro.html">
  <meta name="description" content="Cadastre seu perfil no Autônoma: informe seus dados, cidade, bairro e WhatsApp para receber clientes pelo app.">

  <!-- PWA / Favicons -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#2d6cdf">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16.png">

  <!-- CSS global -->
  <link rel="stylesheet" href="/css/app.css?v=cadastro-2025-09-08r">

  <style>
    /* Ajustes locais */
    .header { display:flex; align-items:center; gap:12px; padding:12px 16px }
    .header .logo { height:32px; width:auto; display:block }
    .help { font-size:12px; color:#64748b; margin-top:4px }
    .preview { font-size:12px; color:#334155; margin-top:4px }
    .row-wrap { display:flex; gap:10px; flex-wrap:wrap }
    .field-50 { flex:1 1 220px }
    .avatar-preview{ width:84px;height:84px;object-fit:cover;border-radius:10px;border:1px solid #e5e7eb;background:#f8fafc }
    .doc-preview{ width:120px;height:84px;object-fit:cover;border-radius:10px;border:1px solid #e5e7eb;background:#f8fafc }
    .warn { color:#b91c1c }
    .gps-pill { display:inline-flex; align-items:center; gap:8px; background:#eef2ff; border:1px solid #c7d2fe; color:#0b1f63; padding:6px 10px; border-radius:12px }
    .btn.small { padding:8px 12px; font-size:14px }
    .muted { color:#64748b; font-size:12px }
  </style>
</head>
<body>
<header class="header" role="banner">
  <a href="/" aria-label="Início">
    <img class="logo" src="/img/logo.png" alt="Autônoma.app" onerror="this.style.display='none'">
  </a>
  <div style="margin-left:auto;display:flex;gap:8px">
    <a class="btn ghost" href="/">Início</a>
    <a class="btn outline" href="/clientes.html">Ver profissionais</a>
  </div>
</header>

<main class="wrap" role="main">
  <div class="card">
    <h1 style="margin:0">Cadastre seu perfil</h1>
    <p class="meta">É rápido e gratuito. Você recebe contatos pelo <strong>WhatsApp</strong>.</p>
  </div>

  <div class="card" style="max-width:880px;margin:auto">
    <form id="formCad" action="/cadastrar" method="POST" enctype="multipart/form-data" novalidate>
      <!-- Foto (OBRIGATÓRIA) -->
      <label for="foto">Foto de perfil <strong>(obrigatória)</strong></label>
      <div class="row-wrap" style="align-items:center">
        <img id="fotoPrev" class="avatar-preview" src="/icons/icon-192.png" alt="Prévia da foto">
        <input id="foto" name="foto" type="file" accept="image/*" required aria-required="true">
      </div>
      <p class="help">Formatos: JPG ou PNG, até 3MB. A foto é necessária para dar mais confiança ao cliente.</p>

      <!-- Selo verificado -->
      <div class="row-wrap" style="align-items:flex-start">
        <label class="gps-pill" style="background:#f0fdf4;border-color:#bbf7d0;color:#166534">
          <input id="wantSelo" type="checkbox" style="transform:translateY(1px)">
          Quero selo verificado
        </label>
        <span id="seloHint" class="muted">Para análise do selo, envie um documento com foto (RG, CNH, passaporte).</span>
      </div>

      <div id="docWrap" style="display:none; margin-top:8px">
        <label for="doc">Documento com foto <span class="muted">(obrigatório se quiser o selo)</span></label>
        <div class="row-wrap" style="align-items:center">
          <img id="docPrev" class="doc-preview" src="/img/doc-placeholder.png" alt="Prévia do documento" onerror="this.style.display='none'">
          <input id="doc" name="doc" type="file" accept="image/*,application/pdf">
        </div>
        <p class="help">Foto legível do documento. Aceitamos imagem (JPG/PNG) ou PDF.</p>
      </div>

      <!-- Nome -->
      <label for="nome">Seu nome completo *</label>
      <input id="nome" name="nome" type="text" maxlength="80" required placeholder="Ex.: Ana Souza">

      <!-- GPS / Cidade / Bairro -->
      <div class="row-wrap" style="align-items:center; gap:10px; margin-top:4px">
        <button type="button" id="btnGPS" class="btn small" aria-describedby="gpsStatus">Usar minha localização</button>
        <span id="gpsStatus" class="muted">GPS desativado.</span>
      </div>

      <div class="row-wrap">
        <div class="field-50">
          <label for="cidade">Cidade *</label>
          <input id="cidade" name="cidade" type="text" list="lista-cidades" required placeholder="Ex.: Rio de Janeiro/RJ" autocomplete="off">
          <datalist id="lista-cidades"></datalist>
          <p class="help">Digite e escolha na lista. Aceitamos “Cidade/UF” ou só “Cidade”.</p>
        </div>
        <div class="field-50">
          <label for="bairro">Bairro *</label>
          <input id="bairro" name="bairro" type="text" list="lista-bairros" required placeholder="Ex.: Copacabana" autocomplete="off">
          <datalist id="lista-bairros"></datalist>
          <p class="help">Depois de escolher a cidade, este campo sugere bairros automaticamente.</p>
        </div>
      </div>

      <!-- Serviço / Profissão -->
      <div class="row-wrap">
        <div class="field-50">
          <label for="servico">Categoria/Serviço (recomendado)</label>
          <input id="servico" name="servico" type="text" list="lista-servicos" placeholder="Ex.: Eletricista" autocomplete="off">
          <datalist id="lista-servicos"></datalist>
        </div>
        <div class="field-50">
          <label for="profissao">Profissão (alternativa)</label>
          <input id="profissao" name="profissao" type="text" maxlength="60" placeholder="Ex.: Técnico em elétrica">
        </div>
      </div>
      <p class="help">Preencha pelo menos <strong>Serviço</strong> ou <strong>Profissão</strong>.</p>

      <!-- Contatos -->
      <div class="row-wrap">
        <div class="field-50">
          <label for="whatsapp">WhatsApp (com DDD) *</label>
          <input id="whatsapp" name="whatsapp" type="tel" required inputmode="tel" placeholder="Ex.: (21) 98765-4321">
          <div id="whatsPrev" class="preview"></div>
          <p class="help">Pode colar com espaços/parênteses/traços. Formatamos automaticamente e adicionamos o +55.</p>
        </div>
        <div class="field-50">
          <label for="telefone">Telefone (opcional)</label>
          <input id="telefone" name="telefone" type="tel" inputmode="tel" placeholder="Ex.: (21) 3456-7890">
          <div id="telPrev" class="preview"></div>
        </div>
      </div>

      <!-- E-mail / Site -->
      <div class="row-wrap">
        <div class="field-50">
          <label for="email">E-mail (opcional)</label>
          <input id="email" name="email" type="email" placeholder="Ex.: voce@email.com">
        </div>
        <div class="field-50">
          <label for="site">Site/Catálogo (opcional)</label>
          <input id="site" name="site" type="url" placeholder="Ex.: https://meuportfolio.com">
        </div>
      </div>

      <!-- Endereço / Experiência / Preço -->
      <label for="endereco">Endereço (opcional, oculto no perfil)</label>
      <input id="endereco" name="endereco" type="text" maxlength="120" placeholder="Rua/Av, número, complemento (apenas para referência interna)">

      <div class="row-wrap">
        <div class="field-50">
          <label for="experiencia">Experiência (opcional)</label>
          <input id="experiencia" name="experiencia" type="text" maxlength="80" placeholder="Ex.: 5 anos">
        </div>
        <div class="field-50">
          <label for="precoBase">Preço base (opcional)</label>
          <input id="precoBase" name="precoBase" type="text" maxlength="40" placeholder="Ex.: R$ 100/hora">
        </div>
      </div>

      <!-- Descrição -->
      <label for="descricao">Sobre você *</label>
      <textarea id="descricao" name="descricao" maxlength="600" required placeholder="Descreva seu trabalho, diferenciais e área de atendimento."></textarea>

      <!-- Lat/Lng (ocultos, preenchidos via GPS) -->
      <input type="hidden" id="lat" name="lat">
      <input type="hidden" id="lng" name="lng">

      <div class="row" style="margin-top:12px;gap:8px;flex-wrap:wrap">
        <button class="btn" type="submit">Cadastrar</button>
        <a class="btn ghost" href="/clientes.html">Cancelar</a>
      </div>

      <p id="err" class="meta warn" style="display:none;margin-top:8px"></p>
    </form>
  </div>
</main>

<script>
(function(){
  const $ = (id)=> document.getElementById(id);
  const err = $("err");
  const NO_STORE = { cache:'no-store' };
  const ts = ()=> 'ts='+Date.now();

  // --- Foto preview (OBRIGATÓRIA) ---
  const foto = $("foto"), fotoPrev = $("fotoPrev");
  if (foto){
    foto.addEventListener("change", ()=>{
      const f=foto.files?.[0];
      if(!f){ fotoPrev.src="/icons/icon-192.png"; return; }
      const url=URL.createObjectURL(f);
      fotoPrev.src=url;
    });
  }

  // --- Documento preview (opcional / obrigatório se quiser selo) ---
  const wantSelo = $("wantSelo");
  const docWrap = $("docWrap");
  const doc = $("doc");
  const docPrev = $("docPrev");

  wantSelo.addEventListener("change", ()=>{
    const on = wantSelo.checked;
    docWrap.style.display = on ? "" : "none";
    doc.required = on;
    doc.setAttribute("aria-required", on ? "true" : "false");
  });

  if (doc){
    doc.addEventListener("change", ()=>{
      const f=doc.files?.[0];
      if(!f){ docPrev.style.display="none"; return; }
      // mostra preview apenas se imagem
      if (f.type && f.type.startsWith("image/")){
        docPrev.style.display="";
        const url=URL.createObjectURL(f);
        docPrev.src=url;
      } else {
        docPrev.style.display="none";
      }
    });
  }

  // --- Lists dinâmicas + sugestões ---
  async function fillCities(){
    try{
      const r=await fetch("/api/geo/cidades?"+ts(), NO_STORE);
      if(!r.ok) return;
      const arr=await r.json();
      $("lista-cidades").innerHTML = (arr||[]).map(c=>`<option value="${escapeHtml(c)}">`).join("");
    }catch{}
  }
  async function refreshBairros(){
    const cid = $("cidade").value.trim();
    if(!cid){ $("lista-bairros").innerHTML=""; return; }
    try{
      const r=await fetch("/api/geo/bairros?cidade="+encodeURIComponent(cid)+"&"+ts(), NO_STORE);
      if(!r.ok) return;
      const arr=await r.json();
      $("lista-bairros").innerHTML = (arr||[]).map(b=>`<option value="${escapeHtml(b)}">`).join("");
    }catch{}
  }
  async function suggestBairros(q){
    const cid = $("cidade").value.trim();
    if(!cid || !q) return;
    try{
      const r=await fetch(`/api/geo/bairros/suggest?cidade=${encodeURIComponent(cid)}&q=${encodeURIComponent(q)}&${ts()}`, NO_STORE);
      if(!r.ok) return;
      const arr=await r.json();
      $("lista-bairros").innerHTML = (arr||[]).map(b=>`<option value="${escapeHtml(b)}">`).join("");
    }catch{}
  }
  async function suggestServicos(q){
    if(!q) return;
    try{
      const r=await fetch(`/api/geo/servicos/suggest?q=${encodeURIComponent(q)}&${ts()}`, NO_STORE);
      if(!r.ok) return;
      const arr=await r.json();
      $("lista-servicos").innerHTML = (arr||[]).map(s=>`<option value="${escapeHtml(s)}">`).join("");
    }catch{}
  }
  $("cidade").addEventListener("change", refreshBairros);
  $("bairro").addEventListener("input", e=> suggestBairros(e.target.value.trim()));
  $("servico").addEventListener("input", e=> suggestServicos(e.target.value.trim()));
  fillCities();

  // --- GPS (preenche cidade e lat/lng) ---
  const btnGPS = $("btnGPS");
  const gpsStatus = $("gpsStatus");
  function isSecureForGeo(){
    return location.hostname==='localhost' || location.hostname==='127.0.0.1' || (window.isSecureContext===true);
  }
  async function resolveCityByGPS(lat,lng){
    try{
      const r=await fetch(`/api/geo/closest-city?lat=${lat}&lng=${lng}&${ts()}`, NO_STORE);
      const js=await r.json();
      if(js&&js.ok&&js.cidade){
        $("cidade").value = js.cidade;
        await refreshBairros();
        gpsStatus.textContent = `Localização detectada: ${js.cidade}`;
      }else{
        gpsStatus.textContent = "Não foi possível identificar sua cidade.";
      }
    }catch{
      gpsStatus.textContent = "Falha ao consultar a cidade.";
    }
  }
  btnGPS.addEventListener("click", ()=>{
    if(!isSecureForGeo()){
      gpsStatus.textContent = "Para usar GPS, acesse via HTTPS ou localhost.";
      return;
    }
    if(!('geolocation' in navigator)){
      gpsStatus.textContent = "Seu navegador não suporta geolocalização.";
      return;
    }
    gpsStatus.textContent = "Solicitando localização…";
    navigator.geolocation.getCurrentPosition(async pos=>{
      const lat = pos.coords.latitude, lng = pos.coords.longitude;
      $("lat").value = String(lat);
      $("lng").value = String(lng);
      gpsStatus.textContent = "Localização obtida.";
      if(!$("cidade").value.trim()) await resolveCityByGPS(lat,lng);
    }, _=>{
      gpsStatus.textContent = "Não foi possível obter a localização.";
    }, {enableHighAccuracy:true,timeout:12000,maximumAge:30000});
  });

  // --- Normalização BR: remove não-dígitos; adiciona 55 se vier só DDD+número ---
  function onlyDigits(s){ return String(s||"").replace(/\D/g,""); }
  function ensureBR(dig){
    if (!dig) return "";
    if (dig.startsWith("55")) return dig;                 // já com Brasil
    if (dig.length===10 || dig.length===11) return "55"+dig; // DDD + 8/9 dígitos
    return dig; // outros casos (deixa como está)
  }
  function isValidBR(digCom55){ return /^\d{12,13}$/.test(digCom55); } // 55 + 2 + 8/9
  // Formatação bonitinha: +55 (21) 98765-4321 ou +55 (21) 3456-7890
  function formatPrettyBR(digCom55){
    if (!/^\d{12,13}$/.test(digCom55)) return "";
    const cc = digCom55.slice(0,2);     // 55
    const ddd = digCom55.slice(2,4);    // 2 dígitos
    const rest = digCom55.slice(4);     // 8 ou 9
    if (rest.length===9){
      return `+${cc} (${ddd}) ${rest.slice(0,5)}-${rest.slice(5)}`;
    }else{
      return `+${cc} (${ddd}) ${rest.slice(0,4)}-${rest.slice(4)}`;
    }
  }
  function bindPhoneInput(inputId, prevId){
    const input = $(inputId);
    const prev  = $(prevId);
    function update(){
      const raw = input.value;
      const dig = onlyDigits(raw);
      const with55 = ensureBR(dig);
      const pretty = formatPrettyBR(with55);
      if (pretty){ prev.textContent = "Formato: " + pretty; prev.style.color="#334155"; }
      else if (dig.length){
        prev.textContent = "Formato inválido — digite com DDD. Ex.: (21) 98765-4321";
        prev.style.color="#b91c1c";
      } else { prev.textContent = ""; }
    }
    input.addEventListener("input", update);
    input.addEventListener("blur", ()=>{
      const dig = onlyDigits(input.value);
      const with55 = ensureBR(dig);
      if (isValidBR(with55)) input.value = with55; // persiste normalizado
      update();
    });
    update();
  }
  bindPhoneInput("whatsapp","whatsPrev");
  bindPhoneInput("telefone","telPrev"); // opcional

  // --- Escapar simples para datalist ---
  function escapeHtml(s){ return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"); }

  // --- Envio com validação mínima no front (o back valida de verdade) ---
  const form = $("formCad");
  form.addEventListener("submit", (e)=>{
    err.style.display="none"; err.textContent="";

    // Foto obrigatória
    if (!foto.files || !foto.files[0]){
      e.preventDefault();
      err.textContent = "Envie uma foto de perfil (JPG/PNG até 3MB).";
      err.style.display = "";
      foto.focus();
      return;
    }

    // Se quer selo, exigir documento
    if (wantSelo.checked){
      if (!doc.files || !doc.files[0]){
        e.preventDefault();
        err.textContent = "Para solicitar o selo verificado, envie um documento com foto.";
        err.style.display = "";
        doc.focus();
        return;
      }
    }

    // Normaliza telefone/whatsapp antes de enviar
    const wIn = $("whatsapp"), tIn = $("telefone");
    const wWith55 = ensureBR( onlyDigits(wIn.value) );
    if (!isValidBR(wWith55)){
      e.preventDefault();
      err.textContent = "WhatsApp inválido. Digite com DDD. Ex.: (21) 98765-4321";
      err.style.display = "";
      wIn.focus();
      return;
    }
    wIn.value = wWith55;

    const tDig = onlyDigits(tIn.value);
    if (tDig){
      const tWith55 = ensureBR(tDig);
      if (!isValidBR(tWith55)){
        e.preventDefault();
        err.textContent = "Telefone inválido. Ex.: (21) 3456-7890";
        err.style.display = "";
        tIn.focus();
        return;
      }
      tIn.value = tWith55;
    }

    // Campos obrigatórios
    if (!$("nome").value.trim()){
      e.preventDefault(); err.textContent="Informe seu nome."; err.style.display=""; $("nome").focus(); return;
    }
    if (!$("cidade").value.trim()){
      e.preventDefault(); err.textContent="Informe sua cidade."; err.style.display=""; $("cidade").focus(); return;
    }
    if (!$("bairro").value.trim()){
      e.preventDefault(); err.textContent="Informe seu bairro."; err.style.display=""; $("bairro").focus(); return;
    }
    if (!($("servico").value.trim() || $("profissao").value.trim())){
      e.preventDefault(); err.textContent="Informe Categoria/Serviço ou Profissão."; err.style.display=""; $("servico").focus(); return;
    }
    if (!$("descricao").value.trim()){
      e.preventDefault(); err.textContent="Descreva seu trabalho em 'Sobre você'."; err.style.display=""; $("descricao").focus(); return;
    }
    // passa — o servidor trata o resto
  });

})();
</script>

<!-- SW: manter registrado (não obrigatório aqui, mas ajuda no mobile) -->
<script>
if ('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('/sw.js?v=cadastro-2025-09-08r').catch(()=>{});
  });
}
</script>
</body>
</html>