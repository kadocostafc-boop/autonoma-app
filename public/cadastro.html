<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cadastro de Profissional ‚Ä¢ Aut√¥noma.app</title>

  <!-- Canonical + SEO -->
  <link rel="canonical" href="https://www.autonomaapp.com.br/cadastro.html" />
  <meta name="description" content="Cadastre seu perfil no Aut√¥noma: informe seus dados, cidade, bairro e WhatsApp para receber clientes pelo app." />

  <!-- PWA / Favicons -->
  <link rel="manifest" href="/manifest.webmanifest" />
  <meta name="theme-color" content="#2d6cdf" />
  <link rel="apple-touch-icon" href="/icons/icon-192.png" />
  <link rel="icon" href="/favicon.ico" />
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16.png" />

  <!-- CSS Global Padronizado -->
  <link rel="stylesheet" href="/css/global.css?v=2.0" />
</head>
<body>
  <header class="header" role="banner">
    <a href="/" aria-label="In√≠cio">
      <img class="logo" src="/img/logo.png" alt="Aut√¥noma.app" onerror="this.style.display='none'">
    </a>
    <div style="margin-left:auto; display:flex; gap:8px">
      <a class="btn ghost" href="/">In√≠cio</a>
      <a class="btn outline" href="/clientes.html">Ver profissionais</a>
    </div>
  </header>

  <main class="wrap" role="main">
    <div class="card">
      <h1 style="margin:0">Cadastre seu perfil</h1>
      <p class="meta">√â r√°pido e gratuito. Voc√™ recebe contatos pelo <strong>WhatsApp</strong>.</p>
    </div>

    <div class="card" style="max-width:880px; margin:auto">
      <!-- IMPORTANTE: action /cadastro, enctype multipart, names exatos -->
      <form id="formCad"
            action="/cadastro"
            method="POST"
            enctype="multipart/form-data"
            novalidate>

        <!-- Foto -->
        <label for="foto">Foto de perfil <strong>(obrigat√≥ria)</strong></label>
        <div class="row-wrap" style="align-items:center">
          <img id="fotoPrev" class="avatar-preview" src="/icons/icon-192.png" alt="Pr√©via da foto">
          <input id="foto" name="foto" type="file" accept="image/*" required aria-required="true">
        </div>
        <p class="help">Formatos: JPG/PNG/WEBP, at√© 3MB. A foto aumenta a confian√ßa do cliente.</p>

        <!-- Selo verificado -->
        <div class="row-wrap" style="align-items:flex-start">
          <label class="gps-pill" style="background:#f0fdf4; border-color:#bbf7d0; color:#166534">
            <input id="wantSelo" type="checkbox" style="transform:translateY(1px)">
            Quero selo verificado
          </label>
          <span id="seloHint" class="muted">Para an√°lise do selo, envie um documento com foto (RG, CNH, passaporte).</span>
        </div>

        <div id="docWrap" style="display:none; margin-top:8px">
          <label for="doc">Documento com foto <span class="muted">(obrigat√≥rio se quiser o selo)</span></label>
          <div class="row-wrap" style="align-items:center">
            <img id="docPrev" class="doc-preview" src="/img/doc-placeholder.png" alt="Pr√©via do documento" onerror="this.style.display='none'">
            <input id="doc" name="doc" type="file" accept="image/*,application/pdf">
          </div>
          <p class="help">Foto leg√≠vel do documento (JPG/PNG) ou PDF.</p>
        </div>

        <!-- Nome -->
        <label for="nome">Seu nome completo *</label>
        <input id="nome" name="nome" type="text" maxlength="80" required placeholder="Ex.: Ana Souza">

        <!-- GPS / Cidade / Bairro -->
        <div class="row-wrap" style="align-items:center; gap:10px; margin-top:4px">
          <button type="button" id="btnGPS" class="btn small" aria-describedby="gpsStatus">Usar minha localiza√ß√£o</button>
          <span id="gpsStatus" class="muted">GPS desativado.</span>
        </div>

        <div class="row-wrap">
          <div class="field-50">
            <label for="cidade">Cidade *</label>
            <input
              id="cidade"
              name="cidade"
              type="text"
              list="lista-cidades"
              required
              placeholder="Ex.: Rio de Janeiro/RJ"
              autocomplete="off"
            >
            <datalist id="lista-cidades"></datalist>
            <p class="help">Digite e escolha na lista. Aceitamos ‚ÄúCidade/UF‚Äù ou s√≥ ‚ÄúCidade‚Äù.</p>
          </div>

          <div class="field-50">
            <label for="bairro">Bairro *</label>
            <input
              id="bairro"
              name="bairro"
              type="text"
              list="lista-bairros"
              required
              placeholder="Ex.: Copacabana"
              autocomplete="off"
            >
            <datalist id="lista-bairros"></datalist>
            <p class="help">Depois de escolher a cidade, este campo sugere bairros automaticamente.</p>
          </div>
        </div>

        <!-- Servi√ßo / Profiss√£o -->
        <div class="row-wrap">
          <div class="field-50">
            <label for="servico">Categoria/Servi√ßo (recomendado)</label>
            <input
              id="servico"
              name="servico"
              type="text"
              list="lista-servicos"
              placeholder="Ex.: Eletricista"
              autocomplete="off"
            >
            <datalist id="lista-servicos"></datalist>
          </div>

          <div class="field-50">
            <label for="profissao">Profiss√£o (alternativa)</label>
            <input
              id="profissao"
              name="profissao"
              type="text"
              maxlength="60"
              placeholder="Ex.: T√©cnico em el√©trica"
            >
          </div>
        </div>

        <p class="help">
          Preencha pelo menos <strong>Servi√ßo</strong> ou <strong>Profiss√£o</strong>.
          Se o servi√ßo n√£o existir na lista, ele ser√° adicionado automaticamente ap√≥s o envio.
        </p>

        <!-- Contatos -->
        <div class="row-wrap">
          <div class="field-50">
            <label for="whatsapp">WhatsApp (com DDD) *</label>
            <input
              id="whatsapp"
              name="whatsapp"
              type="tel"
              required
              inputmode="tel"
              placeholder="Ex.: (21) 98765-4321"
            >
            <div id="whatsPrev" class="preview"></div>
            <p class="help">Pode colar com espa√ßos/par√™nteses/tra√ßos. Formatamos automaticamente e adicionamos o +55.</p>
          </div>

          <div class="field-50">
            <label for="telefone">Telefone (opcional)</label>
            <input
              id="telefone"
              name="telefone"
              type="tel"
              inputmode="tel"
              placeholder="Ex.: (21) 3456-7890"
            >
            <div id="telPrev" class="preview"></div>
          </div>
        </div>

        <!-- E-mail / Site -->
        <div class="row-wrap">
          <div class="field-50">
            <label for="email">E-mail </label>
            <input
              id="email"
              name="email"
              type="email"
              required
              autocomplete="email"
              placeholder="Ex.: voce@email.com"
            >
            <p class="help">Obrigat√≥rio ‚Äî usado para redefinir senha.</p>
          </div>

          <div class="field-50">
            <label for="site">Site/Cat√°logo (opcional)</label>
            <input
              id="site"
              name="site"
              type="url"
              placeholder="Ex.: https://meuportfolio.com"
            >
          </div>
        </div>

        <!-- Endere√ßo / Experi√™ncia / Pre√ßo -->
        <label for="endereco">Endere√ßo (opcional, oculto no perfil)</label>
        <input
          id="endereco"
          name="endereco"
          type="text"
          maxlength="120"
          placeholder="Rua/Av, n√∫mero, complemento (apenas para refer√™ncia interna)"
        >

        <div class="row-wrap">
          <div class="field-50">
            <label for="experiencia">Experi√™ncia (opcional)</label>
            <input
              id="experiencia"
              name="experiencia"
              type="text"
              maxlength="80"
              placeholder="Ex.: 5 anos"
            >
          </div>

          <div class="field-50">
            <label for="precoBase">Pre√ßo base (opcional)</label>
            <input
              id="precoBase"
              name="precoBase"
              type="text"
              maxlength="40"
              placeholder="Ex.: R$ 100/hora"
            >
          </div>
        </div>

        <!-- Sobre voc√™ (BIO) -->
        <label for="bio">Sobre voc√™ </label>
        <textarea
          id="bio"
          name="bio"
          maxlength="600"
          required
          placeholder="Descreva seu trabalho, diferenciais e √°rea de atendimento."
        ></textarea>

        <!-- Lat/Lng (ocultos, preenchidos via GPS e/ou no backend por cidades.json) -->
        <input type="hidden" id="lat" name="lat" />
        <input type="hidden" id="lng" name="lng" />

        <!-- ========== [ SEGURAN√áA: SENHA ] ========== -->
        <div class="grid" style="gap:12px; margin-top:16px">
          <div class="field">
            <label for="senha" class="label">Senha <span style="color:#ef4444">*</span></label>
            <div class="input-group" style="display:flex; align-items:center; gap:8px">
              <input
                type="password"
                id="senha"
                name="senha"
                required
                minlength="8"
                autocomplete="new-password"
                placeholder="M√≠nimo 8 caracteres, letras e n√∫meros"
                class="input"
                style="flex:1"
              >
              <button type="button" id="toggleSenha" class="btn btn-light" aria-label="Mostrar/ocultar senha">üëÅ</button>
            </div>
            <small class="muted">Use ao menos 1 letra e 1 n√∫mero.</small>
            <div id="senhaMeterWrap" style="margin-top:8px">
              <div id="senhaMeter" style="height:8px; border-radius:6px; background:#e5e7eb; overflow:hidden">
                <div id="senhaMeterFill" style="height:100%; width:0%"></div>
              </div>
              <div id="senhaHint" class="muted" style="margin-top:6px; font-size:12px"></div>
            </div>
          </div>

          <div class="field">
            <label for="confirmaSenha" class="label">Confirmar senha <span style="color:#ef4444">*</span></label>
            <div class="input-group" style="display:flex; align-items:center; gap:8px">
              <input
                type="password"
                id="confirmaSenha"
                name="confirmaSenha"
                required
                minlength="8"
                autocomplete="new-password"
                placeholder="Repita a senha"
                class="input"
                style="flex:1"
              >
              <button type="button" id="toggleConfirma" class="btn btn-light" aria-label="Mostrar/ocultar senha">üëÅ</button>
            </div>
            <small id="matchMsg" class="muted" style="display:block; margin-top:6px"></small>
          </div>
        </div>

        <!-- A√ß√µes -->
        <div class="row" style="margin-top:12px; gap:8px; flex-wrap:wrap">
          <button class="btn" type="submit">Cadastrar</button>
          <a class="btn ghost" href="/clientes.html">Cancelar</a>
        </div>

        <!-- Erro -->
        <p id="err" class="meta warn" style="display:none; margin-top:8px"></p>
      </form>
    </div>
  </main>

  <!-- ====== APP SCRIPT ====== -->
  <script>
    (function () {
      const $ = (id) => document.getElementById(id);
      const err = $("err");
      const NO_STORE = { cache: "no-store" };
      const ts = () => "ts=" + Date.now();

      function escapeHtml(s) {
        return String(s||"")
          .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
          .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
      }

      // --- Foto preview
      const foto = $("foto"), fotoPrev = $("fotoPrev");
      if (foto) {
        foto.addEventListener("change", () => {
          const f = foto.files?.[0];
          if (!f) { fotoPrev.src = "/icons/icon-192.png"; return; }
          const ok = /(jpeg|jpg|png|webp)$/i.test(f.type);
          if (!ok) { alert("Escolha JPG/PNG/WEBP."); foto.value = ""; return; }
          if (f.size > 3 * 1024 * 1024) { alert("Imagem at√© 3MB."); foto.value = ""; return; }
          fotoPrev.src = URL.createObjectURL(f);
        });
      }

      // --- Selo / Documento
      const wantSelo = $("wantSelo");
      const docWrap = $("docWrap");
      const doc = $("doc");
      const docPrev = $("docPrev");
      wantSelo.addEventListener("change", () => {
        const on = wantSelo.checked;
        docWrap.style.display = on ? "" : "none";
        doc.required = on;
        doc.setAttribute("aria-required", on ? "true" : "false");
      });
      if (doc) {
        doc.addEventListener("change", () => {
          const f = doc.files?.[0];
          if (!f) { docPrev.style.display = "none"; return; }
          if (f.type && f.type.startsWith("image/")) {
            docPrev.style.display = "";
            docPrev.src = URL.createObjectURL(f);
          } else {
            docPrev.style.display = "none";
          }
        });
      }

      // --- Datalists (cidades / bairros / servi√ßos)
      async function fillCities() {
        try {
          const r = await fetch("/api/geo/cidades?" + ts(), NO_STORE);
          if (!r.ok) return;
          const arr = await r.json();
          $("lista-cidades").innerHTML = (arr || [])
            .map((c) => `<option value="${escapeHtml(c)}">`)
            .join("");
        } catch {}
      }

      async function refreshBairros() {
        const cid = $("cidade").value.trim();
        if (!cid) { $("lista-bairros").innerHTML = ""; return; }
        try {
          const r = await fetch("/api/geo/bairros?cidade=" + encodeURIComponent(cid) + "&" + ts(), NO_STORE);
          if (!r.ok) return;
          const arr = await r.json();
          $("lista-bairros").innerHTML = (arr || [])
            .map((b) => `<option value="${escapeHtml(b)}">`)
            .join("");
        } catch {}
      }

      async function suggestBairros(q) {
        const cid = $("cidade").value.trim();
        if (!cid || !q) return;
        try {
          const r = await fetch(`/api/geo/bairros/suggest?cidade=${encodeURIComponent(cid)}&q=${encodeURIComponent(q)}&${ts()}`, NO_STORE);
          if (!r.ok) return;
          const arr = await r.json();
          $("lista-bairros").innerHTML = (arr || [])
            .map((b) => `<option value="${escapeHtml(b)}">`)
            .join("");
        } catch {}
      }

      async function suggestServicos(q) {
        if (!q) return;
        try {
          const r = await fetch(`/api/geo/servicos/suggest?q=${encodeURIComponent(q)}&${ts()}`, NO_STORE);
          if (!r.ok) return;
          const arr = await r.json();
          $("lista-servicos").innerHTML = (arr || [])
            .map((s) => `<option value="${escapeHtml(s)}">`)
            .join("");
        } catch {}
      }

      $("cidade").addEventListener("change", refreshBairros);
      $("bairro").addEventListener("input", (e) => suggestBairros(e.target.value.trim()));
      $("servico").addEventListener("input", (e) => suggestServicos(e.target.value.trim()));
      fillCities();

      // --- GPS
      const btnGPS = $("btnGPS");
      const gpsStatus = $("gpsStatus");
      function isSecureForGeo() {
        return (location.hostname === "localhost" || location.hostname === "127.0.0.1" || window.isSecureContext === true);
      }
      async function resolveCityByGPS(lat, lng) {
        try {
          const r = await fetch(`/api/geo/closest-city?lat=${lat}&lng=${lng}&${ts()}`, NO_STORE);
          const js = await r.json();
          if (js && js.ok && js.cidade) {
            $("cidade").value = js.cidade;
            await refreshBairros();
            gpsStatus.textContent = `Localiza√ß√£o detectada: ${js.cidade}`;
          } else {
            gpsStatus.textContent = "N√£o foi poss√≠vel identificar sua cidade.";
          }
        } catch {
          gpsStatus.textContent = "Falha ao consultar a cidade.";
        }
      }
      btnGPS.addEventListener("click", () => {
        if (!isSecureForGeo()) {
          gpsStatus.textContent = "Para usar GPS, acesse via HTTPS ou localhost.";
          return;
        }
        if (!("geolocation" in navigator)) {
          gpsStatus.textContent = "Seu navegador n√£o suporta geolocaliza√ß√£o.";
          return;
        }
        gpsStatus.textContent = "Solicitando localiza√ß√£o‚Ä¶";
        navigator.geolocation.getCurrentPosition(
          async (pos) => {
            const lat = pos.coords.latitude, lng = pos.coords.longitude;
            $("lat").value = String(lat);
            $("lng").value = String(lng);
            gpsStatus.textContent = "Localiza√ß√£o obtida.";
            if (!$("cidade").value.trim()) await resolveCityByGPS(lat, lng);
          },
          (_) => { gpsStatus.textContent = "N√£o foi poss√≠vel obter a localiza√ß√£o."; },
          { enableHighAccuracy: true, timeout: 12000, maximumAge: 30000 }
        );
      });

      // ---- Telefone/WhatsApp helpers (alinhados com backend)
      function onlyDigits(s) { return String(s || "").replace(/\D/g, ""); }
      function toBRWith55(d) {
        if (!d) return "";
        if (d.startsWith("55")) return d;
        if (d.length === 10 || d.length === 11) return "55" + d;
        return d;
      }
      function isValidBR(d) { return /^\d{12,13}$/.test(d); }
      function formatPrettyBR(d) {
        if (!/^\d{12,13}$/.test(d)) return "";
        const cc = d.slice(0, 2), ddd = d.slice(2, 4), rest = d.slice(4);
        return rest.length === 9
          ? `+${cc} (${ddd}) ${rest.slice(0, 5)}-${rest.slice(5)}`
          : `+${cc} (${ddd}) ${rest.slice(0, 4)}-${rest.slice(4)}`;
      }
      function bindPhoneInput(inputId, prevId) {
        const input = $(inputId), prev = $(prevId);
        function update() {
          const dig = onlyDigits(input.value);
          const br = toBRWith55(dig);
          const nice = formatPrettyBR(br);
          if (nice) {
            prev.textContent = "Formato: " + nice;
            prev.style.color = "#334155";
          } else if (dig.length) {
            prev.textContent = "Formato inv√°lido ‚Äî digite com DDD. Ex.: (21) 98765-4321";
            prev.style.color = "#b91c1c";
          } else {
            prev.textContent = "";
          }
        }
        input.addEventListener("input", update);
        input.addEventListener("blur", () => {
          const dig = onlyDigits(input.value);
          const br = toBRWith55(dig);
          if (isValidBR(br)) input.value = br; // normaliza no pr√≥prio campo
          update();
        });
        update();
      }
      bindPhoneInput("whatsapp", "whatsPrev");
      bindPhoneInput("telefone", "telPrev");

      // --- Password meter + toggles + match
      const senha = $("senha");
      const confirma = $("confirmaSenha");
      const meterFill = $("senhaMeterFill");
      const hint = $("senhaHint");
      const matchMsg = $("matchMsg");
      function scorePassword(pw) {
        let s = 0;
        if (pw.length >= 8) s += 25;
        if (/[a-zA-Z]/.test(pw)) s += 25;
        if (/\d/.test(pw)) s += 25;
        if (/[^a-zA-Z0-9]/.test(pw)) s += 25;
        return Math.min(100, s);
      }
      function updateMeter() {
        const v = senha.value || "";
        const sc = scorePassword(v);
        meterFill.style.width = sc + "%";
        meterFill.style.background = sc < 50 ? "#f87171" : sc < 75 ? "#fbbf24" : "#22c55e";
        hint.textContent = sc < 50 ? "Senha fraca" : sc < 75 ? "Senha m√©dia" : "Senha forte";
      }
      function updateMatch() {
        if (!confirma.value) { matchMsg.textContent = ""; return; }
        if (senha.value === confirma.value) {
          matchMsg.textContent = "As senhas coincidem.";
          matchMsg.style.color = "#16a34a";
        } else {
          matchMsg.textContent = "As senhas n√£o coincidem.";
          matchMsg.style.color = "#b91c1c";
        }
      }
      senha.addEventListener("input", () => { updateMeter(); updateMatch(); });
      confirma.addEventListener("input", updateMatch);
      updateMeter();

      $("toggleSenha").addEventListener("click", () => {
        senha.type = senha.type === "password" ? "text" : "password";
      });
      $("toggleConfirma").addEventListener("click", () => {
        confirma.type = confirma.type === "password" ? "text" : "password";
      });

      // --- Valida√ß√£o final antes de enviar
      $("formCad").addEventListener("submit", (ev) => {
        err.style.display = "none";
        err.textContent = "";

        if (senha.value !== confirma.value) {
          ev.preventDefault();
          matchMsg.textContent = "As senhas n√£o coincidem.";
          matchMsg.style.color = "#b91c1c";
          err.textContent = "Corrija os campos destacados e tente novamente.";
          err.style.display = "";
          confirma.focus();
          return;
        }
        // deixa o submit seguir normalmente (multipart POST /cadastro)
      });
    })();
  </script>
</body>
</html>