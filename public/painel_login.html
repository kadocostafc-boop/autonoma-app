<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Entrar no painel ‚Ä¢ Profissional ‚Ä¢ Aut√¥noma.app</title>
  <meta name="theme-color" content="#0b1f63">
  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <link rel="icon" href="/favicon.ico">
  <link rel="stylesheet" href="/css/app.css?v=painel-login-2025-09-09r"/>
  <style>
    :root{
      --azul-escuro:#0b1f63; --azul:#2D81FF;
      --bd:#e5e7eb; --txt:#111827; --mut:#64748b;
      --ok:#16a34a; --warn:#92400e; --err:#991b1b;
    }
    html,body{height:100%;margin:0;background:var(--azul-escuro);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .page{min-height:100vh;display:flex;flex-direction:column}
    @supports(min-height:100svh){.page{min-height:100svh}}

    /* ===== Header (novo layout) ===== */
    .header{background:var(--azul-escuro);color:#fff;display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid #0a1a55}
    .header .logo{height:32px;width:auto;display:block}
    .header .spacer{flex:1}
    .header .btn{border:1px solid #ffffff44;background:transparent;color:#fff;padding:8px 12px;border-radius:10px;text-decoration:none;font-weight:800;font-size:14px}
    .header .btn:hover{background:#ffffff18}

    /* ===== Main/Card ===== */
    main{flex:1;display:flex;align-items:center;justify-content:center;padding:18px}
    .wrap{width:100%;max-width:980px}
    .card{background:#fff;border:1px solid var(--bd);border-radius:22px;padding:20px;box-shadow:0 8px 24px rgba(0,0,0,.06)}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:900px){ .grid{grid-template-columns:1.25fr 1fr} }

    .title{margin:0 0 6px;font-size:24px;font-weight:900;color:var(--azul-escuro)}
    .subtitle{margin:0 0 14px;color:var(--mut);font-size:14px}

    label{display:block;font-weight:700;margin:10px 0 6px}
    .input{width:100%;padding:12px;border:1px solid #d1d5db;border-radius:12px;background:#fff;font-size:15px}
    .input:focus{border-color:var(--azul);box-shadow:0 0 0 4px rgba(45,108,223,.2);outline:0}

    .row{display:flex;gap:10px;flex-wrap:wrap}
    .right{display:flex;gap:8px;align-items:flex-end}

    .btn{appearance:none;border:none;border-radius:12px;padding:12px 14px;font-weight:800;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;justify-content:center}
    .btn-primary{background:var(--azul);color:#fff}
    .btn-ghost{background:#f1f5f9;border:1px solid var(--bd);color:#111827}
    .btn-dark{background:var(--azul-escuro);color:#fff}

    .badge{font-size:.75rem;background:#eef2ff;color:#3730a3;border-radius:999px;padding:2px 8px;margin-left:6px}
    .muted{color:var(--mut)} .small{font-size:.92rem}

    #hint{margin-top:8px;font-size:.95rem}
    #hint.ok{color:var(--ok)} #hint.warn{color:var(--warn)} #hint.err{color:var(--err)}

    .preview{font-size:12px;color:#334155;margin-top:4px;min-height:1em}

    #qrBox{display:flex;align-items:center;justify-content:center;min-height:220px;background:#f9fafb;border:1px dashed #e5e7eb;border-radius:12px}
    .help{display:none;margin-top:8px}
    .help.show{display:block}

    /* Lado direito (instru√ß√µes) */
    .side{background:#f8fafc;border:1px solid var(--bd);border-radius:16px;padding:12px}
    .side h3{margin:0 0 6px;font-size:16px}
    .bullet{display:flex;gap:8px;align-items:flex-start;color:#0b1f63}
    .bullet span{color:#111827}

    /* ===== Footer ===== */
    footer{background:var(--azul-escuro);color:#cde1ff;padding:10px 8px;border-top:1px solid #0a1a55}
    .foot-links{display:flex;flex-wrap:wrap;gap:10px;justify-content:center}
    .foot-links a{color:#cde1ff;font-size:13px;text-decoration:none}
    .foot-links a:hover{text-decoration:underline}
    .copy{ text-align:center;font-size:11.5px;color:#b8cffc;margin-top:4px }

    /* Acessibilidade */
    a:focus, button:focus, input:focus{outline:3px solid #a5b4fc;outline-offset:2px}
  </style>
</head>
<body>
  <div class="page">
    <!-- Header -->
    <header class="header" role="banner" aria-label="Cabe√ßalho">
      <a href="/" aria-label="In√≠cio">
        <img src="/img/logo.png" alt="Aut√¥noma.app" class="logo" onerror="this.style.display='none'">
      </a>
      <div class="spacer"></div>
      <a class="btn" href="/clientes.html">Cliente</a>
    </header>

    <!-- Main -->
    <main class="wrap" role="main">
      <div class="card">
        <h1 class="title">Entrar no painel <span class="badge">acesso por token</span></h1>
        <p class="subtitle">
          Informe seu WhatsApp (com DDD). Vamos gerar um <strong>link</strong> e um <strong>QR</strong> para criar a sess√£o.
          Se estiver em loop no celular, abra o link no <b>navegador padr√£o</b> (Chrome/Safari).
        </p>

        <div class="grid">
          <!-- Coluna esquerda -->
          <div>
            <div class="row">
              <div style="flex:1 1 260px">
                <label for="whats">WhatsApp (somente n√∫meros ‚Äî com ou sem 55)</label>
                <input id="whats" class="input" inputmode="numeric" autocomplete="tel" placeholder="21987654321"/>
                <div id="pretty" class="preview"></div>
              </div>
              <div class="right">
                <button id="btnLink" class="btn btn-primary" type="button">Gerar link &amp; QR</button>
                <button id="btnEntrar" class="btn btn-ghost" type="button" title="Abrir o painel agora com o token">Entrar agora</button>
              </div>
            </div>

            <div id="hint" class="muted"></div>
            <div id="loopHelp" class="help small">
              Dica: se ao abrir o link voc√™ voltar para esta tela, pode ser bloqueio de cookies no WebView do app.
              Use o navegador (Chrome/Safari) ou abra em aba an√¥nima.
            </div>

            <div style="margin-top:12px" class="row">
              <div style="flex:1 1 320px">
                <div id="qrBox" aria-live="polite">O QR aparecer√° aqui ap√≥s gerar o link.</div>
                <div class="row" style="margin-top:10px">
                  <button id="btnCheck" class="btn btn-dark" type="button" title="Confere se a sess√£o foi criada corretamente">Verificar sess√£o</button>
                  <button id="btnShare" class="btn btn-ghost" type="button" title="Compartilhar link" style="display:none">Compartilhar</button>
                </div>
                <p id="sessOut" class="small muted" style="margin-top:6px"></p>
              </div>
            </div>
          </div>

          <!-- Coluna direita (instru√ß√µes) -->
          <aside class="side">
            <h3>Como funciona</h3>
            <div class="bullet">‚úÖ <span>Informe seu n√∫mero do WhatsApp com DDD.</span></div>
            <div class="bullet">üîó <span>Geramos um link para <code>/painel.html?token=SEU_WHATSAPP</code>.</span></div>
            <div class="bullet">üì± <span>Abra esse link no celular onde vai usar o painel (via QR/compartilhar).</span></div>
            <div class="bullet">üîê <span>Ao abrir, a sess√£o √© criada e voc√™ √© redirecionado para <code>/painel.html</code>.</span></div>
            <hr style="border:none;border-top:1px solid #e5e7eb;margin:10px 0">
            <p class="muted small">
              Android: prefira abrir no <b>Chrome</b>.<br/>
              iPhone: abra no <b>Safari</b> (n√£o dentro de outros apps).
            </p>
          </aside>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="footer" role="contentinfo">
      <nav class="foot-links" aria-label="Links do rodap√©">
        <a href="/termos.html">Termos</a>
        <a href="/privacidade.html">Privacidade</a>
        <a href="/top10.html">Top 10</a>
        <a href="/planos.html">Planos</a>
        <a href="/politica-de-seguranca.html">Seguran√ßa</a>
        <a href="/favoritos.html">Favoritos</a>
      </nav>
      <div class="copy">¬© 2025 Aut√¥noma.app ‚Äî Todos os direitos reservados.</div>
    </footer>
  </div>

  <script>
  (function(){
    // ---------- helpers ----------
    const $ = sel => document.querySelector(sel);
    const whatsEl = $('#whats');
    const hintEl  = $('#hint');
    const prettyEl= $('#pretty');
    const qrBox   = $('#qrBox');
    const sessOut = $('#sessOut');
    const btnShare= $('#btnShare');

    const NO_STORE = { cache:'no-store' };
    const ts = () => 'ts=' + Date.now();

    function hint(msg, tone){
      hintEl.textContent = msg || '';
      hintEl.className = '';
      hintEl.id = 'hint';
      if (tone) hintEl.classList.add(tone);
    }

    // normaliza√ß√£o (front) ‚Äî servidor tamb√©m normaliza
    function onlyDigits(s){ return String(s||'').replace(/\D/g,''); }
    function ensureBR(d){
      if (!d) return '';
      if (d.startsWith('55')) return d;
      if (d.length===10 || d.length===11) return '55'+d;
      return d;
    }
    function pretty(d55){
      if(!/^\d{12,13}$/.test(d55)) return '';
      const cc=d55.slice(0,2), ddd=d55.slice(2,4), rest=d55.slice(4);
      return rest.length===9
        ? `+${cc} (${ddd}) ${rest.slice(0,5)}-${rest.slice(5)}`
        : `+${cc} (${ddd}) ${rest.slice(0,4)}-${rest.slice(4)}`;
    }
    function updatePretty(){
      const raw = onlyDigits(whatsEl.value);
      const with55 = ensureBR(raw);
      const p = pretty(with55);
      prettyEl.textContent = p ? ('Formato: '+p) : '';
    }
    whatsEl.addEventListener('input', updatePretty);
    whatsEl.addEventListener('blur', updatePretty);

    function buildLink(tokenDigits){
      const base = location.origin || (location.protocol + '//' + location.host);
      return base + '/painel.html?token=' + encodeURIComponent(tokenDigits);
    }

    // ---------- QR + Link ----------
    async function gerarLinkEQR(){
      const raw = onlyDigits(whatsEl.value);
      if (!raw){
        hint('Informe seu WhatsApp com DDD.', 'warn');
        whatsEl.focus();
        return;
      }
      const link = buildLink(raw);

      // copia link quando poss√≠vel
      try{
        await navigator.clipboard.writeText(link);
        hint('Link copiado. Escaneie o QR ou use ‚ÄúEntrar agora‚Äù.', 'ok');
      }catch{
        hint('Link: ' + link, 'warn');
      }

      // QR com cache-buster
      const img = new Image();
      img.width = 220; img.height = 220; img.alt = 'QR de acesso';
      img.onload = ()=>{ qrBox.innerHTML=''; qrBox.appendChild(img); };
      img.onerror = ()=>{ qrBox.textContent='QR indispon√≠vel'; };
      img.src = '/api/qr?text=' + encodeURIComponent(link) + '&' + ts();

      // compartilhamento nativo (se suportado)
      if (navigator.share){
        btnShare.style.display = '';
        btnShare.onclick = async ()=>{
          try{
            await navigator.share({ title:'Aut√¥noma ‚Ä¢ Painel', text:'Acesse seu painel com este link:', url: link });
          }catch{}
        };
      }

      // salva √∫ltima tentativa (para dicas)
      try{ localStorage.setItem('aut_last_token', raw); }catch{}
    }

    function entrarAgora(){
      const raw = onlyDigits(whatsEl.value);
      if (!raw){
        hint('Informe seu WhatsApp com DDD.', 'warn');
        whatsEl.focus();
        return;
      }
      try{ localStorage.setItem('aut_last_token', raw); }catch{}
      location.href = buildLink(raw); // servidor cria a sess√£o e redireciona para /painel.html
    }

    // ---------- Verificar sess√£o ----------
    async function verificarSessao(){
      sessOut.textContent = 'Verificando sess√£o‚Ä¶';
      try{
        const r = await fetch('/api/painel/me?'+ts(), NO_STORE);
        if (!r.ok){
          sessOut.textContent = 'N√£o logado ainda. Abra o link/QR no mesmo navegador (Chrome/Safari) e tente novamente.';
          return;
        }
        const js = await r.json();
        if (js && js.ok){
          sessOut.textContent = 'Sess√£o OK! Abrindo painel‚Ä¶';
          setTimeout(()=> location.href = '/painel.html', 400);
        }else{
          sessOut.textContent = 'N√£o logado ainda. Se abriu o link e voltou, pode ser bloqueio de cookies do app. Abra no navegador.';
        }
      }catch{
        sessOut.textContent = 'Falha ao verificar. Tente novamente.';
      }
    }

    // ---------- Cookies / Loop help ----------
    function testFirstPartyCookies(){
      try{
        document.cookie = 'aut_test=1; Path=/';
        const ok = document.cookie.indexOf('aut_test=1') !== -1;
        document.cookie = 'aut_test=; Path=/; Max-Age=0';
        return ok;
      }catch{ return false; }
    }
    function showLoopHelpIfNeeded(){
      try{
        if(localStorage.getItem('aut_last_token')) document.getElementById('loopHelp').classList.add('show');
      }catch{}
      if (!testFirstPartyCookies()){
        hint('Seu navegador est√° bloqueando cookies. Abra em outro navegador ou aba an√¥nima.', 'warn');
        document.getElementById('loopHelp').classList.add('show');
      }
    }

    // ---------- binds ----------
    document.getElementById('btnLink').addEventListener('click', gerarLinkEQR);
    document.getElementById('btnEntrar').addEventListener('click', entrarAgora);
    document.getElementById('btnCheck').addEventListener('click', verificarSessao);

    // PWA (mant√©m padr√£o do site)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js?v=painel-login-2025-09-09r').catch(()=>{});
      });
      let reloaded=false;
      navigator.serviceWorker.addEventListener('controllerchange', ()=>{
        if(!reloaded){ reloaded=true; location.reload(); }
      });
    }

    // Compat: ?ok=1 -> ir para /painel (fluxo antigo)
    const params = new URLSearchParams(location.search);
    if (params.get('ok') === '1') {
      location.replace('/painel');
    }

    // start
    whatsEl.focus({preventScroll:true});
    showLoopHelpIfNeeded();
    updatePretty();
  })();
  </script>
</body>
</html>