<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Entrar no Painel ‚Ä¢ Aut√¥noma.app</title>

  <!-- Canonical + SEO -->
  <link rel="canonical" href="https://autonomaapp.com.br/painel_login.html">
  <meta name="description" content="Acesse seu painel do Aut√¥noma.app para gerenciar seu perfil e receber clientes.">

  <!-- PWA / Favicons -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#2d6cdf">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16.png">

  <!-- CSS global -->
  <link rel="stylesheet" href="/css/app.css?v=painel-login-2025-09-15">
  <style>
    .header { display:flex; align-items:center; gap:12px; padding:12px 16px }
    .header .logo { height:32px; width:auto; display:block }
    .muted { color:#64748b; font-size:12px }
    .wrap-narrow { max-width:520px; margin:28px auto; padding:0 12px }
    .preview { font-size:12px; color:#334155; margin-top:4px }
    .btn.small { padding:8px 12px; font-size:14px }
    .warn { color:#b91c1c }
  </style>
</head>
<body>
<header class="header" role="banner">
  <a href="/" aria-label="In√≠cio">
    <img class="logo" src="/img/logo.png" alt="Aut√¥noma.app" onerror="this.style.display='none'">
  </a>
  <div style="margin-left:auto;display:flex;gap:8px">
    <a class="btn ghost" href="/">In√≠cio</a>
    <a class="btn outline" href="/clientes.html">Ver profissionais</a>
  </div>
</header>

<main class="wrap wrap-narrow" role="main">
  <div class="card" style="padding:20px">
    <h1 style="margin:0 0 6px">Entrar no painel</h1>
    <p class="meta" style="margin:0 0 14px">Use seu <strong>WhatsApp ou e-mail</strong> e sua <strong>senha</strong>.</p>

    <form id="loginForm" class="grid" style="gap:12px">
      <!-- Identificador -->
      <div class="field">
        <label for="whatsOrEmail" class="label">WhatsApp (com DDD) ou e-mail</label>
        <input id="whatsOrEmail" name="identifier" class="input" inputmode="text" autocomplete="username"
               placeholder="21999998888 ou voce@exemplo.com" required>
        <div id="idPrev" class="preview"></div>
        <small class="muted">Se usar WhatsApp, digite apenas d√≠gitos (DDD+n√∫mero). N√≥s formatamos e adicionamos +55.</small>
      </div>

      <!-- Senha -->
      <div class="field">
        <label for="senha" class="label">Senha</label>
        <div style="display:flex; align-items:center; gap:8px">
          <input id="senha" name="password" type="password" class="input" required autocomplete="current-password" placeholder="Sua senha">
          <button type="button" id="toggleSenha" class="btn btn-light" aria-label="Mostrar/ocultar senha">üëÅ</button>
        </div>
      </div>

      <!-- Lembrar / Esqueci -->
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px">
        <label style="display:flex;gap:6px;align-items:center;font-size:14px">
          <input type="checkbox" id="rememberMe" name="rememberMe">
          Lembrar de mim
        </label>
        <button type="button" id="forgotOpenBtn" class="btn btn-link" style="font-size:14px;line-height:1">
          Esqueci minha senha
        </button>
      </div>

      <!-- A√ß√µes -->
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">
        <a href="/cadastro.html" class="btn btn-light">Criar conta</a>
        <button type="submit" class="btn btn-primary" id="loginBtn">Entrar</button>
      </div>

      <p id="errLogin" class="meta warn" style="display:none;margin-top:6px"></p>
    </form>
  </div>
</main>

<!-- ========[ MODAL: ESQUECI MINHA SENHA ]======== -->
<div id="forgotOverlay" style="position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:9998"></div>
<div id="forgotModal" role="dialog" aria-modal="true" aria-labelledby="forgotTitle"
     style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:9999">
  <div class="card" style="width:min(520px,92vw);background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.15);overflow:hidden">
    <div style="padding:16px 18px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center">
      <h3 id="forgotTitle" style="margin:0;font-size:18px">Redefinir senha</h3>
      <button type="button" id="forgotCloseBtn" class="btn btn-light" aria-label="Fechar">‚úï</button>
    </div>
    <form id="forgotForm" style="padding:18px;display:grid;gap:12px">
      <p class="muted" style="margin:0 0 6px">
        Informe seu <strong>WhatsApp</strong> (com DDD) <em>ou</em> seu <strong>e-mail</strong>. Enviaremos um link para redefinir sua senha.
      </p>
      <div class="field">
        <label for="forgotId" class="label">WhatsApp ou e-mail</label>
        <input id="forgotId" name="identifier" class="input" placeholder="21999998888 ou voce@exemplo.com" required>
        <small class="muted">Se digitar n√∫mero, use apenas d√≠gitos.</small>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:6px">
        <button type="button" id="forgotCancelBtn" class="btn btn-light">Cancelar</button>
        <button type="submit" id="forgotSubmitBtn" class="btn btn-primary">Enviar link</button>
      </div>
      <!-- Feedback -->
      <div id="forgotMsg" style="display:none;margin-top:6px;font-size:14px"></div>
      <!-- Atalho (modo dev) -->
      <div id="forgotDev" style="display:none;margin-top:6px">
        <button type="button" id="openResetLinkBtn" class="btn btn-outline">Abrir link de redefini√ß√£o</button>
      </div>
    </form>
  </div>
</div>
<!-- ========[/ MODAL: ESQUECI MINHA SENHA ]======== -->

<script>
(function(){
  const $ = (s, r=document) => r.querySelector(s);

  // ===== Helpers (WhatsApp BR) =====
  function onlyDigits(s){ return String(s||"").replace(/\D/g,""); }
  function ensureBR(dig){
    if (!dig) return "";
    if (dig.startsWith("55")) return dig;
    if (dig.length===10 || dig.length===11) return "55"+dig;
    return dig;
  }
  function isValidBR(digCom55){ return /^\d{12,13}$/.test(digCom55); }
  function formatPrettyBR(digCom55){
    if (!/^\d{12,13}$/.test(digCom55)) return "";
    const cc = digCom55.slice(0,2);
    const ddd = digCom55.slice(2,4);
    const rest = digCom55.slice(4);
    if (rest.length===9){ return `+${cc} (${ddd}) ${rest.slice(0,5)}-${rest.slice(5)}`; }
    return `+${cc} (${ddd}) ${rest.slice(0,4)}-${rest.slice(4)}`;
  }
  function isEmail(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v); }

  // ===== Login form =====
  const form = $('#loginForm');
  const idInput = $('#whatsOrEmail');
  const idPrev = $('#idPrev');
  const senha = $('#senha');
  const toggleSenha = $('#toggleSenha');
  const remember = $('#rememberMe');
  const errBox = $('#errLogin');
  const loginBtn = $('#loginBtn');

  function updatePretty(){
    const raw = (idInput.value||'').trim();
    if (!raw){
      idPrev.textContent = '';
      return;
    }
    if (isEmail(raw)){
      idPrev.textContent = `E-mail: ${raw}`;
      idPrev.style.color = '#334155';
      return;
    }
    const dig = onlyDigits(raw);
    const with55 = ensureBR(dig);
    if (isValidBR(with55)){
      idPrev.textContent = 'Formato: ' + formatPrettyBR(with55);
      idPrev.style.color = '#334155';
    } else {
      idPrev.textContent = 'WhatsApp inv√°lido ‚Äî use DDD+n√∫mero (ex.: 21987654321)';
      idPrev.style.color = '#b91c1c';
    }
  }

  toggleSenha?.addEventListener('click', ()=>{
    const isPwd = senha.type === 'password';
    senha.type = isPwd ? 'text' : 'password';
    toggleSenha.textContent = isPwd ? 'üôà' : 'üëÅ';
  });

  form?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    errBox.style.display = 'none';
    errBox.textContent = '';

    const rawId = (idInput.value||'').trim();
    if (!rawId){ return showErr('Informe seu WhatsApp ou e-mail.'); }

    let identifier = rawId;
    if (!isEmail(rawId)){
      const dig = onlyDigits(rawId);
      const with55 = ensureBR(dig);
      if (!isValidBR(with55)){ return showErr('WhatsApp inv√°lido. Digite com DDD.'); }
      identifier = with55;
    }

    const password = senha.value || '';
    if (!password){ return showErr('Informe sua senha.'); }

    setLoading(true);
    try{
      const res = await fetch('/auth/pro/login', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          identifier,
          password,
          rememberMe: !!remember.checked
        })
      });
      const data = await res.json().catch(()=> ({}));

      if (data && data.ok){
        location.href = data.redirect || '/painel';
        return;
      }
      const msg = (data && (data.message||data.error)) || 'Credenciais inv√°lidas.';
      showErr(msg);
    }catch(err){
      showErr('Falha de conex√£o. Tente novamente.');
    }finally{
      setLoading(false);
    }
  });

  function showErr(t){
    errBox.textContent = t;
    errBox.style.display = 'block';
  }
  function setLoading(on){
    if (on){ loginBtn.disabled = true; loginBtn.textContent = 'Entrando‚Ä¶'; }
    else    { loginBtn.disabled = false; loginBtn.textContent = 'Entrar'; }
  }

  // ===== Forgot Password (modal) =====
  const openBtn   = $('#forgotOpenBtn');
  const overlay   = $('#forgotOverlay');
  const modal     = $('#forgotModal');
  const closeBtn  = $('#forgotCloseBtn');
  const cancelBtn = $('#forgotCancelBtn');
  const forgotForm= $('#forgotForm');
  const forgotId  = $('#forgotId');
  const forgotMsg = $('#forgotMsg');
  const devWrap   = $('#forgotDev');
  const devBtn    = $('#openResetLinkBtn');
  const forgotSubmitBtn = $('#forgotSubmitBtn');
  let lastResetUrl = null;

  function openModal(){
    overlay.style.display = 'block';
    modal.style.display   = 'flex';
    forgotMsg.style.display = 'none';
    forgotMsg.textContent   = '';
    forgotMsg.style.color   = '';
    devWrap.style.display   = 'none';
    lastResetUrl = null;
    forgotId.value = '';
    forgotId.focus();
    document.addEventListener('keydown', escClose, { once:true });
  }
  function closeModal(){
    overlay.style.display = 'none';
    modal.style.display   = 'none';
  }
  function escClose(e){ if (e.key === 'Escape') closeModal(); }

  openBtn?.addEventListener('click', openModal);
  closeBtn?.addEventListener('click', closeModal);
  cancelBtn?.addEventListener('click', closeModal);
  overlay?.addEventListener('click', closeModal);

  forgotForm?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const raw = (forgotId.value||'').trim();
    if (!raw){ return toast('Informe WhatsApp ou e-mail.', 'error'); }

    const identifier = isEmail(raw) ? raw : onlyDigits(raw);
    if (!identifier){ return toast('Informe um contato v√°lido.', 'error'); }

    setForgotLoading(true);
    try{
      const res = await fetch('/auth/pro/forgot', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ identifier })
      });
      const data = await res.json().catch(()=> ({}));
      if (data && data.ok){
        forgotMsg.style.display = 'block';
        forgotMsg.style.color = '#16a34a';
        forgotMsg.innerHTML = 'Se encontramos sua conta, enviaremos um link para redefinir a senha. Verifique sua caixa de entrada.';
        if (data.resetUrl){
          lastResetUrl = data.resetUrl;
          devWrap.style.display = 'block';
        } else if (data.token){
          lastResetUrl = '/reset?token=' + encodeURIComponent(data.token);
          devWrap.style.display = 'block';
        }
      } else {
        const err = (data && (data.message||data.error)) || 'N√£o foi poss√≠vel processar sua solicita√ß√£o.';
        forgotMsg.style.display = 'block';
        forgotMsg.style.color = '#ef4444';
        forgotMsg.textContent = err;
      }
    }catch(err){
      forgotMsg.style.display = 'block';
      forgotMsg.style.color = '#ef4444';
      forgotMsg.textContent = 'Falha de conex√£o. Tente novamente.';
    }finally{
      setForgotLoading(false);
    }
  });

  devBtn?.addEventListener('click', ()=>{
    if (!lastResetUrl) return;
    window.location.href = lastResetUrl;
  });

  function setForgotLoading(on){
    if(on){
      forgotSubmitBtn.disabled = true;
      forgotSubmitBtn.textContent = 'Enviando...';
    } else {
      forgotSubmitBtn.disabled = false;
      forgotSubmitBtn.textContent = 'Enviar link';
    }
  }
  function toast(text){
    if (window.showToast) return window.showToast(text, { type:'info' });
    alert(text);
  }

  // ===== PWA (igual ao seu padr√£o) =====
  if ('serviceWorker' in navigator){
    window.addEventListener('load', ()=>{
      navigator.serviceWorker.register('/sw.js?v=painel-login-2025-09-15').catch(()=>{});
    });
    let reloaded=false;
    navigator.serviceWorker.addEventListener('controllerchange', ()=>{
      if(!reloaded){ reloaded=true; location.reload(); }
    });
  }

  // start
  idInput.focus({preventScroll:true});
  idInput.addEventListener('input', updatePretty);
  idInput.addEventListener('blur', updatePretty);
  updatePretty();
})();
</script>
</body>
</html>