<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Entrar no Painel ‚Ä¢ Aut√¥noma.app</title>
  <link rel="stylesheet" href="/css/global.css?v=2.0">
  <style>
    /* P√°gina de login centralizada */
    html, body { height: 100%; }
    body {
      display: grid;
      place-items: center;
      background: var(--secondary);
    }
    .wrap { width: min(680px, 92vw); }
    .card {
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.35);
      overflow: hidden;
    }
    .card-head {
      padding: 24px 26px;
      border-bottom: 1px solid var(--border-color);
    }
    .card-body { padding: 24px 26px; }
    
    /* 3 colunas no desktop: identificador | senha | olho */
    .row-login {
      display: grid;
      grid-template-columns: 1fr 220px 56px;
      gap: 10px;
    }
    @media (max-width: 720px) {
      .row-login { grid-template-columns: 1fr; }
    }
    .btn-light{background:#e2e8f0; color:#0f172a}
    .actions{display:flex; gap:12px; justify-content:flex-end; margin-top:8px}
    .remember{display:flex; align-items:center; gap:8px; font-size:14px}
    .tips{font-size:12px; color:#475569}
    .err{color:#dc2626; font-weight:600}
    /* modal */
    .overlay{position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; z-index:9998}
    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:9999}
    .modal .card{width:min(520px,92vw)}
    .modal-head{padding:14px 18px; border-bottom:1px solid #e5e7eb; display:flex; align-items:center; justify-content:space-between}
  </style>
</head>
<body>
<main class="wrap">
  <div class="card">
    <div class="card-head">
      <h1>Entrar no painel</h1>
      <p class="muted" style="margin:8px 0 0">Use seu <strong>WhatsApp ou e-mail</strong> e sua <strong>senha</strong>.</p>
    </div>
    <div class="card-body">
      <form id="loginForm" class="grid" autocomplete="on">
        <!-- linha 1: identificador + senha + olho -->
        <div class="row-login">
          <div>
            <label for="whatsOrEmail">WhatsApp (com DDD) ou e-mail</label>
            <input id="whatsOrEmail" name="identifier" class="input" inputmode="text" autocomplete="username"
                   placeholder="21999999999 ou voce@exemplo.com" required>
            <div id="idPrev" class="tips" style="margin-top:6px"></div>
            <div class="tips">Se usar WhatsApp, digite apenas d√≠gitos (DDD+n√∫mero). N√≥s formatamos e adicionamos +55.</div>
          </div>
          <div>
            <label for="senha">Senha</label>
            <input id="senha" name="password" type="password" class="input" required autocomplete="current-password" placeholder="Sua senha">
          </div>
          <div style="display:flex; align-items:flex-end">
            <button type="button" id="toggleSenha" class="btn btn-ghost" aria-label="Mostrar/ocultar senha">üëÅ</button>
          </div>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:6px">
          <label class="remember">
            <input type="checkbox" id="rememberMe" name="rememberMe"> Lembrar de mim
          </label>
          <button type="button" id="forgotOpenBtn" class="btn btn-light">Esqueci minha senha</button>
        </div>

        <div class="actions">
          <a href="/cadastro.html" class="btn btn-light">Criar conta</a>
          <button type="submit" class="btn btn-primary" id="loginBtn">Entrar</button>
        </div>

        <p id="errLogin" class="err" style="display:none; margin:4px 0 0"></p>
      </form>
    </div>
  </div>
</main>

<!-- ===== Modal: Esqueci minha senha ===== -->
<div id="forgotOverlay" class="overlay"></div>
<div id="forgotModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="forgotTitle">
  <div class="card">
    <div class="modal-head">
      <h3 id="forgotTitle" style="margin:0">Redefinir senha</h3>
      <button type="button" id="forgotCloseBtn" class="btn btn-light">‚úï</button>
    </div>
    <form id="forgotForm" style="padding:18px" class="grid">
      <p class="muted" style="margin:0">Informe seu <strong>e-mail</strong> cadastrado. Enviaremos um link para redefinir sua senha.</p>
      <div>
        <label for="forgotEmail">E-mail</label>
        <input id="forgotEmail" name="email" class="input" type="email" required placeholder="voce@exemplo.com" autocomplete="email">
      </div>
      <div class="actions">
        <button type="button" id="forgotCancelBtn" class="btn btn-light">Cancelar</button>
        <button type="submit" id="forgotSubmitBtn" class="btn btn-primary">Enviar link</button>
      </div>
      <div id="forgotMsg" style="display:none; margin-top:6px; font-size:14px"></div>
      <div id="forgotDev" style="display:none; margin-top:6px">
        <button type="button" id="openResetLinkBtn" class="btn btn-light">Abrir link de redefini√ß√£o</button>
      </div>
    </form>
  </div>
</div>
<!-- ===== /Modal ===== -->

<script>
(function(){
  const $ = (s, r=document) => r.querySelector(s);

  // ===== Helpers iguais aos do cadastro/backend =====
  const onlyDigits = (s) => String(s||"").replace(/\D/g,"");
  const toBRWith55 = (d) => {
    if(!d) return "";
    if(d.startsWith("55")) return d;
    if(d.length===10 || d.length===11) return "55"+d;
    return d;
  };
  const isValidBR = (d) => /^\d{12,13}$/.test(String(d||""));
  const isEmail   = (v) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(v||"").trim());

  // ===== UI =====
  const form = $('#loginForm');
  const idInput = $('#whatsOrEmail');
  const idPrev = $('#idPrev');
  const senha = $('#senha');
  const toggleSenha = $('#toggleSenha');
  const remember = $('#rememberMe');
  const errBox = $('#errLogin');
  const loginBtn = $('#loginBtn');

  function updatePretty(){
    const raw = (idInput.value||'').trim();
    if(!raw){ idPrev.textContent=''; return; }
    if(isEmail(raw)){ idPrev.textContent='E-mail: '+raw.toLowerCase(); idPrev.style.color='#334155'; return; }
    const dig = toBRWith55( onlyDigits(raw) );
    if(isValidBR(dig)){ idPrev.textContent='Formato: +' + dig.slice(0,2) + ' ('+dig.slice(2,4)+') ' + (dig.length===13?dig.slice(4,9)+'-'+dig.slice(9):dig.slice(4,8)+'-'+dig.slice(8)); idPrev.style.color='#334155'; }
    else{ idPrev.textContent='WhatsApp inv√°lido ‚Äî use DDD+n√∫mero (ex.: 21999999999)'; idPrev.style.color='#dc2626'; }
  }

  toggleSenha?.addEventListener('click', ()=>{
    const isPwd = senha.type === 'password';
    senha.type = isPwd ? 'text' : 'password';
    toggleSenha.textContent = isPwd ? 'üôà' : 'üëÅ';
  });

  form?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    errBox.style.display='none'; errBox.textContent='';

    const rawId = (idInput.value||'').trim();
    if(!rawId){ return showErr('Informe seu WhatsApp ou e-mail.'); }

    let identifier = rawId;
    if(isEmail(rawId)){
      identifier = rawId.toLowerCase();
    }else{
      const dig = toBRWith55( onlyDigits(rawId) );
      if(!isValidBR(dig)){ return showErr('WhatsApp inv√°lido. Digite com DDD.'); }
      identifier = dig;
    }

    const password = senha.value||'';
    if(!password){ return showErr('Informe sua senha.'); }

    setLoading(true);
    try{
      const res = await fetch('/auth/pro/login', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ phone: identifier, pin: password, rememberMe: !!remember.checked })
});
      const data = await res.json().catch(()=> ({}));
      if(data && data.ok){
        location.href = data.redirect || '/painel';
        return;
      }
      showErr((data && (data.message||data.error)) || 'Credenciais inv√°lidas.');
    }catch(_){
      showErr('Falha de conex√£o. Tente novamente.');
    }finally{
      setLoading(false);
    }
  });

  function showErr(t){ errBox.textContent=t; errBox.style.display='block'; }
  function setLoading(on){ if(on){ loginBtn.disabled=true; loginBtn.textContent='Entrando‚Ä¶'; } else { loginBtn.disabled=false; loginBtn.textContent='Entrar'; } }

  // ===== Modal: Esqueci senha =====
  const openBtn=$('#forgotOpenBtn'), overlay=$('#forgotOverlay'), modal=$('#forgotModal');
  const closeBtn=$('#forgotCloseBtn'), cancelBtn=$('#forgotCancelBtn');
  const forgotForm=$('#forgotForm'), forgotEmail=$('#forgotEmail'), forgotMsg=$('#forgotMsg');
  const devWrap=$('#forgotDev'), devBtn=$('#openResetLinkBtn'), forgotSubmitBtn=$('#forgotSubmitBtn');
  let lastResetUrl=null;

  function openModal(){
    overlay.style.display='block'; modal.style.display='flex';
    forgotMsg.style.display='none'; forgotMsg.textContent=''; forgotMsg.style.color='';
    devWrap.style.display='none'; lastResetUrl=null; forgotEmail.value=''; forgotEmail.focus();
    document.addEventListener('keydown', escClose, {once:true});
  }
  function closeModal(){ overlay.style.display='none'; modal.style.display='none'; }
  function escClose(e){ if(e.key==='Escape') closeModal(); }
  openBtn?.addEventListener('click', openModal);
  overlay?.addEventListener('click', closeModal);
  closeBtn?.addEventListener('click', closeModal);
  cancelBtn?.addEventListener('click', closeModal);

  forgotForm?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const email=(forgotEmail.value||'').trim().toLowerCase();
    if(!isEmail(email)){ forgotMsg.style.display='block'; forgotMsg.style.color='#dc2626'; forgotMsg.textContent='Digite um e-mail v√°lido.'; return; }
    setForgotLoading(true);
    try{
      const res = await fetch('/auth/pro/forgot', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ identifier: email }) });
      const data = await res.json().catch(()=> ({}));
      if(data && data.ok){
        forgotMsg.style.display='block'; forgotMsg.style.color='#16a34a';
        forgotMsg.textContent='Se encontramos sua conta, enviamos um link para redefinir sua senha. Verifique seu e-mail.';
        if(data.resetUrl){ lastResetUrl=data.resetUrl; devWrap.style.display='block'; }
        else if(data.token){ lastResetUrl='/reset?token='+encodeURIComponent(data.token); devWrap.style.display='block'; }
      }else{
        const err=(data && (data.message||data.error))||'N√£o foi poss√≠vel processar sua solicita√ß√£o.';
        forgotMsg.style.display='block'; forgotMsg.style.color='#dc2626'; forgotMsg.textContent=err;
      }
    }catch(_){
      forgotMsg.style.display='block'; forgotMsg.style.color='#dc2626'; forgotMsg.textContent='Falha de conex√£o. Tente novamente.';
    }finally{ setForgotLoading(false); }
  });
  devBtn?.addEventListener('click', ()=>{ if(lastResetUrl) location.href=lastResetUrl; });
  function setForgotLoading(on){ if(on){ forgotSubmitBtn.disabled=true; forgotSubmitBtn.textContent='Enviando‚Ä¶'; } else { forgotSubmitBtn.disabled=false; forgotSubmitBtn.textContent='Enviar link'; } }

  // in√≠cio
  idInput?.addEventListener('input', updatePretty);
  idInput?.addEventListener('blur', updatePretty);
  updatePretty();
})();
</script>
</body>
</html>