<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Entrar no Painel • Autônoma.app</title>

  <meta name="theme-color" content="#2d6cdf">
  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <link rel="icon" href="/favicon.ico">
  <link rel="stylesheet" href="/css/app.css?v=painel-login-2025-09-08r"/>

  <style>
    .wrap{max-width:640px;margin:8vh auto 4vh;padding:16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:18px;box-shadow:0 8px 20px rgba(0,0,0,.06)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .col{flex:1 1 260px}
    label{display:block;font-weight:700;margin:10px 0 6px}
    input,button{font:inherit}
    input{
      width:100%;padding:10px;border:1px solid #d1d5db;border-radius:10px;outline:none
    }
    input:focus{border-color:#2d6cdf;box-shadow:0 0 0 4px rgba(45,108,223,.25)}
    .btn{
      appearance:none;border:none;border-radius:10px;padding:10px 12px;
      font-weight:800;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;justify-content:center
    }
    .btn-primary{background:#2d6cdf;color:#fff}
    .btn-ghost{background:#f3f4f6;color:#111827}
    .btn-dark{background:#0b1f63;color:#fff}
    .muted{color:#6b7280}
    .small{font-size:.9rem}
    #hint{margin-top:8px;font-size:.95rem}
    #hint.ok{color:#065f46}      /* verde */
    #hint.warn{color:#92400e}     /* âmbar */
    #hint.err{color:#991b1b}      /* vermelho */
    #qrBox{
      display:flex;align-items:center;justify-content:center;min-height:220px;
      background:#f9fafb;border:1px dashed #e5e7eb;border-radius:12px
    }
    .help{display:none;margin-top:8px}
    .help.show{display:block}
    .badge{font-size:.75rem;background:#eef2ff;color:#3730a3;border-radius:999px;padding:2px 8px;margin-left:6px}
    .pill{display:inline-flex;align-items:center;gap:8px;background:#eef2ff;border:1px solid #c7d2fe;color:#0b1f63;padding:6px 10px;border-radius:12px}
    .right{display:flex;gap:8px;align-items:flex-end}
    .preview{font-size:12px;color:#334155;margin-top:4px;min-height:1em}
  </style>
</head>

<body>
<header class="header" role="banner" aria-label="Cabeçalho">
  <img src="/icons/icon-192.png" alt="Autônoma.app" class="logo"/>
  <div class="brand">
    <strong>Autônoma<span class="dot">.app</span></strong>
    <span class="tag">Painel do Profissional</span>
  </div>
</header>

<main class="wrap" role="main">
  <div class="card">
    <h1 class="mt-0">Entrar no painel <span class="badge">acesso por token</span></h1>
    <p class="muted small">
      Informe seu WhatsApp (com DDD). Vamos gerar um <strong>link</strong> e um <strong>QR</strong> para criar a sessão.
      Se estiver em loop no celular, abra o link no <b>navegador padrão</b> (Chrome/Safari).
    </p>

    <div class="row" style="margin-top:8px">
      <div class="col">
        <label for="whats">WhatsApp (somente números — com ou sem 55)</label>
        <input id="whats" inputmode="numeric" autocomplete="tel" placeholder="21987654321" />
        <div id="pretty" class="preview"></div>
      </div>

      <div class="col right">
        <button id="btnLink" class="btn btn-primary" type="button">Gerar link & QR</button>
        <button id="btnEntrar" class="btn btn-ghost" type="button" title="Abrir o painel agora com o token">Entrar agora</button>
      </div>
    </div>

    <div id="hint" class="muted"></div>

    <div id="loopHelp" class="help small">
      Dica: se ao abrir o link você voltar para esta tela, pode ser bloqueio de cookies no WebView do app.
      Use o navegador (Chrome/Safari) ou abra em aba anônima.
    </div>

    <div style="margin-top:12px" class="row">
      <div class="col">
        <div id="qrBox" aria-live="polite">O QR aparecerá aqui após gerar o link.</div>
        <div class="row" style="margin-top:10px">
          <button id="btnCheck" class="btn btn-dark" type="button" title="Confere se a sessão foi criada corretamente">Verificar sessão</button>
          <button id="btnShare" class="btn btn-ghost" type="button" title="Compartilhar link" style="display:none">Compartilhar</button>
        </div>
        <p id="sessOut" class="small muted" style="margin-top:6px"></p>
      </div>
      <div class="col">
        <p class="muted small">
          Como funciona:<br/>
          1) Geramos um link para <code>/painel.html?token=SEU_WHATSAPP</code>.<br/>
          2) Abra esse link no celular onde vai usar o painel (via QR ou compartilhando/abrindo no navegador).<br/>
          3) Ao abrir, a sessão é criada e você é redirecionado para <code>/painel.html</code>.
        </p>
        <p class="muted small">
          Android: prefira abrir no <b>Chrome</b>.<br/>
          iPhone: abra no <b>Safari</b> (não dentro de outros apps).
        </p>
      </div>
    </div>
  </div>
</main>

<footer class="footer">
  <p>© 2025 Autônoma.app</p>
</footer>

<script>
(function(){
  // ---------- helpers ----------
  const $ = sel => document.querySelector(sel);
  const whatsEl = $('#whats');
  const hintEl  = $('#hint');
  const prettyEl= $('#pretty');
  const qrBox   = $('#qrBox');
  const sessOut = $('#sessOut');
  const btnShare= $('#btnShare');

  const NO_STORE = { cache:'no-store' };
  const ts = () => 'ts=' + Date.now();

  function hint(msg, tone){
    hintEl.textContent = msg;
    hintEl.classList.remove('ok','warn','err');
    if (tone) hintEl.classList.add(tone);
  }

  // normalização (front) — servidor já normaliza também
  function onlyDigits(s){ return String(s||'').replace(/\\D/g,''); }
  function ensureBR(d){
    if (!d) return '';
    if (d.startsWith('55')) return d;
    if (d.length===10 || d.length===11) return '55'+d;
    return d;
  }
  function pretty(d55){
    if(!/^\\d{12,13}$/.test(d55)) return '';
    const cc=d55.slice(0,2), ddd=d55.slice(2,4), rest=d55.slice(4);
    return rest.length===9
      ? \`+\${cc} (\${ddd}) \${rest.slice(0,5)}-\${rest.slice(5)}\`
      : \`+\${cc} (\${ddd}) \${rest.slice(0,4)}-\${rest.slice(4)}\`;
  }
  function updatePretty(){
    const raw = onlyDigits(whatsEl.value);
    const with55 = ensureBR(raw);
    const p = pretty(with55);
    prettyEl.textContent = p ? ('Formato: '+p) : '';
  }
  whatsEl.addEventListener('input', updatePretty);
  whatsEl.addEventListener('blur', updatePretty);

  function buildLink(tokenDigits){
    const base = location.origin || (location.protocol + '//' + location.host);
    return base + '/painel.html?token=' + encodeURIComponent(tokenDigits);
  }

  // ---------- QR + Link ----------
  async function gerarLinkEQR(){
    const raw = onlyDigits(whatsEl.value);
    if (!raw){
      hint('Informe seu WhatsApp com DDD.', 'warn');
      whatsEl.focus();
      return;
    }
    const link = buildLink(raw);

    // copiar link (quando possível)
    try{
      await navigator.clipboard.writeText(link);
      hint('Link copiado. Escaneie o QR ou use “Entrar agora”.', 'ok');
    }catch{
      hint('Link: ' + link, 'warn');
    }

    // QR com cache-buster
    const img = new Image();
    img.width = 220; img.height = 220; img.alt = 'QR de acesso';
    img.onload = ()=>{ qrBox.innerHTML=''; qrBox.appendChild(img); };
    img.onerror = ()=>{ qrBox.textContent='QR indisponível'; };
    img.src = '/api/qr?text=' + encodeURIComponent(link) + '&' + ts();

    // compartilhar (quando suportado)
    if (navigator.share){
      btnShare.style.display = '';
      btnShare.onclick = async ()=>{
        try{
          await navigator.share({ title:'Autônoma • Painel', text:'Acesse seu painel com este link:', url: link });
        }catch{}
      };
    }

    // salva última tentativa (só para mostrar dica)
    try{ localStorage.setItem('aut_last_token', raw); }catch{}
  }

  function entrarAgora(){
    const raw = onlyDigits(whatsEl.value);
    if (!raw){
      hint('Informe seu WhatsApp com DDD.', 'warn');
      whatsEl.focus();
      return;
    }
    try{ localStorage.setItem('aut_last_token', raw); }catch{}
    location.href = buildLink(raw); // servidor cria a sessão e redireciona para /painel.html
  }

  // ---------- Verificar sessão ----------
  async function verificarSessao(){
    sessOut.textContent = 'Verificando sessão…';
    try{
      const r = await fetch('/api/painel/me?'+ts(), NO_STORE);
      if (!r.ok){
        sessOut.textContent = 'Não logado ainda. Abra o link/QR no mesmo navegador (Chrome/Safari) e tente novamente.';
        return;
      }
      const js = await r.json();
      if (js && js.ok){
        sessOut.textContent = 'Sessão OK! Abrindo painel…';
        setTimeout(()=> location.href = '/painel.html', 400);
      }else{
        sessOut.textContent = 'Não logado ainda. Se abriu o link e voltou, pode ser bloqueio de cookies do app. Abra no navegador.';
      }
    }catch{
      sessOut.textContent = 'Falha ao verificar. Tente novamente.';
    }
  }

  // ---------- Cookies / Loop help ----------
  function testFirstPartyCookies(){
    try{
      document.cookie = 'aut_test=1; Path=/';
      const ok = document.cookie.indexOf('aut_test=1') !== -1;
      // limpa
      document.cookie = 'aut_test=; Path=/; Max-Age=0';
      return ok;
    }catch{ return false; }
  }

  function showLoopHelpIfNeeded(){
    // Dica se já tentou antes
    try{
      if(localStorage.getItem('aut_last_token')) document.getElementById('loopHelp').classList.add('show');
    }catch{}

    // Aviso se cookie 1p está bloqueado
    if (!testFirstPartyCookies()){
      hint('Seu navegador está bloqueando cookies. Abra em outro navegador ou aba anônima.', 'warn');
      document.getElementById('loopHelp').classList.add('show');
    }
  }

  // ---------- binds ----------
  document.getElementById('btnLink').addEventListener('click', gerarLinkEQR);
  document.getElementById('btnEntrar').addEventListener('click', entrarAgora);
  document.getElementById('btnCheck').addEventListener('click', verificarSessao);

  // PWA (não bloqueia)
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js?v=painel-login-2025-09-08r').catch(()=>{});
    });
  }

  // Compat: ?ok=1 -> ir para /painel (se algum fluxo antigo mandar isso)
  const params = new URLSearchParams(location.search);
  if (params.get('ok') === '1') {
    location.replace('/painel');
  }

  // start
  showLoopHelpIfNeeded();
  updatePretty();
})();
</script>
</body>
</html>