<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Perfil do Profissional ‚Ä¢ Aut√¥noma.app</title>
  <meta name="theme-color" content="#2563eb">
  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <link rel="icon" href="/favicon.ico">
  <link rel="stylesheet" href="/css/app.css?v=perfil-2025-09-08d">
  <style>
    .wrap{max-width:1120px;margin:0 auto;padding:16px}
    .header{display:flex;align-items:center;gap:12px;padding:12px 16px}
    .header .logo{height:32px;width:auto;display:block}
    .topbar-links{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:980px){ .grid{grid-template-columns: 380px 1fr} }
    .card-soft{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:14px}
    .avatar-box{display:flex;flex-direction:column;align-items:center;gap:10px}
    .avatar{width:180px;height:180px;border-radius:999px;object-fit:cover;border:1px solid #e5e7eb;background:#f8fafc}
    .nome{font-size:22px;margin:0;text-align:center}
    .serv-local{color:#64748b;text-align:center}
    .kpis{display:flex;justify-content:space-between;gap:8px;margin-top:10px}
    .kpi{flex:1;background:#f8fafc;border:1px solid #e5e7eb;border-radius:12px;padding:8px;text-align:center}
    .kpi .label{font-size:12px;color:#64748b}
    .kpi .val{font-weight:700}
    .actions{display:flex;justify-content:center;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn {border:none;background:#2563eb;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
    .btn.outline{background:transparent;border:1px solid #e5e7eb;color:#111827}
    .btn.ghost{background:#f1f5f9;color:#111827}
    .btn.small{padding:8px 10px;font-size:14px}
    .btn-wa{background:#16a34a}
    .btn-wa:hover{filter:brightness(.95)}
    .fav.on{color:#d97706;border-color:#fcd34d;background:#fff7ed}
    .rec.on{color:#0ea5e9;border-color:#bae6fd;background:#ecfeff}
    .aval.on{color:#f59e0b;border-color:#fde68a;background:#fffbeb}
    .title{margin:0 0 8px}
    .meta{color:#64748b}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .item{padding:10px;border:1px solid #e5e7eb;border-radius:12px;background:#f8fafc}
    .item strong{display:block}
    .list{display:grid;grid-template-columns:1fr;gap:8px}
    @media(min-width:720px){ .list{grid-template-columns:1fr 1fr} }
    .rating{color:#f59e0b}
    .muted{color:#64748b}
    .msg{font-size:14px}
    .msg.ok{color:#166534}
    .msg.warn{color:#b91c1c}
    footer { padding:28px 12px; background:#0b1f63; margin-top:16px }
    .foot-links { display:flex; flex-wrap:wrap; gap:12px; justify-content:center; }
    .foot-links a { color:#cde1ff; font-size:14px; text-decoration:none; }
    .foot-links a:hover { text-decoration:underline; }
  </style>
</head>
<body>
  <header class="header" role="banner">
    <a href="/" aria-label="In√≠cio">
      <img class="logo" src="/img/logo.png" alt="Aut√¥noma.app" onerror="this.style.display='none'">
    </a>
    <nav class="topbar-links" aria-label="Navega√ß√£o principal">
      <a class="btn ghost" href="/">In√≠cio</a>
      <a class="btn ghost" href="/clientes.html">Buscar</a>
      <a class="btn ghost" href="/top10.html">üèÜ Top 10</a>
      <a class="btn ghost" href="/planos.html">‚≠ê Planos</a>
      <a class="btn outline" href="/painel_login.html">üîê Entrar no Painel</a>
    </nav>
  </header>

  <main class="wrap">
    <div id="flash" class="card-soft msg" style="display:none"></div>

    <div class="grid">
      <aside class="card-soft">
        <div class="avatar-box">
          <img id="foto" class="avatar" alt="Foto do profissional">
          <h1 id="nome" class="nome">Profissional</h1>
          <div id="servLocal" class="serv-local">‚Äî</div>

          <div class="kpis">
            <div class="kpi"><div class="label">Trabalhos</div><div id="k_trab" class="val">‚Äî</div></div>
            <div class="kpi"><div class="label">Experi√™ncia</div><div id="k_exp" class="val">‚Äî</div></div>
            <div class="kpi"><div class="label">Chamadas</div><div id="k_calls" class="val">‚Äî</div></div>
            <div class="kpi"><div class="label">Visitas</div><div id="k_vis" class="val">‚Äî</div></div>
          </div>

          <div class="actions">
            <a id="btnWa" class="btn btn-wa" target="_blank" rel="noopener">WhatsApp</a>
            <button id="btnFav" class="btn outline fav"><span>‚òÖ</span> Favoritar</button>
            <button id="btnRec" class="btn outline rec">üëç Recomendar</button>
            <a id="btnAval" class="btn outline aval" href="#" rel="nofollow">‚≠ê Avaliar</a>
          </div>
          <p id="msgActions" class="msg" style="text-align:center;margin-top:6px"></p>
        </div>
      </aside>

      <section class="card-soft">
        <h2 class="title">Sobre o profissional</h2>

        <div class="list" style="margin-bottom:10px">
          <div class="item"><span class="muted">Pre√ßo base</span><strong id="precoBase">‚Äî</strong></div>
          <div class="item"><span class="muted">Site/Cat√°logo</span><strong><a id="site" href="#" target="_blank" rel="noopener">‚Äî</a></strong></div>
          <div class="item"><span class="muted">Dist√¢ncia</span><strong id="dist">‚Äî</strong></div>
          <div class="item"><span class="muted">Avalia√ß√£o</span><strong><span id="stars" class="rating">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</span> <span id="count" class="muted"></span></strong></div>
        </div>

        <div class="item" style="margin-bottom:10px">
          <span class="muted">Descri√ß√£o</span>
          <p id="desc" style="margin:6px 0 0">‚Äî</p>
        </div>

        <h3 class="title">Avalia√ß√µes</h3>
        <div id="reviews" class="list"></div>
        <p id="diag" class="meta" style="display:none"></p>
      </section>
    </div>
  </main>

  <footer>
    <nav class="foot-links" aria-label="Links do rodap√©">
      <a href="/termos.html">Termos</a>
      <a href="/privacidade.html">Privacidade</a>
      <a href="/top10.html">Top 10</a>
      <a href="/planos.html">Planos</a>
      <a href="/politica-de-seguranca.html">Seguran√ßa</a>
      <a href="/favoritos.html">Favoritos</a>
    </nav>
  </footer>

  <script>
  (function(){
    const DEBUG = false;
    const $ = s => document.querySelector(s);
    const esc = s => String(s||"").replace(/[&<>"]/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));
    const kmFmt = d => (d==null ? "‚Äî" : (d<1 ? `${(d*1000).toFixed(0)} m` : `${Number(d).toFixed(d<10?1:0)} km`));
    const stars = n => { const r=Math.round((Number(n)||0)*2)/2; const f=Math.floor(r),h=(r%1!==0); return "‚òÖ".repeat(f)+(h?"¬Ω":"")+"‚òÜ".repeat(5-f-(h?1:0)); };
    const setDiag = t => { if(!DEBUG) return; const d=$('#diag'); d.style.display=''; d.textContent = t; };

    async function getJSON(url){
      const r = await fetch(url,{cache:'no-store'});
      if(!r.ok) throw new Error('http '+r.status+' @ '+url);
      return r.json();
    }

    function getProfileId(){
      const url = new URL(location.href);
      const qid = url.searchParams.get('id');
      if (qid) return qid;
      const parts = location.pathname.split('/').filter(Boolean);
      const i = parts.indexOf('profissional');
      if (i>=0 && parts[i+1]) return parts[i+1];
      return '';
    }
    const id = getProfileId();
    if(!id){ location.href = '/clientes.html'; }

    // Favoritos
    const KEY_FAVS='autonoma_favs';
    const getFavs=()=>{ try{return JSON.parse(localStorage.getItem(KEY_FAVS)||'[]')}catch{return[]} };
    const setFavs=v=>{ try{localStorage.setItem(KEY_FAVS, JSON.stringify(v||[]))}catch{} };
    const isFav=pid=> getFavs().some(x=> String(x?.id)===String(pid));
    function upsertFav(obj){
      const arr=getFavs();
      const i=arr.findIndex(x=>String(x?.id)===String(obj.id));
      if(i>=0) arr[i]={...arr[i],...obj}; else arr.push(obj);
      setFavs(arr);
    }
    function removeFav(pid){ setFavs(getFavs().filter(x=> String(x?.id)!==String(pid))); }

    // Dist√¢ncia
    function haversineKm(lat1, lon1, lat2, lon2){
      const toRad = x => x*Math.PI/180, R=6371, dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }
    function tryClientDistance(p){
      if(!(p && typeof p.lat==='number' && typeof p.lng==='number')) return;
      if(!('geolocation' in navigator)) return;
      navigator.geolocation.getCurrentPosition((pos)=>{
        const km = haversineKm(pos.coords.latitude, pos.coords.longitude, p.lat, p.lng);
        $('#dist').textContent = kmFmt(km);
      }, ()=>{}, {enableHighAccuracy:true, timeout:10000, maximumAge:30000});
    }

    // WhatsApp
    function buildWaLink(p){
      if(!p || !p.whatsapp) return null;
      const d = String(p.whatsapp).replace(/\D/g,'');
      const num = d.startsWith('55') ? d : ('55'+d);
      const partes = ['Ol√°, vi seu perfil no Aut√¥noma.app'];
      const svc = p.servico || p.profissao;
      partes.push(svc ? `e gostaria de contratar seus servi√ßos de ${svc}` : 'e gostaria de contratar seus servi√ßos');
      if (p.cidade) partes.push(`em ${p.cidade}`);
      const msg = partes.join(' ')+'. Podemos conversar?';
      return `https://wa.me/${num}?text=${encodeURIComponent(msg)}`;
    }
    function buildAvalLink(pid){ return '/avaliar/'+encodeURIComponent(pid); }
    function logCall(pid){ try{ navigator.sendBeacon?.(`/api/profissional/${encodeURIComponent(pid)}/call`); }catch(_){} }

    // Perfil
    async function loadProfile(pid){
      const tries = [
        `/api/profissional/${encodeURIComponent(pid)}`,
        `/api/profissionais?id=${encodeURIComponent(pid)}`,
        `/api/public/profissional?id=${encodeURIComponent(pid)}`
      ];
      for(const u of tries){
        try{
          const js = await getJSON(u);
          if (js?.item) return js.item;
          if (js && (js.id!=null || js.nome)) return js;
        }catch(e){ setDiag('Perfil: '+e.message); }
      }
      try{
        const list = await getJSON('/api/profissionais');
        const arr = list.items || list.itens || list || [];
        const found = arr.find(x=> String(x?.id)===String(pid));
        if(found) return found;
      }catch(e){ setDiag('Perfil fallback: '+e.message); }
      throw new Error('notfound');
    }

    // Avalia√ß√µes
    function pickInlineReviews(p){
      const cands = [
        p.avaliacoesDetalhe, p.avaliacoesDetalhadas, p.comentarios, p.reviews, p.feedbacks
      ].filter(Array.isArray);
      if (cands.length) return cands[0];
      return [];
    }
    async function fetchReviews(pid){
      const tries = [
        `/api/profissional/${encodeURIComponent(pid)}/avaliacoes`,
        `/api/avaliacoes?proId=${encodeURIComponent(pid)}`,
        `/api/public/avaliacoes?proId=${encodeURIComponent(pid)}`,
        `/api/reviews?proId=${encodeURIComponent(pid)}`,
        `/api/profissionais/${encodeURIComponent(pid)}/avaliacoes`
      ];
      for(const u of tries){
        try{
          const js = await getJSON(u);
          if (Array.isArray(js)) return js;
          if (Array.isArray(js?.items)) return js.items;
          if (Array.isArray(js?.avaliacoes)) return js.avaliacoes;
          if (Array.isArray(js?.data)) return js.data;
        }catch(e){ setDiag('Avalia√ß√µes: '+e.message); }
      }
      return [];
    }
    function normalizeAval(a){
      const nome = a.autor || a.nome || a.cliente || a.user || 'Cliente';
      const nota = a.nota ?? a.rating ?? a.estrelas ?? a.score ?? 0;
      const texto = a.texto || a.comentario || a.comment || a.mensagem || '';
      return { nome:String(nome), nota:Number(nota), texto:String(texto) };
    }
    function renderAvaliacoes(list){
      const box = $('#reviews');
      const norm = list.map(normalizeAval).filter(x => (x.texto||'').trim().length>0 || x.nota>0);
      if (norm.length){
        box.innerHTML = norm.slice(0,20).map(a=>`
          <div class="item">
            <div class="row" style="justify-content:space-between">
              <strong>${esc(a.nome)}</strong>
              <span class="rating">${stars(a.nota)}</span>
            </div>
            ${a.texto?`<p class="meta" style="margin:6px 0 0">${esc(a.texto)}</p>`:''}
          </div>
        `).join('');
        return;
      }
      box.innerHTML = '';
    }

    let PROF=null;
    async function init(){
      try{
        PROF = await loadProfile(id);

        $('#foto').src = PROF.foto || '/icons/icon-192.png';
        $('#foto').alt = 'Foto de ' + (PROF.nome || 'Profissional');
        $('#nome').textContent = PROF.nome || 'Profissional';
        $('#servLocal').textContent =
          [PROF.servico || PROF.profissao, [PROF.bairro, PROF.cidade].filter(Boolean).join(' ‚Ä¢ ')]
          .filter(Boolean).join(' ‚Ä¢ ') || '‚Äî';

        $('#k_trab').textContent = Number(PROF.trabalhos||PROF.atendimentos||0);
        $('#k_exp').textContent  = computeExperience(PROF);
        $('#k_calls').textContent= Number(PROF.chamadas||0);
        $('#k_vis').textContent  = Number(PROF.visitas||0);

        $('#precoBase').textContent = PROF.precoBase ? String(PROF.precoBase) : '‚Äî';
        if(PROF.site){ $('#site').textContent=PROF.site; $('#site').href=PROF.site; }
        else { $('#site').textContent='‚Äî'; $('#site').removeAttribute('href'); }

        $('#dist').textContent = kmFmt(PROF.distanceKm);
        if (PROF.distanceKm == null) tryClientDistance(PROF);

        const ratingNum = Number(PROF.rating||0);
        $('#stars').textContent = stars(ratingNum);
        const avalCount = Array.isArray(PROF.avaliacoes) ? PROF.avaliacoes.length : Number(PROF.avaliacoes||0);
        $('#count').textContent = `(${isNaN(avalCount)?0:avalCount})`;

        $('#desc').textContent = PROF.descricao || '‚Äî';

        const wa = buildWaLink(PROF);
        const waBtn = $('#btnWa');
        if(wa){ waBtn.href = wa; waBtn.addEventListener('click', ()=> logCall(id)); }
        else { waBtn.classList.add('outline'); waBtn.textContent='WhatsApp indispon√≠vel'; waBtn.removeAttribute('href'); }

        $('#btnAval').href = buildAvalLink(id);

        if (isFav(id)) $('#btnFav').classList.add('on');

        const inline = pickInlineReviews(PROF);
        if (inline.length){
          renderAvaliacoes(inline);
        } else {
          const fetched = await fetchReviews(id);
          renderAvaliacoes(fetched);
        }
      }catch(e){
        const box = document.getElementById('flash');
        box.textContent = 'N√£o foi poss√≠vel carregar o perfil.';
        box.className='card-soft msg warn';
        box.style.display='';
        setDiag('Init erro: '+e.message);
      }
    }

    function computeExperience(p){
      if (p.experiencia && typeof p.experiencia === 'string') return p.experiencia;
      const n = Number(p.experienciaAnos ?? p.anosExp ?? p.exp ?? p.anos);
      if (!isNaN(n) && n>0) return n + (n>1 ? ' anos' : ' ano');
      const start = Number(p.inicioAno || p.anoInicio || p.desde);
      const now = new Date().getFullYear();
      if(!isNaN(start) && start>1900 && start<=now){
        const y = now - start;
        return y + (y!==1 ? ' anos' : ' ano');
      }
      return '‚Äî';
    }

    document.getElementById('btnFav').addEventListener('click', ()=>{
      const on = isFav(id);
      if (on){
        removeFav(id);
        document.getElementById('btnFav').classList.remove('on');
        document.getElementById('msgActions').textContent = 'Removido dos favoritos.';
        document.getElementById('msgActions').className = 'msg ok';
      } else {
        const obj = {
          id: PROF?.id || id, nome: PROF?.nome || 'Profissional',
          servico: PROF?.servico || PROF?.profissao || '',
          bairro: PROF?.bairro || '', cidade: PROF?.cidade || '',
          local: [PROF?.bairro, PROF?.cidade].filter(Boolean).join(' ‚Ä¢ '),
          whatsapp: PROF?.whatsapp || '', foto: PROF?.foto || '',
          rating: Number(PROF?.rating||0), atendimentos: Number(PROF?.atendimentos||0),
          distanceKm: (typeof PROF?.distanceKm==='number') ? PROF.distanceKm : null
        };
        upsertFav(obj);
        document.getElementById('btnFav').classList.add('on');
        document.getElementById('msgActions').textContent = 'Adicionado aos favoritos.';
        document.getElementById('msgActions').className = 'msg ok';
      }
    });

    document.getElementById('btnRec').addEventListener('click', async ()=>{
      document.getElementById('btnRec').classList.add('on');
      document.getElementById('msgActions').textContent = 'Obrigado! Recomenda√ß√£o registrado.';
      document.getElementById('msgActions').className = 'msg ok';
      try{
        await fetch('/api/recomendacoes',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id}) });
      }catch(_){}
    });

    init();
  })();
  </script>
</body>
</html>