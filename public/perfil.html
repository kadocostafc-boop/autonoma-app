<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Perfil do Profissional ‚Äî Aut√¥noma</title>

  <link rel="stylesheet" href="/public.css.global.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>

<header>
  <div class="container header-content">
    <a href="/" class="logo">Aut√¥noma</a>
    <a href="/Painel-login.html" class="btn btn-outline">Sou Profissional</a>
  </div>
</header>

<section class="container" id="perfil"></section>

<section class="container" style="margin-top:2rem;">
  <h2>Avalia√ß√µes</h2>
  <div id="avaliacoes" class="grid grid-2"></div>
</section>

<footer>
  ¬© 2026 Aut√¥noma.app ‚Äî Todos os direitos reservados
</footer>

<script>
  const params = new URLSearchParams(window.location.search)
  const id = params.get('id')

  let userLat = null
  let userLng = null

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      userLat = pos.coords.latitude
      userLng = pos.coords.longitude
      carregarPerfil()
    }, carregarPerfil)
  } else {
    carregarPerfil()
  }

  async function carregarPerfil() {
    const res = await fetch(`/api/profissionais/${id}?lat=${userLat}&lng=${userLng}`)
    const data = await res.json()

    if (!data.ok) {
      document.getElementById('perfil').innerHTML = '<p>Profissional n√£o encontrado.</p>'
      return
    }

    const p = data.profissional

    document.getElementById('perfil').innerHTML = `
      <div class="card">
        <div class="card-header">
          <img src="${p.foto || '/img/user.png'}" style="width:90px;height:90px;border-radius:50%;">
          <div>
            <h1>${p.nome}</h1>
            <p>${p.servicos.join(', ')}</p>
            <p style="color:#6b7280;">${p.cidade} - ${p.estado}</p>
            ${p.verificado ? '<span class="badge badge-verificado">‚úî Verificado</span>' : ''}
          </div>
        </div>

        <div style="margin-top:1rem;">
          <span class="stars">‚≠ê ${p.avaliacao}</span>
          <span style="margin-left:0.5rem;">(${p.totalAvaliacoes} avalia√ß√µes)</span>
        </div>

        <div style="margin-top:0.5rem;">
          üìç ${p.distanciaKm ? p.distanciaKm.toFixed(1) + ' km de voc√™' : ''}
        </div>

        <div style="margin-top:1rem; display:flex; flex-wrap:wrap; gap:0.5rem;">
          <a class="btn btn-primary" target="_blank" href="https://wa.me/55${p.whatsapp}">
            WhatsApp
          </a>

          <a class="btn btn-outline" href="/avaliar.html?id=${p.id}">
            Avaliar
          </a>

          <a class="btn btn-outline" href="/denunciar.html?id=${p.id}">
            Denunciar
          </a>

          <button class="btn btn-secondary" onclick="recomendar()">
            Recomendar
          </button>
        </div>

        <div style="margin-top:1rem;">
          ${p.plano !== 'FREE' ? '<span class="badge badge-premium">Profissional em destaque</span>' : ''}
        </div>
      </div>
    `

    carregarAvaliacoes(p.id)
  }

  async function carregarAvaliacoes(id) {
    const res = await fetch(`/api/avaliacoes?profissionalId=${id}`)
    const data = await res.json()

    const container = document.getElementById('avaliacoes')
    container.innerHTML = ''

    if (!data.ok || data.avaliacoes.length === 0) {
      container.innerHTML = '<p>Este profissional ainda n√£o possui avalia√ß√µes.</p>'
      return
    }

    data.avaliacoes.forEach(a => {
      const div = document.createElement('div')
      div.className = 'card'
      div.innerHTML = `
        <strong>‚≠ê ${a.nota}</strong>
        <p style="margin-top:0.5rem;">${a.comentario}</p>
        <small style="color:#6b7280;">${new Date(a.criadoEm).toLocaleDateString()}</small>
      `
      container.appendChild(div)
    })
  }

  function recomendar() {
    alert('Link copiado! Envie para um amigo recomendar este profissional.')
    navigator.clipboard.writeText(window.location.href)
  }
</script>

</body>
</html>