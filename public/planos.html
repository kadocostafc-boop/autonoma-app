<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Planos ‚Ä¢ Aut√¥noma.app</title>

  <!-- SEO b√°sico -->
  <link rel="canonical" href="/planos.html">
  <meta name="description" content="Compare os planos Free, Pro e Premium da Aut√¥noma.app. Ative Radar (tempo real), defina raio de atendimento, ganhe destaque e m√©tricas.">
  <meta name="theme-color" content="#2563eb">

  <!-- PWA + Favicons -->
  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <link rel="icon" href="/favicon.ico">

  <!-- CSS global -->
  <link rel="stylesheet" href="/css/global.css">
  <style>
    .wrap-narrow{max-width:1080px;margin:auto}
    .center{text-align:center}
    .hero h1{margin:8px 0 6px}
    .hero p{margin:0;color:#64748b}
    .grid-plans{ display:grid;gap:14px;grid-template-columns:1fr; margin-top:14px }
    @media(min-width: 900px){ .grid-plans{ grid-template-columns: 1fr 1fr 1fr; } }
    .plan{ border:1px solid #e5e7eb; border-radius:16px; padding:16px; background:#fff; display:flex; flex-direction:column; gap:10px; }
    .plan.pop{ border-color:#2563eb; box-shadow:0 6px 30px rgba(37,99,235,.12) }
    .tag{font-size:12px;padding:3px 8px;border-radius:999px;border:1px solid #e5e7eb;background:#f1f5f9;display:inline-block}
    .price{font-size:28px; font-weight:800}
    .price small{font-size:14px; color:#64748b; font-weight:600}
    .features{display:flex;flex-direction:column;gap:6px}
    .features li{list-style:none; display:flex; gap:8px; align-items:flex-start}
    .features li .ok{background:#ecfccb;border:1px solid #bbf7d0;border-radius:8px;padding:2px 6px;font-size:12px}
    .muted{color:#64748b}
    .disclaimer{font-size:12px;color:#64748b}
    .compare{overflow:auto}
    table.compare{width:100%; border-collapse:collapse}
    .compare th,.compare td{border:1px solid #e5e7eb; padding:10px; text-align:center}
    .compare th{background:#f8fafc}
    .cta-box{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
  </style>
</head>
<body>
  <!-- Header simples -->
  <header class="header" role="banner">
    <a href="/" aria-label="In√≠cio"><img class="logo" src="/img/logo.png" alt="Aut√¥noma.app" onerror="this.style.display='none'"></a>
    <nav style="margin-left:auto;display:flex;gap:8px;flex-wrap:wrap">
      <a class="btn ghost" href="/clientes.html">Buscar</a>
      <a class="btn ghost" href="/cadastro.html">Sou profissional</a>
      <a class="btn outline" href="/top10.html">Top 10</a>
      <a class="btn" href="/painel_login.html">Entrar no painel</a>
    </nav>
  </header>

  <main class="wrap wrap-narrow" role="main">
    <!-- Hero -->
    <section class="card hero center">
      <h1 class="mt-0">Planos de Assinatura</h1>
      <p>Escolha o plano ideal para crescer sua presen√ßa e fechar mais servi√ßos.</p>
      <div class="cta-box" style="margin-top:10px">
        <a class="btn" href="/painel_login.html">Entrar no painel</a>
        <a class="btn outline" href="/cadastro.html">Come√ßar gr√°tis</a>
      </div>
    </section>

    <!-- Cards -->
    <section class="grid-plans">
      <!-- Free -->
      <article class="plan">
        <div class="row">
          <strong>üÜì Free (B√°sico)</strong>
          <span class="tag">Sem custo</span>
        </div>
        <div class="price">R$ 0,00 <small>/ m√™s</small></div>
        <ul class="features">
          <li>‚Ä¢ Cadastro simples no app</li>
          <li>‚Ä¢ Perfil nas buscas locais (1 cidade + 1 bairro fixos)</li>
          <li>‚Ä¢ Avalia√ß√µes e contato por WhatsApp</li>
          <li class="muted">‚Ä¢ Sem destaque, sem m√©tricas</li>
        </ul>
        <div class="cta-box">
          <a class="btn outline" href="/cadastro.html">Usar Free</a>
        </div>
      </article>

      <!-- Pro -->
      <article class="plan pop">
        <div class="row">
          <strong>üíº Pro</strong>
          <span class="tag">Mais escolhido</span>
        </div>
        <div class="price">R$ 29,90 <small>/ m√™s</small></div>
        <ul class="features">
          <li>‚Ä¢ Tudo do Free</li>
          <li>‚Ä¢ Raio de atendimento at√© <strong>30km</strong></li>
          <li>‚Ä¢ At√© <strong>3 cidades extras</strong></li>
          <li>‚Ä¢ Destaque leve na busca</li>
          <li>‚Ä¢ Relat√≥rios b√°sicos (visitas e contatos)</li>
          <li>‚Ä¢ <strong>Radar</strong> (tempo real): at√© <strong>5 ativa√ß√µes/m√™s</strong></li>
        </ul>
        <div class="cta-box">
          <!-- alterado: chama JS (se n√£o logado, redireciona pro painel) -->
          <button class="btn" onclick="assinarPlano('pro')">Assinar Pro</button>
          <a class="btn ghost" href="/planos.html#comparar">Comparar</a>
        </div>
      </article>

      <!-- Premium -->
      <article class="plan">
        <div class="row">
          <strong>‚≠ê Premium</strong>
          <span class="tag">Para quem quer prioridade</span>
        </div>
        <div class="price">R$ 49,90 <small>/ m√™s</small></div>
        <ul class="features">
          <li>‚Ä¢ Tudo do Pro</li>
          <li>‚Ä¢ <strong>Radar ilimitado</strong> (tempo real)</li>
          <li>‚Ä¢ Prioridade m√°xima na busca</li>
          <li>‚Ä¢ Selo <strong>Profissional Premium</strong> e visual de destaque</li>
          <li>‚Ä¢ Relat√≥rios avan√ßados (chamadas, QR, visitas, den√∫ncias, engajamento)</li>
          <li>‚Ä¢ Eleg√≠vel ao <strong>Top 10</strong> da semana</li>
        </ul>
        <div class="cta-box">
          <!-- alterado: chama JS (se n√£o logado, redireciona pro painel) -->
          <button class="btn" onclick="assinarPlano('premium')">Assinar Premium</button>
          <a class="btn ghost" href="/planos.html#comparar">Comparar</a>
        </div>
      </article>
    </section>

    <!-- Aviso de taxas / pagamento via app -->
    <section class="card">
      <h2 class="mt-0">Pagamentos pelo app (opcional)</h2>
      <p class="meta">Se optar por receber pelo app (Pix, Cr√©dito/D√©bito), a Aut√¥noma ret√©m <strong>4%</strong> por transa√ß√£o para opera√ß√£o e suporte. O repasse ao profissional segue o prazo do m√©todo escolhido.</p>
      <div class="cta-box" style="margin-top:6px">
        <a class="btn outline" href="/checkout.html">Entender como funciona</a>
      </div>
    </section>

    <!-- Comparador -->
    <section class="card compare" id="comparar">
      <h2 class="mt-0">Comparar planos</h2>
      <table class="compare">
        <thead>
          <tr>
            <th>Recurso</th>
            <th>Free</th>
            <th>Pro</th>
            <th>Premium</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>Presen√ßa nas buscas</td><td>Local (1 bairro/cidade)</td><td>Destaque leve</td><td>Prioridade m√°xima</td></tr>
          <tr><td>Raio de atendimento</td><td>‚Äî</td><td>At√© 30km</td><td>At√© 50km</td></tr>
          <tr><td>Cidades extras</td><td>‚Äî</td><td>At√© 3</td><td>At√© 10</td></tr>
          <tr><td>Radar (tempo real)</td><td>‚Äî</td><td>5 ativa√ß√µes/m√™s</td><td>Ilimitado</td></tr>
          <tr><td>M√©tricas</td><td>‚Äî</td><td>B√°sicas</td><td>Avan√ßadas</td></tr>
          <tr><td>Top 10</td><td>‚Äî</td><td>‚Äî</td><td>Eleg√≠vel</td></tr>
        </tbody>
      </table>
      <p class="disclaimer" style="margin-top:8px">
        Valores podem ser ajustados no lan√ßamento oficial. Recursos sujeitos a disponibilidade regional.
      </p>
    </section>

    <!-- CTA final -->
    <section class="card center">
      <div class="cta-box">
        <a class="btn" href="/painel_login.html">Entrar no painel</a>
        <a class="btn outline" href="/cadastro.html">Cadastrar gr√°tis</a>
      </div>
    </section>

    <!-- Rodap√© -->
    <div class="foot">
      <a href="/clientes.html">In√≠cio</a><span>‚Ä¢</span>
      <a href="/favoritos.html">Favoritos</a><span>‚Ä¢</span>
      <a href="/cadastro.html">Sou profissional</a><span>‚Ä¢</span>
      <a href="/top10.html">Top 10</a><span>‚Ä¢</span>
      <a href="/termos-de-uso.html">Termos</a><span>‚Ä¢</span>
      <a href="/politica-de-privacidade.html">Privacidade</a>
    </div>
  </main>

  <script>
    // Constantes de planos
    const PLAN_PRICES = { pro: 29.90, premium: 49.90 };
    const PLAN_BENEFITS = {
      free: { destaque: false, raioKm: 0, cidadesExtras: 3, fotosMax: 1, leadsMax: 3, metricas: false, top10: false },
      pro: { destaque: 'medium', raioKm: 30, cidadesExtras: 5, fotosMax: 5, leadsMax: 15, metricas: 'basic', top10: false },
      premium: { destaque: 'high', raioKm: 50, cidadesExtras: 10, fotosMax: 10, leadsMax: -1, metricas: 'advanced', top10: true }
    };

    // Mant√©m inten√ß√£o de plano quando o usu√°rio vem por ?plan=pro|premium
    const u = new URL(location.href);
    const planIntent = (u.searchParams.get('plan')||'').toLowerCase();
    if (planIntent === 'pro' || planIntent === 'premium'){
      try { localStorage.setItem('intent.plan', planIntent); } catch(_){}
    }

    // Helpers
    function digits(s){ return String(s||'').replace(/\D/g,''); }

    // Carregar status do plano atual
    async function loadCurrentPlanStatus() {
      try {
        const response = await fetch('/api/plano/status');
        const data = await response.json();
        if (data.ok) {
          displayCurrentPlanInfo(data);
        }
      } catch (error) {
        console.error('Erro ao carregar status do plano:', error);
      }
    }

    function displayCurrentPlanInfo(data) {
      const section = document.querySelector('.card.hero');
      if (!section) return;
      
      const planName = data.plano.charAt(0).toUpperCase() + data.plano.slice(1);
      const statusText = data.statusAssinatura === 'ativa' ? '‚úÖ Ativo' : '‚è∏Ô∏è Inativo';
      const expiryText = data.validadePlano ? new Date(data.validadePlano).toLocaleDateString('pt-BR') : '-';
      
      const infoHTML = `
        <div style="margin-top: 16px; padding: 12px; background: #f1f5f9; border-radius: 8px; font-size: 14px;">
          <strong>Seu plano atual:</strong> ${planName} | ${statusText} | V√°lido at√©: ${expiryText}
          ${data.plano !== 'free' && data.statusAssinatura === 'ativa' ? `
            <button class="btn ghost" style="margin-left: 8px;" onclick="cancelarPlano()">Cancelar</button>
          ` : ''}
        </div>
      `;
      section.insertAdjacentHTML('beforeend', infoHTML);
    }

    // Fluxo de assinatura (atualizado)
    async function assinarPlano(plan){ // 'pro' | 'premium'
      try {
        // se n√£o estiver logado, manda para o login mantendo inten√ß√£o
        if (!window.PRO_ID) {
          try { localStorage.setItem('intent.plan', plan); } catch(_){}
          location.href = '/painel_login.html?plan='+encodeURIComponent(plan);
          return;
        }

        // dados do profissional logado
        const proId       = window.PRO_ID;
        const name        = window.PRO_NAME;
        const email       = window.PRO_EMAIL;
        const mobilePhone = digits(window.PRO_WHATSAPP_DIGITOS||'');

        if(!proId || !name || !email){
          alert('Complete seu perfil com nome e e-mail para assinar.');
          return;
        }

        // Usar nova rota de checkout
        const checkoutRes = await fetch('/api/pay/asaas/checkout', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ plan })
        });
        const checkoutData = await checkoutRes.json();

        if (!checkoutData.ok) {
          alert('Falha ao criar checkout: ' + (checkoutData.error || ''));
          return;
        }

        if (checkoutData.redirectUrl) {
          window.location.href = checkoutData.redirectUrl;
        } else {
          alert('Assinatura criada. Aguarde a fatura aparecer.');
        }
      } catch(e){
        console.error(e);
        alert('Erro inesperado. Tente novamente.');
      }
    }

    // Cancelar assinatura
    async function cancelarPlano() {
      if (!confirm('Tem certeza que deseja cancelar sua assinatura? Voc√™ voltar√° ao plano Free.')) {
        return;
      }

      try {
        const response = await fetch('/api/plano/cancelar', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'}
        });
        const data = await response.json();

        if (data.ok) {
          alert('Assinatura cancelada com sucesso!');
          location.reload();
        } else {
          alert('Erro ao cancelar: ' + (data.error || ''));
        }
      } catch (error) {
        console.error('Erro ao cancelar:', error);
        alert('Erro ao processar cancelamento');
      }
    }

    // Carregar status ao abrir a p√°gina
    document.addEventListener('DOMContentLoaded', loadCurrentPlanStatus);
  </script>
</body>
</html>