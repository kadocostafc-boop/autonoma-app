<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Meus Favoritos ‚Ä¢ Aut√¥noma.app</title>

  <!-- Canonical + SEO -->
  <link rel="canonical" href="https://autonomaapp.com.br/favoritos.html">
  <meta name="description" content="Perfis salvos neste dispositivo. Acesse rapidamente seus profissionais favoritos e compartilhe com amigos.">

  <!-- PWA / Favicons -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#0b49c8">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16.png">

  <!-- CSS global -->
  <link rel="stylesheet" href="/css/app.css?v=favs-ios-2025-09-07">
  <style>
    :root{
      --azul-escuro:#0b1f63;
      --azul-brilho:#2D81FF;
      --borda:#e5e7eb;
      --cinza:#64748b;
    }
    /* Cabe√ßalho */
    .header{ background:var(--azul-escuro); padding:12px 16px; display:flex; gap:8px; align-items:center; justify-content:flex-end }
    .nav-btn{ appearance:none; border:none; cursor:pointer; background:var(--azul-brilho); color:#fff; font-weight:800; padding:8px 12px; border-radius:10px; text-decoration:none; font-size:14px; display:inline-flex; align-items:center; justify-content:center }
    .nav-btn:hover{ filter:brightness(.96) }
    .wrap{ max-width:1120px; margin:0 auto; padding:16px; }

    /* Grid + Card (iOS) */
    .grid{ display:grid; gap:12px; grid-template-columns:1fr }
    @media (min-width:720px){ .grid{ grid-template-columns:1fr 1fr } }
    @media (min-width:1100px){ .grid{ grid-template-columns:1fr 1fr 1fr } }
    @media (min-width:1400px){ .grid{ grid-template-columns:1fr 1fr 1fr 1fr } }

    .pro-card{
      background:#fff; border:1px solid var(--borda); border-radius:16px; padding:12px;
      display:flex; align-items:center; gap:12px; box-shadow:0 6px 16px rgba(0,0,0,.06);
      transition:transform .16s ease, box-shadow .16s ease;
    }
    .pro-card:hover{ transform:translateY(-1px); box-shadow:0 10px 22px rgba(0,0,0,.09) }
    .pro-avatar{ width:56px; height:56px; border-radius:999px; object-fit:cover; border:1px solid var(--borda); background:#f8fafc; flex:0 0 56px }
    .pro-main{ flex:1 1 auto; min-width:0 }
    .pro-name{ margin:0; font-size:16px; font-weight:900; color:#0f172a; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
    .pro-sub{ margin:2px 0 0; font-size:13px; color:var(--cinza) }
    .rating{ color:#f59e0b; font-size:13px }
    .right{ text-align:right; min-width:110px; display:flex; flex-direction:column; gap:6px; align-items:flex-end }
    .chip{ font-size:12px; padding:3px 8px; border-radius:999px; border:1px solid var(--borda); background:#f8fafc; color:#0f172a }
    .chip.blue{ background:#eef2ff; border-color:#c7d2fe }
    .chip.green{ background:#ecfccb; border-color:#bbf7d0 }
    .chip.yellow{ background:#fffbeb; border-color:#fde68a }
    .btn.icon{ display:inline-flex; align-items:center; gap:6px }

    .card{ background:#fff; border:1px solid var(--borda); border-radius:16px; padding:14px; }
    .meta{ color:#64748b }
    .row{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center }

    footer { padding:28px 12px; background:#0b1f63; margin-top:16px }
    .foot-links { display:flex; flex-wrap:wrap; gap:12px; justify-content:center }
    .foot-links a { color:#cde1ff; font-size:14px; text-decoration:none }
    .foot-links a:hover { text-decoration:underline }
  </style>
</head>
<body>
<header class="header" role="banner">
  <a class="nav-btn" href="/">In√≠cio</a>
  <a class="nav-btn" href="/clientes.html">Buscar</a>
  <a class="nav-btn" href="/top10.html">Top 10</a>
</header>

<div class="wrap">
  <div class="card" style="text-align:center">
    <h1 style="margin:0">Meus Favoritos</h1>
    <p class="meta">Perfis salvos neste dispositivo para acesso r√°pido.</p>
    <div class="row" style="gap:8px; flex-wrap:wrap">
      <button id="btnShareAll" class="nav-btn" type="button" style="background:#fff;color:#0f172a;border:1px solid var(--borda)">üîó Compartilhar lista</button>
      <button id="btnClear" class="nav-btn" type="button" style="background:#fff;color:#0f172a;border:1px solid var(--borda)">üóëÔ∏è Limpar todos</button>
    </div>
  </div>

  <div id="list" class="grid" aria-live="polite"></div>
  <div id="empty" class="card meta" style="display:none">Voc√™ ainda n√£o adicionou favoritos.</div>

  <!-- Rodap√© organizado -->
  <div class="card" style="text-align:center">
    <div class="row" style="justify-content:center; gap:8px; flex-wrap:wrap">
      <a class="nav-btn" href="/">In√≠cio</a>
      <a class="nav-btn" href="/clientes.html">Buscar</a>
      <a class="nav-btn" href="/top10.html">Top 10</a>
      <a class="nav-btn" href="/planos.html">Planos</a>
      <a class="nav-btn" href="/termos-de-uso.html" style="background:#fff;color:#0f172a;border:1px solid var(--borda)">Termos</a>
      <a class="nav-btn" href="/politica-de-privacidade.html" style="background:#fff;color:#0f172a;border:1px solid var(--borda)">Privacidade</a>
    </div>
  </div>
</div>

<script>
(function(){
  const list = document.getElementById('list');
  const empty = document.getElementById('empty');
  const BTN_SHARE_ALL = document.getElementById('btnShareAll');
  const BTN_CLEAR = document.getElementById('btnClear');

  const KEY_NEW = 'autonoma_favs';
  const KEY_OLD = 'favIds';
  const NO_STORE = { cache:'no-store' };

  const esc = (s)=> String(s||'')
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
  const estrelas = (n)=>{ const r=Math.round((Number(n||0))*2)/2; const f=Math.floor(r),h=(r%1!==0); return '‚òÖ'.repeat(f)+(h?'¬Ω':'')+'‚òÜ'.repeat(5-f-(h?1:0)); };
  const kmFmt = (d)=> (d==null ? "‚Äî" : (d<1 ? `${(d*1000).toFixed(0)} m` : `${Number(d).toFixed(d<10?1:0)} km`));

  // Migra√ß√£o autom√°tica favIds -> autonoma_favs
  function migrateFavsIfNeeded(){
    try{
      const hasNew = !!localStorage.getItem(KEY_NEW);
      const oldRaw = localStorage.getItem(KEY_OLD);
      if (!hasNew && oldRaw){
        let oldArr = [];
        try { oldArr = JSON.parse(oldRaw) || []; } catch { oldArr = []; }
        const norm = oldArr.map(v => (v && typeof v === 'object') ? v : ({ id: v }));
        localStorage.setItem(KEY_NEW, JSON.stringify(norm));
      }
    }catch{}
  }
  function getFavs(){
    try{
      const raw = localStorage.getItem(KEY_NEW) || '[]';
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    }catch{ return []; }
  }
  function setFavs(arr){
    try{ localStorage.setItem(KEY_NEW, JSON.stringify(arr||[])); }catch{}
  }
  function removeFav(id){
    const arr = getFavs();
    const idx = arr.findIndex(x => Number(x?.id) === Number(id));
    if (idx >= 0){ arr.splice(idx,1); setFavs(arr); }
    render();
  }

  // Enriquecimento: busca dados atuais para quem s√≥ tem {id}
  async function fetchProfileById(id){
    const tries = [
      `/api/profissionais/${encodeURIComponent(id)}`,
      `/api/profissionais?id=${encodeURIComponent(id)}`,
      `/api/profissional/${encodeURIComponent(id)}`,
      `/api/profissional?id=${encodeURIComponent(id)}`,
      `/api/public/profissional?id=${encodeURIComponent(id)}`,
      `/api/public/profissionais/${encodeURIComponent(id)}`
    ];
    for(const u of tries){
      try{
        const r = await fetch(u, NO_STORE);
        if(!r.ok) continue;
        const js = await r.json();
        if(js){
          if(js.item) return js.item;
          if(js.id || js.nome) return js;
        }
      }catch{}
    }
    return null;
  }
  async function enrichIfNeeded(arr){
    const out = [];
    for(const p of arr){
      if(p && p.nome){ out.push(p); continue; }
      if(!(p && p.id!=null)){ continue; }
      try{
        const full = await fetchProfileById(p.id);
        if(full){
          out.push({
            id: full.id,
            nome: full.nome,
            servico: full.servico || full.profissao || '',
            bairro: full.bairro || '',
            cidade: full.cidade || '',
            foto: full.foto || '',
            whatsapp: full.whatsapp || '',
            rating: Number(full.rating||0),
            avaliacoes: Number(full.avaliacoes||0),
            atendimentos: Number(full.atendimentos||0),
            precoBase: full.precoBase || full.preco || null,
            distanceKm: (full.distanceKm ?? full.dist ?? full.distanciaKm ?? null)
          });
        }else{
          out.push({ id: p.id });
        }
      }catch{
        out.push({ id: p.id });
      }
    }
    return out;
  }

  // Card iOS
  function cardHTML(p){
    const id   = p.id;
    const foto = p.foto || '/icons/icon-192.png';
    const nome = p.nome || 'Profissional';
    const serv = p.servico || p.profissao || '';
    const local = p.local || [p.bairro, p.cidade].filter(Boolean).join(' ‚Ä¢ ');
    const rating = Number(p.rating||0);
    const avals = (p.avaliacoes!=null) ? Number(p.avaliacoes) : 0;
    const atend = (p.atendimentos!=null) ? Number(p.atendimentos) : null;
    const dist  = kmFmt(p.distanceKm);
    const price = (p.precoBase!=null && p.precoBase!=="") ? `R$ ${String(p.precoBase).toString().replace('.',',')}` : null;

    return `
      <article class="pro-card" data-id="${esc(id)}">
        <img class="pro-avatar" src="${esc(foto)}" alt="Foto de ${esc(nome)}" loading="lazy" onerror="this.src='/icons/icon-192.png'">
        <div class="pro-main">
          <h3 class="pro-name">${esc(nome)}</h3>
          <div class="pro-sub">
            ${esc(serv)} ‚Ä¢ <span class="meta">${esc(local)}</span>
            <span class="rating"> ${estrelas(rating)} </span>
            <span class="meta">(${avals})</span>
          </div>
        </div>
        <div class="right">
          ${dist ? `<span class="chip blue">üìç ${esc(dist)}</span>`:''}
          ${price ? `<span class="chip yellow">üíµ ${esc(price)}</span>`:''}
          ${atend!=null ? `<span class="chip green">üß∞ ${atend} trab.</span>`:''}
          <div style="display:flex; gap:6px">
            <a class="nav-btn" style="padding:6px 10px; font-size:13px" href="/profissional/${encodeURIComponent(id)}">Ver</a>
            <button class="nav-btn btn-share" type="button" title="Compartilhar" style="padding:6px 10px;font-size:13px;background:#fff;color:#0f172a;border:1px solid var(--borda)">üîó</button>
            <button class="nav-btn btn-remove" type="button" title="Remover" style="padding:6px 10px;font-size:13px;background:#fff;color:#0f172a;border:1px solid var(--borda)">üóëÔ∏è</button>
          </div>
        </div>
      </article>
    `;
  }

  function renderCards(arr){
    if (!arr.length){
      empty.style.display = '';
      list.innerHTML = '';
      return;
    }
    empty.style.display = 'none';
    list.innerHTML = arr.map(cardHTML).join('');

    list.querySelectorAll('.pro-card').forEach(card=>{
      const id = Number(card.getAttribute('data-id'));
      const btnShare = card.querySelector('.btn-share');
      const btnRemove = card.querySelector('.btn-remove');

      btnShare.addEventListener('click', async ()=>{
        const name = card.querySelector('.pro-name')?.textContent || 'Profissional';
        const meta = card.querySelector('.pro-sub')?.textContent || '';
        const url = location.origin + '/profissional/' + id;
        const text = `Indica√ß√£o no Aut√¥noma: ${name} ‚Äî ${meta}`;
        try{
          if (navigator.share){
            await navigator.share({ title:'Aut√¥noma ‚Ä¢ '+name, text, url });
          } else {
            await navigator.clipboard.writeText(text + ' ' + url);
            btnShare.textContent = '‚úÖ';
            setTimeout(()=> btnShare.textContent = 'üîó', 1200);
          }
        }catch{}
      });

      btnRemove.addEventListener('click', ()=>{
        if (confirm('Remover este profissional dos favoritos?')) removeFav(id);
      });
    });
  }

  async function render(){
    const arr = getFavs();
    if(!arr.length){ empty.style.display=''; list.innerHTML=''; return; }

    // mostra r√°pido
    renderCards(arr);

    // enriquece em background
    try{
      const full = await enrichIfNeeded(arr);
      setFavs(full);
      renderCards(full);
    }catch{}
  }

  // Compartilhar todos
  BTN_SHARE_ALL.addEventListener('click', async ()=>{
    const arr = getFavs();
    if (!arr.length){ alert('Voc√™ n√£o tem favoritos ainda.'); return; }
    const lines = arr.slice(0,20).map(p=>{
      const name  = p.nome || 'Profissional';
      const serv  = p.servico || p.profissao || '';
      const local = p.local || [p.bairro, p.cidade].filter(Boolean).join(' ‚Ä¢ ');
      const url   = location.origin + '/profissional/' + p.id;
      return `‚Ä¢ ${name} ‚Äî ${serv} (${local}) ‚Üí ${url}`;
    });
    const text = `Minhas indica√ß√µes no Aut√¥noma:\n\n${lines.join('\n')}`;
    try{
      if (navigator.share){
        await navigator.share({ title:'Aut√¥noma ‚Ä¢ Meus favoritos', text });
      } else {
        await navigator.clipboard.writeText(text);
        BTN_SHARE_ALL.textContent = '‚úÖ Lista copiada';
        setTimeout(()=> BTN_SHARE_ALL.textContent = 'üîó Compartilhar lista', 1600);
      }
    }catch{}
  });

  // Limpar todos
  BTN_CLEAR.addEventListener('click', ()=>{
    const arr = getFavs();
    if (!arr.length){ alert('N√£o h√° favoritos para limpar.'); return; }
    if (confirm('Tem certeza que deseja limpar todos os favoritos deste dispositivo?')){
      setFavs([]);
      render();
    }
  });

  // Boot
  migrateFavsIfNeeded();
  render();

  // PWA ‚Äî registra SW (n√£o bloqueia)
  if ('serviceWorker' in navigator){
    window.addEventListener('load', ()=>{
      navigator.serviceWorker.register('/sw.js?ver=favs-ios-1').catch(()=>{});
    });
  }
})();
</script>
</body>
</html>