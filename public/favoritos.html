<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Meus Favoritos ‚Ä¢ Aut√¥noma.app</title>

  <!-- Canonical + SEO -->
  <link rel="canonical" href="https://autonomaapp.com.br/favoritos.html">
  <meta name="description" content="Perfis salvos neste dispositivo. Acesse rapidamente seus profissionais favoritos e compartilhe com amigos.">

  <!-- PWA / Favicons -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#0b1f63">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16.png">

  <!-- CSS global -->
  <link rel="stylesheet" href="/css/app.css?v=favs-2025-09-07">

  <style>
    :root{
      --azul-escuro:#0b1f63;
      --azul-brilho:#2D81FF;
      --borda:#e5e7eb;
      --cinza:#64748b;
    }
    /* Cabe√ßalho enxuto */
    .header{ display:flex; align-items:center; gap:12px; padding:12px 16px; background:#0b1f63 }
    .nav-btn{
      appearance:none; border:none; cursor:pointer;
      background:var(--azul-brilho); color:#fff; font-weight:800;
      padding:8px 12px; border-radius:10px; text-decoration:none; font-size:14px;
      display:inline-flex; align-items:center; justify-content:center;
    }
    .nav-btn:hover{ filter:brightness(.96) }
    .wrap{ max-width:1120px; margin:0 auto; padding:16px; }

    /* T√≠tulo / a√ß√µes */
    .page-head{ background:#fff; border:1px solid var(--borda); border-radius:16px; padding:14px; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }
    .meta{ color:var(--cinza) }

    .btn{ border:none; border-radius:12px; padding:10px 12px; font-weight:800; cursor:pointer; text-decoration:none; display:inline-flex; align-items:center; justify-content:center }
    .btn.primary{ background:var(--azul-escuro); color:#fff }
    .btn.outline{ background:#fff; color:#0f172a; border:1px solid var(--borda) }
    .btn.ghost{ background:#f8fafc; color:#0f172a; border:1px solid var(--borda) }

    /* Grid responsivo de cards (mesmo padr√£o dos clientes) */
    .grid{ display:grid; gap:10px; grid-template-columns:1fr; }
    @media (min-width:720px){ .grid{ grid-template-columns:1fr 1fr } }
    @media (min-width:1060px){ .grid{ grid-template-columns:1fr 1fr 1fr } }
    @media (min-width:1400px){ .grid{ grid-template-columns:1fr 1fr 1fr 1fr } }

    .pro-card{
      background:#fff; border:1px solid var(--borda); border-radius:16px; padding:10px 12px;
      display:flex; align-items:center; gap:12px; box-shadow:0 6px 16px rgba(0,0,0,.06);
      transition:transform .16s ease, box-shadow .16s ease;
    }
    .pro-card:hover{ transform:translateY(-1px); box-shadow:0 10px 22px rgba(0,0,0,.09) }
    .pro-avatar{ width:64px; height:64px; border-radius:999px; object-fit:cover; border:1px solid var(--borda); background:#f8fafc; flex:0 0 64px }
    .badge{ font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid var(--borda); background:#eef2ff; color:#3730a3; font-weight:800 }
    .badge.PRO{ background:#eef2ff; border-color:#6366f1; color:#263fa1 }
    .badge.PREMIUM{ background:#fffbeb; border-color:#fbbf24; color:#92400e }

    .pro-main{ flex:1 1 auto; min-width:0 }
    .pro-name{ margin:0; font-size:16px; font-weight:900; color:#0f172a; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
    .pro-sub{ margin:2px 0 0; font-size:13px; color:var(--cinza) }
    .rating{ color:#f59e0b; font-size:13px; }
    .right{ text-align:right; min-width:110px; display:flex; flex-direction:column; gap:6px; align-items:flex-end }
    .pill{ font-size:12px; padding:3px 8px; border-radius:999px; border:1px solid var(--borda); background:#f8fafc }
    .dist{ font-size:13px; color:#0f172a; background:#eef2ff; border:1px solid #c7d2fe; border-radius:999px; padding:2px 8px; }
    .price{ font-size:13px; color:#0f172a; background:#f1f5ff; border:1px solid #e0e7ff; border-radius:999px; padding:2px 8px; }

    .empty{ display:none; background:#fff; border:1px solid var(--borda); border-radius:16px; padding:14px; color:var(--cinza) }

    /* Rodap√© */
    .foot { margin-top:16px; background:#fff; border:1px solid var(--borda); border-radius:16px; padding:14px; text-align:center }
    .links { display:flex; justify-content:center; gap:8px; flex-wrap:wrap }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header" role="banner" aria-label="Cabe√ßalho">
    <a class="nav-btn" href="/">In√≠cio</a>
    <a class="nav-btn" href="/clientes.html">Buscar</a>
    <a class="nav-btn" href="/top10.html">Top 10</a>
    <a class="nav-btn" href="/planos.html">Planos</a>
  </header>

  <main class="wrap" role="main">
    <section class="page-head" aria-labelledby="favTitle">
      <h1 id="favTitle" style="margin:0">Meus Favoritos</h1>
      <p class="meta">Perfis salvos neste dispositivo para acesso r√°pido.</p>
      <div class="row" style="margin-top:8px">
        <button id="btnShareAll" class="btn outline" type="button">üîó Compartilhar lista</button>
        <button id="btnClear" class="btn ghost" type="button">üóëÔ∏è Limpar todos</button>
      </div>
    </section>

    <section id="list" class="grid" aria-live="polite"></section>
    <div id="empty" class="empty">Voc√™ ainda n√£o adicionou favoritos.</div>

    <section class="foot" aria-label="Rodap√©">
      <div class="links">
        <a class="btn ghost" href="/">In√≠cio</a>
        <a class="btn ghost" href="/clientes.html">Buscar profissionais</a>
        <a class="btn outline" href="/top10.html">üèÜ Top 10</a>
        <a class="btn outline" href="/planos.html">üíº Planos</a>
        <a class="btn ghost" href="/termos.html">Termos</a>
        <a class="btn ghost" href="/privacidade.html">Privacidade</a>
      </div>
    </section>
  </main>

  <script>
  (function(){
    // ---------- Utils ----------
    const $ = (id)=> document.getElementById(id);
    const NO_STORE = { cache:'no-store' };
    const ts = () => 'ts=' + Date.now();

    const esc = (s)=> String(s||'')
      .replace(/&/g,'&amp;').replace(/</g,'&lt;')
      .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');

    const estrelas = (n)=>{
      const r=Math.round((Number(n)||0)*2)/2;
      const f=Math.floor(r),h=(r%1!==0);
      return '‚òÖ'.repeat(f)+(h?'¬Ω':'')+'‚òÜ'.repeat(5-f-(h?1:0));
    };

    const kmFmt = (d)=> (d==null ? null : (d<1 ? ((d*1000).toFixed(0)+' m') : (Number(d).toFixed(d<10?1:0)+' km')));

    // ---------- LocalStorage / Migra√ß√£o ----------
    const KEY_NEW = 'autonoma_favs';
    const KEY_OLD = 'favIds';

    function migrateFavsIfNeeded(){
      try{
        const hasNew = !!localStorage.getItem(KEY_NEW);
        const oldRaw = localStorage.getItem(KEY_OLD);
        if(!hasNew && oldRaw){
          let oldArr = [];
          try{ oldArr = JSON.parse(oldRaw)||[]; }catch{ oldArr=[]; }
          const norm = oldArr.map(v => (v && typeof v==='object') ? v : { id: v });
          localStorage.setItem(KEY_NEW, JSON.stringify(norm));
          // opcional: localStorage.removeItem(KEY_OLD);
        }
      }catch{}
    }
    function getFavs(){
      try{
        const raw = localStorage.getItem(KEY_NEW) || '[]';
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      }catch{ return []; }
    }
    function setFavs(arr){
      try{ localStorage.setItem(KEY_NEW, JSON.stringify(arr||[])); }catch{}
    }
    function removeFav(id){
      const arr = getFavs();
      const idx = arr.findIndex(x => String(x?.id) === String(id));
      if(idx>=0){ arr.splice(idx,1); setFavs(arr); }
      render(); // re-render imediato
    }

    // ---------- Enriquecimento ----------
    async function fetchProfileById(id){
      const tries = [
        `/api/profissionais/${encodeURIComponent(id)}?${ts()}`,
        `/api/profissionais?id=${encodeURIComponent(id)}&${ts()}`,
        `/api/profissional/${encodeURIComponent(id)}?${ts()}`,
        `/api/profissional?id=${encodeURIComponent(id)}&${ts()}`,
        `/api/public/profissional?id=${encodeURIComponent(id)}&${ts()}`,
        `/api/public/profissionais/${encodeURIComponent(id)}?${ts()}`
      ];
      for(const u of tries){
        try{
          const r = await fetch(u, NO_STORE);
          if(!r.ok) continue;
          const js = await r.json();
          if(js){
            if(js.item) return js.item;
            if(js.id != null || js.nome) return js;
          }
        }catch{}
      }
      return null;
    }

    async function enrichIfNeeded(arr){
      const out = [];
      for(const p of arr){
        if(p && p.nome){ out.push(p); continue; }
        if(!(p && p.id!=null)){ continue; }
        try{
          const full = await fetchProfileById(p.id);
          if(full){
            out.push({
              id: full.id,
              nome: full.nome,
              servico: full.servico || full.profissao || '',
              bairro: full.bairro || '',
              cidade: full.cidade || '',
              foto: full.foto || '',
              whatsapp: full.whatsapp || '',
              rating: Number(full.rating||0),
              avaliacoes: Number(full.avaliacoes||0),
              atendimentos: Number(full.atendimentos||0),
              distanceKm: (full.distanceKm ?? full.dist ?? full.distanciaKm ?? null),
              precoBase: full.precoBase || full.preco || null,
              badge: (full.plano || '').toString().toUpperCase() // PRO/PREMIUM/FREE
            });
          }else{
            out.push({ id: p.id });
          }
        }catch{
          out.push({ id: p.id });
        }
      }
      return out;
    }

    // ---------- Card ----------
    function cardHTML(p){
      const id = p.id;
      const foto = p.foto || '/icons/icon-192.png';
      const nome = p.nome || 'Profissional';
      const serv = p.servico || p.profissao || '';
      const local = [p.bairro||'', p.cidade||''].filter(Boolean).join(' ‚Ä¢ ');
      const rating = Number(p.rating||0);
      const avals = (Array.isArray(p.avaliacoes)? p.avaliacoes.length : Number(p.avaliacoes)||0);
      const atend = (p.atendimentos!=null)? Number(p.atendimentos) : null;
      const distStr = kmFmt(p.distanceKm);
      const price = (p.precoBase!=null && p.precoBase!=='') ? String(p.precoBase).toString().replace('.',',') : null;
      const badge = (p.badge||'').toString().toUpperCase();
      // link wa local
      let wa = '';
      if (p.whatsapp){
        const d = String(p.whatsapp).replace(/\D/g,'');
        const num = d.startsWith('55') ? d : ('55'+d);
        const txt = 'Ol√°, vi seu perfil no Aut√¥noma.app. Podemos falar?';
        wa = 'https://wa.me/' + num + '?text=' + encodeURIComponent(txt);
      }
      return `
        <article class="pro-card" data-id="${esc(id)}">
          <img class="pro-avatar" src="${esc(foto)}" alt="Foto de ${esc(nome)}" loading="lazy" onerror="this.src='/icons/icon-192.png'">
          <div class="pro-main">
            <h3 class="pro-name">
              ${esc(nome)} ${badge && badge!=='FREE' ? `<span class="badge ${badge}">${badge}</span>`:''}
            </h3>
            <div class="pro-sub">
              ${esc(serv)} ‚Ä¢ <span class="meta">${esc(local||'‚Äî')}</span>
              <span class="rating"> ${estrelas(rating)} </span>
              <span class="meta">(${avals})</span>
            </div>
          </div>
          <div class="right">
            ${distStr ? `<span class="dist">${esc(distStr)}</span>`:''}
            ${price ? `<span class="price">R$ ${esc(price)}</span>`:''}
            <div class="row" style="gap:6px; justify-content:flex-end">
              <a class="btn primary" style="padding:6px 10px; font-size:13px" href="/profissional/${encodeURIComponent(id)}">Ver</a>
              ${wa ? `<a class="btn outline" style="padding:6px 10px; font-size:13px" target="_blank" rel="noopener" href="${esc(wa)}">WhatsApp</a>`:''}
              <button class="btn ghost btn-share" type="button" style="padding:6px 10px; font-size:13px">Recomendar</button>
              <button class="btn outline btn-remove" type="button" style="padding:6px 10px; font-size:13px">Remover</button>
            </div>
          </div>
        </article>
      `;
    }

    function bindCardActions(container){
      container.querySelectorAll('.pro-card').forEach(card=>{
        const id = card.getAttribute('data-id');
        const btnShare = card.querySelector('.btn-share');
        const btnRemove = card.querySelector('.btn-remove');
        btnShare.addEventListener('click', async ()=>{
          const name = card.querySelector('.pro-name')?.textContent?.trim() || 'Profissional';
          const sub = card.querySelector('.pro-sub')?.textContent?.trim() || '';
          const url = location.origin + '/profissional/' + encodeURIComponent(id);
          const text = `Indica√ß√£o no Aut√¥noma: ${name} ‚Äî ${sub}`;
          try{
            if (navigator.share){
              await navigator.share({ title: 'Aut√¥noma ‚Ä¢ ' + name, text, url });
            }else{
              await navigator.clipboard.writeText(text + ' ' + url);
              btnShare.textContent = '‚úÖ Copiado';
              setTimeout(()=> btnShare.textContent='Recomendar', 1400);
            }
          }catch{}
        });
        btnRemove.addEventListener('click', ()=>{
          if (confirm('Remover este profissional dos favoritos?')) removeFav(id);
        });
      });
    }

    function paint(list){
      const wrap = $('list');
      const empty = $('empty');
      if(!list.length){
        empty.style.display = '';
        wrap.innerHTML = '';
        return;
      }
      empty.style.display = 'none';
      wrap.innerHTML = list.map(cardHTML).join('');
      bindCardActions(wrap);
    }

    async function render(){
      const arr = getFavs();
      if(!arr.length){ paint([]); return; }
      // pinta rapidamente a vers√£o local
      paint(arr);
      // tenta enriquecer sem travar a UI
      try{
        const full = await enrichIfNeeded(arr);
        setFavs(full);
        paint(full);
      }catch{}
    }

    // ---------- A√ß√µes de topo ----------
    $('btnShareAll').addEventListener('click', async ()=>{
      const arr = getFavs();
      if(!arr.length){ alert('Voc√™ n√£o tem favoritos ainda.'); return; }
      const lines = arr.slice(0,20).map(p=>{
        const name = p.nome || 'Profissional';
        const serv = p.servico || p.profissao || '';
        const local = [p.bairro||'', p.cidade||''].filter(Boolean).join(' ‚Ä¢ ');
        const url = location.origin + '/profissional/' + encodeURIComponent(p.id);
        return `‚Ä¢ ${name} ‚Äî ${serv} (${local}) ‚Üí ${url}`;
      });
      const text = `Minhas indica√ß√µes no Aut√¥noma:\n\n` + lines.join('\n');
      try{
        if (navigator.share){
          await navigator.share({ title:'Aut√¥noma ‚Ä¢ Meus favoritos', text });
        }else{
          await navigator.clipboard.writeText(text);
          const b = $('btnShareAll');
          b.textContent = '‚úÖ Lista copiada';
          setTimeout(()=> b.textContent='üîó Compartilhar lista', 1400);
        }
      }catch{}
    });

    $('btnClear').addEventListener('click', ()=>{
      const arr = getFavs();
      if(!arr.length){ alert('N√£o h√° favoritos para limpar.'); return; }
      if(confirm('Tem certeza que deseja limpar todos os favoritos deste dispositivo?')){
        setFavs([]);
        render();
      }
    });

    // ---------- Boot ----------
    migrateFavsIfNeeded();
    render();

    // PWA ‚Äî registra SW com cache-buster para v36
    if ('serviceWorker' in navigator){
      window.addEventListener('load', ()=>{
        navigator.serviceWorker.register('/sw.js?v=36').catch(()=>{});
      });
    }
  })();
  </script>
</body>
</html>