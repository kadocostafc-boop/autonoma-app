<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Meus Favoritos ‚Ä¢ Aut√¥noma.app</title>

  <!-- Canonical + SEO -->
  <link rel="canonical" href="https://autonomaapp.com.br/favoritos.html">
  <meta name="description" content="Perfis salvos neste dispositivo. Acesse rapidamente seus profissionais favoritos e compartilhe com amigos.">

  <!-- PWA / Favicons -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#0b49c8">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16.png">

  <!-- CSS global -->
  <link rel="stylesheet" href="/css/app.css?v=std-cards-2025-09-07">
  <style>
    :root{ --borda:#e5e7eb; --cinza:#64748b; --azul:#0b49c8 }
    .header{ display:flex; align-items:center; gap:12px; padding:12px 16px }
    .header .logo{ height:32px }
    .nav{ display:flex; gap:8px; margin-left:auto; flex-wrap:wrap }
    .wrap{ max-width:1120px; margin:0 auto; padding:16px; }

    /* Grid responsivo */
    .grid{ display:grid; gap:10px; grid-template-columns:1fr; }
    @media (min-width:720px){ .grid{ grid-template-columns:1fr 1fr } }
    @media (min-width:1060px){ .grid{ grid-template-columns:1fr 1fr 1fr } }

    .card{ background:#fff; border:1px solid var(--borda); border-radius:16px; padding:14px; }

    /* === CARD PADR√ÉO === */
    .pro-card{
      background:#fff; border:1px solid var(--borda); border-radius:14px; padding:10px 12px;
      display:flex; align-items:center; gap:10px; box-shadow: 0 4px 12px rgba(0,0,0,.05);
      transition:transform .16s ease, box-shadow .16s ease; min-height:84px;
    }
    .pro-card:hover{ transform:translateY(-1px); box-shadow:0 8px 18px rgba(0,0,0,.08) }
    .pro-avatar{ width:62px; height:62px; border-radius:999px; object-fit:cover; border:1px solid var(--borda); background:#f8fafc; flex:0 0 62px }
    .pro-main{ flex:1 1 auto; min-width:0 }
    .pro-name{ margin:0; font-size:15px; font-weight:900; color:#0f172a; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
    .pro-sub{ margin:2px 0 0; font-size:12.5px; color:var(--cinza); overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
    .meta-line{ display:flex; flex-wrap:wrap; gap:6px; margin-top:6px }
    .pill{ font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid var(--borda); background:#f8fafc }
    .rating{ color:#f59e0b; }
    .right{ display:flex; flex-direction:column; gap:6px; align-items:flex-end; min-width:148px }
    .btn{ border:none; background:#0b1f63; color:#fff; padding:8px 10px; border-radius:10px; cursor:pointer; text-decoration:none; display:inline-flex; align-items:center; justify-content:center; font-weight:800; font-size:13px }
    .btn.ghost{ background:#fff; color:#0f172a; border:1px solid var(--borda) }
    .btn.outline{ background:#fff; color:#0f172a; border:1px solid var(--borda) }
    .btn.icon{ display:inline-flex; align-items:center; gap:6px; }

    footer { padding: 28px 12px; background:#0b1f63; margin-top:16px }
    .foot-links { display:flex; flex-wrap:wrap; gap:12px; justify-content:center }
    .foot-links a { color:#cde1ff; font-size:14px; text-decoration:none }
    .foot-links a:hover { text-decoration:underline }
  </style>
</head>
<body>
<header class="header" role="banner">
  <a href="/"><img class="logo" src="/img/logo.png" alt="Aut√¥noma.app" onerror="this.style.display='none'"></a>
  <nav class="nav" aria-label="Links">
    <a class="btn ghost" href="/">In√≠cio</a>
    <a class="btn ghost" href="/clientes.html">Buscar</a>
    <a class="btn ghost" href="/top10.html">üèÜ Top 10</a>
    <a class="btn" href="/planos.html">üíº Planos</a>
  </nav>
</header>

<div class="wrap">
  <div class="card">
    <h1 style="margin:0">Meus Favoritos</h1>
    <p class="meta">Perfis salvos neste dispositivo para acesso r√°pido.</p>
    <div class="row" style="gap:8px; flex-wrap:wrap">
      <button id="btnShareAll" class="btn outline" type="button">üîó Compartilhar lista</button>
      <button id="btnClear" class="btn ghost" type="button">üóëÔ∏è Limpar todos</button>
    </div>
  </div>

  <div id="list" class="grid" aria-live="polite"></div>
  <div id="empty" class="card meta" style="display:none">Voc√™ ainda n√£o adicionou favoritos.</div>

  <div class="card" style="text-align:center">
    <div class="row" style="justify-content:center; gap:8px; flex-wrap:wrap">
      <a class="btn ghost" href="/">In√≠cio</a>
      <a class="btn ghost" href="/clientes.html">Buscar profissionais</a>
      <a class="btn ghost" href="/top10.html">üèÜ Top 10</a>
      <a class="btn ghost" href="/termos.html">Termos</a>
      <a class="btn ghost" href="/privacidade.html">Privacidade</a>
    </div>
  </div>
</div>

<script>
(function(){
  const list = document.getElementById('list');
  const empty = document.getElementById('empty');
  const BTN_SHARE_ALL = document.getElementById('btnShareAll');
  const BTN_CLEAR = document.getElementById('btnClear');

  const KEY_NEW = 'autonoma_favs';
  const KEY_OLD = 'favIds';
  const NO_STORE = { cache:'no-store' };

  function migrateFavsIfNeeded(){
    try{
      const hasNew = !!localStorage.getItem(KEY_NEW);
      const oldRaw = localStorage.getItem(KEY_OLD);
      if (!hasNew && oldRaw){
        let oldArr = [];
        try { oldArr = JSON.parse(oldRaw) || []; } catch { oldArr = []; }
        const norm = oldArr.map(v => (v && typeof v === 'object') ? v : ({ id: v }));
        localStorage.setItem(KEY_NEW, JSON.stringify(norm));
      }
    }catch{}
  }
  function getFavs(){
    try{
      const raw = localStorage.getItem(KEY_NEW) || '[]';
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    }catch{ return []; }
  }
  function setFavs(arr){
    try{ localStorage.setItem(KEY_NEW, JSON.stringify(arr||[])); }catch{}
  }
  function removeFav(id){
    const arr = getFavs();
    const idx = arr.findIndex(x => String(x?.id) === String(id));
    if (idx >= 0){ arr.splice(idx,1); setFavs(arr); }
    render();
  }
  function esc(s){
    return String(s||'')
      .replace(/&/g,'&amp;').replace(/</g,'&lt;')
      .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
  }
  function estrelas(n){
    const r = Math.round((Number(n||0))*2)/2;
    const f = Math.floor(r);
    const half = (r%1!==0);
    return '‚òÖ'.repeat(f) + (half?'¬Ω':'') + '‚òÜ'.repeat(5 - f - (half?1:0));
  }

  async function fetchProfileById(id){
    const tries = [
      `/api/profissionais/${encodeURIComponent(id)}`,
      `/api/profissionais?id=${encodeURIComponent(id)}`,
      `/api/profissional/${encodeURIComponent(id)}`,
      `/api/profissional?id=${encodeURIComponent(id)}`,
      `/api/public/profissional?id=${encodeURIComponent(id)}`,
      `/api/public/profissionais/${encodeURIComponent(id)}`
    ];
    for(const u of tries){
      try{
        const r = await fetch(u, NO_STORE);
        if(!r.ok) continue;
        const js = await r.json();
        if(js){
          if(js.item) return js.item;
          if(js.id || js.nome) return js;
        }
      }catch(_){}
    }
    return null;
  }
  async function enrichIfNeeded(arr){
    const out = [];
    for(const p of arr){
      if(p && p.nome){ out.push(p); continue; }
      if(!(p && p.id!=null)){ continue; }
      try{
        const full = await fetchProfileById(p.id);
        if(full){
          out.push({
            id: full.id,
            nome: full.nome,
            servico: full.servico || full.profissao || '',
            bairro: full.bairro || '',
            cidade: full.cidade || '',
            foto: full.foto || '',
            whatsapp: full.whatsapp || '',
            rating: Number(full.rating||0),
            avaliacoes: Number(full.avaliacoes||0),
            atendimentos: Number(full.atendimentos||0),
            precoBase: full.precoBase || full.preco || null,
            distanceKm: (full.distanceKm ?? full.dist ?? full.distanciaKm ?? null),
            lat: full.lat, lng: full.lng
          });
        }else{
          out.push({ id: p.id });
        }
      }catch{
        out.push({ id: p.id });
      }
    }
    return out;
  }

  function kmFmt(d){
    return (d==null ? "‚Äî" : (d<1 ? `${(d*1000).toFixed(0)} m` : `${Number(d).toFixed(1)} km`));
  }

  function renderCards(arr){
    if (!arr.length){
      empty.style.display = '';
      list.innerHTML = '';
      return;
    }
    empty.style.display = 'none';
    list.innerHTML = arr.map(p=>{
      const id = p.id;
      const foto = p.foto || '/icons/icon-192.png';
      const nome = p.nome || 'Profissional';
      const local = [p.bairro, p.cidade].filter(Boolean).join(' ‚Ä¢ ');
      const serv  = p.servico || p.profissao || '';
      const rating = Number(p.rating||0);
      const avals = Number(p.avaliacoes||0);
      const atend = Number(p.atendimentos||0);
      const price = (p.precoBase!=null && p.precoBase!=="") ? `R$ ${String(p.precoBase)}` : null;
      const dist  = (p.distanceKm!=null && isFinite(p.distanceKm)) ? kmFmt(Number(p.distanceKm)) : '‚Äî';
      let wa = '';
      if (p.whatsapp){
        const d = String(p.whatsapp).replace(/\D/g,'');
        const num = d.startsWith('55') ? d : ('55'+d);
        const txt = 'Ol√°, vi seu perfil no Aut√¥noma.app. Podemos falar?';
        wa = `https://wa.me/${num}?text=${encodeURIComponent(txt)}`;
      }
      return `
        <div class="pro-card" data-id="${esc(id)}">
          <img class="pro-avatar" src="${esc(foto)}" alt="Foto de ${esc(nome)}" onerror="this.src='/icons/icon-192.png'">
          <div class="pro-main">
            <h3 class="pro-name">${esc(nome)}</h3>
            <div class="pro-sub">${esc(serv)} ‚Ä¢ <span>${esc(local)}</span></div>
            <div class="meta-line">
              <span class="pill"><span class="rating">‚≠ê ${estrelas(rating)}</span> <span>(${avals})</span></span>
              <span class="pill">Dist√¢ncia: ${dist}</span>
              <span class="pill">Atendimentos: ${isFinite(atend)?atend:0}</span>
              ${price ? `<span class="pill">Valor: ${esc(price)}</span>`:''}
            </div>
          </div>
          <div class="right">
            <a class="btn" href="/profissional/${encodeURIComponent(id)}">Ver Perfil</a>
            ${wa?`<a class="btn ghost" target="_blank" rel="noopener" href="${esc(wa)}">WhatsApp</a>`:''}
            <button class="btn ghost btn-share" type="button">Recomendar</button>
            <button class="btn ghost btn-remove" type="button">Remover</button>
          </div>
        </div>
      `;
    }).join('');

    // Eventos
    list.querySelectorAll('.pro-card').forEach(card=>{
      const id = card.getAttribute('data-id');
      const btnShare = card.querySelector('.btn-share');
      const btnRemove = card.querySelector('.btn-remove');

      btnShare.addEventListener('click', async ()=>{
        const name = card.querySelector('.pro-name')?.textContent || 'Profissional';
        const sub  = card.querySelector('.pro-sub')?.textContent || '';
        const url  = location.origin + '/profissional/' + encodeURIComponent(id);
        const text = `Indica√ß√£o no Aut√¥noma: ${name} ‚Äî ${sub}.`;
        try{
          if (navigator.share){
            await navigator.share({ title:'Aut√¥noma ‚Ä¢ '+name, text, url });
          } else {
            await navigator.clipboard.writeText(text + ' ' + url);
            btnShare.textContent = '‚úÖ Link copiado';
            setTimeout(()=> btnShare.textContent = 'Recomendar', 1600);
          }
        }catch(_){}
      });

      btnRemove.addEventListener('click', ()=>{
        if (confirm('Remover este profissional dos favoritos?')) removeFav(id);
      });
    });
  }

  async function render(){
    const arr = getFavs();
    if(!arr.length){
      empty.style.display=''; list.innerHTML=''; return;
    }
    empty.style.display='none';
    renderCards(arr); // imediato
    try{
      const full = await enrichIfNeeded(arr);
      setFavs(full);
      renderCards(full);
    }catch{}
  }

  // Compartilhar todos
  BTN_SHARE_ALL.addEventListener('click', async ()=>{
    const arr = getFavs();
    if (!arr.length){ alert('Voc√™ n√£o tem favoritos ainda.'); return; }
    const lines = arr.slice(0,20).map(p=>{
      const name  = p.nome || 'Profissional';
      const serv  = p.servico || p.profissao || '';
      const local = [p.bairro, p.cidade].filter(Boolean).join(' ‚Ä¢ ');
      const url   = location.origin + '/profissional/' + encodeURIComponent(p.id);
      return `‚Ä¢ ${name} ‚Äî ${serv} (${local}) ‚Üí ${url}`;
    });
    const text = `Minhas indica√ß√µes no Aut√¥noma:\n\n${lines.join('\n')}`;
    try{
      if (navigator.share){
        await navigator.share({ title:'Aut√¥noma ‚Ä¢ Meus favoritos', text });
      } else {
        await navigator.clipboard.writeText(text);
        BTN_SHARE_ALL.textContent = '‚úÖ Lista copiada';
        setTimeout(()=> BTN_SHARE_ALL.textContent = 'üîó Compartilhar lista', 1600);
      }
    }catch(_){}
  });

  // Limpar todos
  BTN_CLEAR.addEventListener('click', ()=>{
    const arr = getFavs();
    if (!arr.length){ alert('N√£o h√° favoritos para limpar.'); return; }
    if (confirm('Tem certeza que deseja limpar todos os favoritos deste dispositivo?')){
      setFavs([]); render();
    }
  });

  // SW
  if ('serviceWorker' in navigator){
    window.addEventListener('load', ()=>{
      navigator.serviceWorker.register('/sw.js?ver=favs-std-cards').catch(()=>{});
    });
  }

  // Boot
  migrateFavsIfNeeded();
  render();
})();
</script>
</body>
</html>