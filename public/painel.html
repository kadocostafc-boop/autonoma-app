<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Painel do Profissional • Autônoma.app</title>
  <meta name="theme-color" content="#2d6cdf">
  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <link rel="icon" href="/favicon.ico">
  <link rel="stylesheet" href="/css/app.css">
  <style>
    .header{display:flex;align-items:center;gap:12px;padding:12px 16px}
    .header .logo{height:32px;width:auto;display:block}
    .header .home{margin-left:auto}
    .wrap-max{max-width:1120px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:980px){ .grid{grid-template-columns:2fr 1fr} }
    .panel{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:14px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .meta{color:#64748b}
    .warn{color:#b91c1c}
    .ok{color:#166534}
    .pill{font-size:12px;padding:3px 8px;border-radius:999px;border:1px solid #e5e7eb;background:#f1f5f9}
    .plan-badge{font-size:12px;padding:3px 8px;border-radius:999px;border:1px solid #e5e7eb;background:#f1f5f9;font-weight:800}
    .plan-badge.PRO{background:#eef2ff;border-color:#6366f1}
    .plan-badge.PREMIUM{background:#fffbeb;border-color:#fbbf24}
    .avatar{width:72px;height:72px;border-radius:999px;object-fit:cover;border:1px solid #e5e7eb;background:#f8fafc}
    .grid2{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:760px){ .grid2{grid-template-columns:1fr 1fr} }
    .small{font-size:12px}
    .input[type=range]{width:100%}
    .list{display:flex;flex-wrap:wrap;gap:8px}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid #e5e7eb;border-radius:999px;background:#f8fafc}
    .chip button{border:none;background:transparent;cursor:pointer}
    .divider{height:1px;background:#e5e7eb;margin:10px 0}
    .hint{font-size:12px;color:#64748b}
    .stat{background:#fafafa;border:1px solid #e5e7eb;border-radius:12px;padding:10px}
    .stat strong{font-size:18px}
    .center{display:flex;justify-content:center;align-items:center}
    .btn.inline{padding:6px 10px;font-size:14px}
    .qr{width:160px;height:160px;border-radius:8px;border:1px dashed #cbd5e1;background:#f8fafc}
    .ghost-danger{border-color:#fecaca;color:#b91c1c}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;max-width:92vw;background:#111827;color:#fff;border-radius:12px;padding:10px 14px;font-size:14px;box-shadow:0 10px 24px rgba(0,0,0,.25);z-index:9999;display:none}
    .toast.show{display:block}
  </style>
</head>
<body>
  <header class="header">
    <a href="/" aria-label="Início">
      <img src="/img/logo.png" alt="Autônoma.app" class="logo" onerror="this.style.display='none'">
    </a>
    <div class="home">
      <a class="btn ghost" href="/">Início</a>
      <a class="btn outline" href="/painel_login.html">Trocar conta</a>
      <button id="btnSair" class="btn outline" type="button">Sair</button>
    </div>
  </header>

  <main class="wrap-max">
    <div id="flash" class="panel" style="display:none"></div>

    <div class="grid">
      <!-- Coluna esquerda -->
      <div class="panel">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="row">
            <img id="foto" class="avatar" alt="Foto">
            <div>
              <h1 id="nome" style="margin:0">—</h1>
              <div class="meta" id="servico">—</div>
              <div class="meta"><span id="local">—</span> • <span id="plano">FREE</span></div>
            </div>
          </div>
          <div class="row">
            <a id="btnPerfilPub" class="btn" target="_blank" rel="noopener">Ver meu perfil público</a>
            <a id="btnPreview" class="btn ghost" target="_blank" rel="noopener">Como os clientes me veem</a>
          </div>
        </div>

        <div class="divider"></div>

        <div class="grid2">
          <!-- Radar -->
          <div class="panel">
            <h2 style="margin-top:0">Radar (receba clientes por proximidade)</h2>
            <div class="row">
              <button id="posBtn" class="btn inline" type="button" title="Atualizar minha posição (GPS)">Atualizar posição</button>
              <button id="radarToggle" class="btn" type="button">Ligar Radar</button>
              <span id="radarStatus" class="pill">Desligado</span>
            </div>
            <div class="row" style="margin-top:8px">
              <label for="autoOff">Auto-desligar em:</label>
              <select id="autoOff">
                <option value="">—</option>
                <option value="2">2h</option>
                <option value="4">4h</option>
                <option value="6">6h</option>
                <option value="8">8h</option>
              </select>
              <button id="saveAutoOff" class="btn inline" type="button">Salvar</button>
            </div>
            <p class="hint" id="radarHint">Dica: no plano Free o Radar é bloqueado. Planos PRO/PREMIUM liberam.</p>
          </div>

          <!-- Raio & cidades -->
          <div class="panel">
            <h2 style="margin-top:0">Área de atendimento</h2>
            <div>
              <label for="raio">Raio (km)</label>
              <input type="range" id="raio" min="0" max="50" step="1" value="0">
              <div class="row">
                <div class="pill">Raio atual: <strong id="raioVal">0 km</strong></div>
                <button id="raioSave" class="btn inline" type="button">Salvar raio</button>
              </div>
              <p class="hint" id="raioHint">No plano Free, o raio é 0 km (somente bairro). PRO: até 30 km • PREMIUM: até 50 km.</p>
            </div>
            <div class="divider"></div>
            <div>
              <label for="cidadeExtra">Adicionar cidades extras</label>
              <div class="row">
                <input id="cidadeExtra" class="input" placeholder="Ex.: Niterói/RJ" list="dl-cidades">
                <datalist id="dl-cidades"></datalist>
                <button id="addCidade" class="btn inline" type="button">Adicionar</button>
              </div>
              <div id="cidadesList" class="list" style="margin-top:8px"></div>
            </div>
          </div>
        </div>

        <div class="grid2" style="margin-top:12px">
          <!-- Preferências de pagamento -->
          <div class="panel">
            <h2 style="margin-top:0">Pagamentos</h2>
            <div class="row">
              <label class="row" style="gap:6px">
                <input id="receiveViaApp" type="checkbox"> Receber pelo app (Pix/Cartão)
              </label>
              <span class="pill" id="payMode">Direto com o cliente</span>
            </div>
            <p class="hint">Ao ativar, seus clientes podem pagar pelo app. Taxas: <strong id="feesInfo">4% do app</strong>.</p>
            <div class="row">
              <button id="savePayPrefs" class="btn inline" type="button">Salvar preferência</button>
              <a class="btn ghost" href="/planos.html">Ver planos</a>
            </div>
          </div>

          <!-- Plano -->
          <div class="panel">
            <h2 style="margin-top:0">Plano</h2>
            <div class="row">
              <span id="badgePlano" class="plan-badge">FREE</span>
              <span class="meta" id="planoDesc">Recursos básicos.</span>
            </div>
            <div class="row" style="margin-top:8px">
              <a id="toPro" class="btn" href="/planos.html">Upgrade para PRO</a>
              <a id="toPremium" class="btn outline" href="/planos.html">Upgrade para PREMIUM</a>
              <button id="toFree" class="btn ghost ghost-danger" type="button" disabled>Voltar ao FREE</button>
            </div>
            <p class="hint">Os upgrades direcionam para a página de planos.</p>
          </div>
        </div>

        <div class="panel" style="margin-top:12px">
          <h2 style="margin:0 0 8px">Meu perfil</h2>
          <form id="formPerfil" class="grid2" novalidate>
            <div>
              <label>Nome</label>
              <input id="p_nome" class="input" maxlength="80" required>
              <label style="margin-top:6px">Descrição</label>
              <textarea id="p_desc" class="input" maxlength="600" rows="6"></textarea>
              <label style="margin-top:6px">Preço base (opcional)</label>
              <input id="p_preco" class="input" placeholder="Ex.: R$ 120,00 / Sob orçamento">
            </div>
            <div>
              <label>Site/Catálogo (opcional)</label>
              <input id="p_site" class="input" placeholder="https://">
              <label style="margin-top:6px">Nova foto (JPG/PNG até 3MB)</label>
              <input id="p_foto" type="file" accept="image/*">
              <div class="row" style="margin-top:10px">
                <button class="btn" type="submit">Salvar dados</button>
                <a id="openWhats" class="btn outline" target="_blank" rel="noopener">Abrir WhatsApp</a>
              </div>
              <p id="perfilMsg" class="meta" style="display:none"></p>
            </div>
          </form>
        </div>
      </div>

      <!-- Coluna direita -->
      <aside class="panel">
        <h2 style="margin-top:0">Resumo</h2>
        <div class="grid2">
          <div class="stat"><div class="meta">Visitas</div><strong id="m_vis">—</strong></div>
          <div class="stat"><div class="meta">Chamadas</div><strong id="m_calls">—</strong></div>
          <div class="stat"><div class="meta">Avaliações</div><strong id="m_aval">—</strong></div>
          <div class="stat"><div class="meta">Nota média</div><strong id="m_rate">—</strong></div>
        </div>
        <div class="divider"></div>
        <h3>QR do WhatsApp</h3>
        <div class="center"><div id="qrBox" class="qr center">—</div></div>
        <div class="row center" style="margin-top:8px">
          <button id="copyWa" class="btn inline" type="button">Copiar link</button>
          <a id="openWa" class="btn inline" target="_blank" rel="noopener">Abrir Web</a>
        </div>
        <p class="hint" style="margin-top:8px">Compartilhe o QR no Instagram/Stories para receber contatos diretos.</p>
        <div class="divider"></div>
        <h3>Exportar</h3>
        <div class="row">
          <a id="expCSV" class="btn ghost" href="/api/painel/export.csv">Minhas métricas (.csv)</a>
        </div>
      </aside>
    </div>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
  (function(){
    // ===== Utilidades =====
    const $ = sel => document.querySelector(sel);
    const esc = s => String(s||"")
      .replace(/&/g,"&amp;").replace(/</g,"&lt;")
      .replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");

    const toast = (msg, ms=3000)=>{
      const t = $('#toast'); t.textContent = msg; t.classList.add('show');
      setTimeout(()=> t.classList.remove('show'), ms);
    };

    const flash = (msg, type='ok')=>{
      const box = $('#flash');
      box.style.display='';
      box.className = 'panel ' + (type==='ok'?'ok':'warn');
      box.innerHTML = msg;
      setTimeout(()=>{ box.style.display='none'; }, 3600);
    };

    // ---- Token: pega ?token= e guarda local; envia como Bearer ----
    function getToken(){
      try{
        const u = new URL(location.href);
        const t = u.searchParams.get('token');
        if (t){
          localStorage.setItem('auth_token', t);
          history.replaceState({}, '', location.pathname);
        }
      }catch{}
      try{ return localStorage.getItem('auth_token') || ''; }catch{ return ''; }
    }
    const AUTH_TOKEN = getToken();

    async function apiJSON(url, opt){
      const r = await fetch(url, {
        method: (opt && opt.method) || 'GET',
        headers: { 'Authorization':'Bearer '+AUTH_TOKEN, ...(opt&&opt.headers||{}) },
        cache:'no-store',
        ...(opt||{})
      });
      if(!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }
    async function postJSON(url, body){
      const r = await fetch(url, {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+AUTH_TOKEN },
        body: JSON.stringify(body||{})
      });
      if(!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }
    async function postForm(url, formData){
      const r = await fetch(url, {
        method:'POST',
        headers:{ 'Authorization':'Bearer '+AUTH_TOKEN },
        body: formData
      });
      if(!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }

    // ===== Estado =====
    let ME = null;

    function setPlanBadges(plano){
      const el = $('#plano'); const badge = $('#badgePlano'); const d = $('#planoDesc');
      const p = String(plano||'free').toLowerCase();
      let text='FREE', cls='plan-badge', desc='Recursos básicos.';
      if (p==='pro'){ text='PRO'; cls='plan-badge PRO'; desc='Mais alcance, recursos extras e Radar ampliado.'; }
      if (p==='premium'){ text='PREMIUM'; cls='plan-badge PREMIUM'; desc='Máximo alcance, Radar e prioridade nas buscas.'; }
      el.textContent = text;
      if (badge){ badge.textContent = text; badge.className = cls; }
      if (d){ d.textContent = desc; }
    }

    function paintHeader(me){
      $('#nome').textContent = me.nome || '—';
      $('#servico').textContent = (me.servico || me.profissao || '—');
      $('#local').textContent = [me.bairro, me.cidade].filter(Boolean).join(' • ') || '—';
      setPlanBadges(me.plano);
      const foto = me.foto || 'https://via.placeholder.com/160?text=Foto';
      const img = $('#foto'); img.src = foto; img.alt = 'Foto de '+(me.nome||'Profissional');
      if (typeof me.id !== 'undefined') {
        $('#btnPerfilPub').href = '/profissional/'+ String(me.id);
        $('#btnPreview').href = '/perfil.html?id=' + encodeURIComponent(me.id);
      }
      if (me.whatsapp){
        const d = String(me.whatsapp).replace(/\D/g,'');
        const link = 'https://wa.me/' + d;
        $('#openWhats').href = link;
        $('#openWa').href = link + '?ts=' + Date.now();
        $('#copyWa').onclick = async ()=>{
          try{ await navigator.clipboard.writeText(link); toast('Link do WhatsApp copiado!'); }
          catch{ toast('Não foi possível copiar'); }
        };
        // QR com cache-buster
        const qri = document.createElement('img');
        qri.alt='QR do WhatsApp'; qri.width=160; qri.height=160; qri.style.display='block';
        qri.src = '/api/qr?phone='+encodeURIComponent(d)+'&ts='+Date.now();
        qri.onerror = ()=>{ $('#qrBox').textContent='QR indisponível'; };
        $('#qrBox').innerHTML=''; $('#qrBox').appendChild(qri);
      }
    }

    function paintMetrics(me){
      $('#m_vis').textContent = String(me.visitas||0);
      $('#m_calls').textContent = String(me.chamadas||0);
      const avals = Array.isArray(me.avaliacoes)? me.avaliacoes : [];
      $('#m_aval').textContent = String(avals.length);
      const notas = avals.map(a=>Number(a.nota)).filter(n=>n>=1 && n<=5);
      const media = notas.length ? (notas.reduce((a,b)=>a+b,0)/notas.length) : 0;
      $('#m_rate').textContent = media ? media.toFixed(2) : '—';
    }

    function paintRadar(me){
      const on = !!(me.radar && me.radar.on);
      $('#radarToggle').textContent = on ? 'Desligar Radar' : 'Ligar Radar';
      $('#radarStatus').textContent = on ? 'Ligado' : 'Desligado';
      $('#radarStatus').style.background = on ? '#ecfccb' : '#f1f5f9';
      $('#radarStatus').style.borderColor = on ? '#bbf7d0' : '#e5e7eb';
      $('#radarHint').textContent =
        (String(me.plano).toLowerCase()==='free')
        ? 'Seu plano atual não permite ativar Radar. Faça upgrade para PRO ou PREMIUM.'
        : 'Radar ativo melhora seu posicionamento para clientes próximos.';
    }

    function maxRaioByPlan(plan){
      const p = String(plan||'free').toLowerCase();
      if (p==='premium') return 50;
      if (p==='pro') return 30;
      return 0;
    }

    function maxCidadesByPlan(plan){
      const p = String(plan||'free').toLowerCase();
      if (p==='premium') return 10;
      if (p==='pro') return 3;
      return 0;
    }

    function paintArea(me){
      const r = Number(me.raioKm||0);
      $('#raio').value = String(Math.min(50, Math.max(0, r)));
      $('#raioVal').textContent = r+' km';
      const hint = (String(me.plano).toLowerCase()==='premium') ? 'Seu plano permite até 50 km.'
           : (String(me.plano).toLowerCase()==='pro') ? 'Seu plano permite até 30 km.'
           : 'No plano Free, o raio é 0 km (somente bairro).';
      $('#raioHint').textContent = hint;

      const box = $('#cidadesList');
      box.innerHTML = '';
      const extras = Array.isArray(me.cidadesExtras) ? me.cidadesExtras : [];
      extras.forEach((c,i)=>{
        const div = document.createElement('div');
        div.className = 'chip';
        div.innerHTML = esc(c) + ' <button title="Remover">✕</button>';
        div.querySelector('button').onclick = async ()=>{
          try{
            const list = extras.filter((_,idx)=> idx!==i);
            await postJSON('/api/painel/cidades', { action:'set', list });
            toast('Cidade removida');
            await reload();
          }catch{ toast('Falha ao remover cidade'); }
        };
        box.appendChild(div);
      });
    }

    function paintPayPrefs(me){
      const via = !!me.receiveViaApp;
      $('#receiveViaApp').checked = via;
      $('#payMode').textContent = via ? 'Pelo aplicativo' : 'Direto com o cliente';
      if (me.fees && typeof me.fees.cardPercent==='number'){
        $('#feesInfo').textContent = `${me.fees.cardPercent}% do app`;
      }
    }

    function paintProfileForm(me){
      $('#p_nome').value = me.nome || '';
      $('#p_desc').value = me.descricao || '';
      $('#p_preco').value = me.precoBase || '';
      $('#p_site').value = me.site || '';
    }

    async function loadCidadesOnce(){
      try{
        const js = await apiJSON('/api/geo/cidades');
        $('#dl-cidades').innerHTML = (js||[]).map(c=>`<option value="${esc(c)}">`).join('');
      }catch{}
    }

    // ===== Regras de Plano (gating) =====
    function requirePlan(planNeeded){
      const have = String(ME?.plano||'free').toLowerCase();
      const need = String(planNeeded).toLowerCase();
      const order = { free:0, pro:1, premium:2 };
      if ((order[have]??0) >= (order[need]??0)) return true;
      toast(`Recurso disponível no plano ${need.toUpperCase()}. Faça upgrade em Planos.`);
      return false;
    }

    // ===== Ações =====
    // Sair (POST /api/painel/logout)
    $('#btnSair').addEventListener('click', async ()=>{
      try{
        await fetch('/api/painel/logout',{method:'POST'});
      }catch{}
      try{ localStorage.removeItem('auth_token'); }catch{}
      location.href = '/painel_login.html';
    });

    // Atualizar posição (GPS) -> /api/painel/pos
    $('#posBtn').addEventListener('click', ()=>{
      if (!('geolocation' in navigator)){ toast('Seu navegador não permite GPS'); return; }
      navigator.geolocation.getCurrentPosition(async pos=>{
        try{
          await postJSON('/api/painel/pos', { lat: pos.coords.latitude, lng: pos.coords.longitude });
          toast('Posição atualizada');
        }catch{ toast('Não foi possível salvar a posição'); }
      }, ()=> toast('Falha ao obter a localização'), {enableHighAccuracy:true,timeout:12000,maximumAge:30000});
    });

    // Radar
    $('#radarToggle').addEventListener('click', async ()=>{
      const isOn = ($('#radarStatus').textContent||'').toLowerCase()==='ligado';
      if (!isOn){
        // tentar ligar — checar plano
        if (!requirePlan('pro')) return;
      }
      try{
        await postJSON('/api/painel/radar', { on: !isOn });
        flash('Radar atualizado.');
        await reload();
      } catch{ flash('Falha ao acionar Radar.', 'warn'); }
    });

    // Auto-off
    $('#saveAutoOff').addEventListener('click', async ()=>{
      if (!requirePlan('pro')) return;
      try{
        const h = ($('#autoOff').value||'').trim();
        if (!h){ await postJSON('/api/painel/radar', { on:true, durationHours: null }); }
        else { await postJSON('/api/painel/radar', { on:true, durationHours: Number(h) }); }
        flash('Auto-desligar salvo.');
        await reload();
      }catch{ flash('Falha ao salvar auto-desligar.', 'warn'); }
    });

    // Raio
    $('#raio').addEventListener('input', (e)=>{ $('#raioVal').textContent = e.target.value + ' km'; });
    $('#raioSave').addEventListener('click', async ()=>{
      const want = Number($('#raio').value||0);
      const max = maxRaioByPlan(ME?.plano);
      if (want > max){
        toast(`Seu plano permite até ${max} km. Faça upgrade em Planos.`);
        return;
      }
      try{
        await postJSON('/api/painel/raio', { raioKm: want });
        flash('Raio atualizado.');
        await reload();
      }catch{ flash('Falha ao salvar raio.', 'warn'); }
    });

    // Cidades extras
    $('#addCidade').addEventListener('click', async ()=>{
      const c = ($('#cidadeExtra').value||'').trim();
      if(!c) return;
      const list = Array.isArray(ME?.cidadesExtras)? [...ME.cidadesExtras] : [];
      const max = maxCidadesByPlan(ME?.plano);
      if (!list.includes(c) && list.length >= max){
        toast(`Seu plano permite até ${max} cidades extras. Faça upgrade em Planos.`);
        return;
      }
      try{
        await postJSON('/api/painel/cidades', { action:'add', cidade:c });
        $('#cidadeExtra').value='';
        flash('Cidade adicionada.');
        await reload();
      }catch{ flash('Falha ao adicionar cidade.', 'warn'); }
    });

    // Pagamento prefs
    $('#savePayPrefs').addEventListener('click', async ()=>{
      try{
        const receiveViaApp = !!$('#receiveViaApp').checked;
        await postJSON('/api/painel/payment-prefs', { receiveViaApp });
        flash('Preferência de pagamento salva.');
        await reload();
      }catch{ flash('Não foi possível salvar as preferências.', 'warn'); }
    });

    // Perfil (envio real para /api/painel/update)
    $('#formPerfil').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData();
      fd.append('nome', ($('#p_nome').value||'').trim());
      fd.append('descricao', ($('#p_desc').value||'').trim());
      fd.append('precoBase', ($('#p_preco').value||'').trim());
      fd.append('site', ($('#p_site').value||'').trim());
      const file = $('#p_foto').files && $('#p_foto').files[0];
      if (file) fd.append('foto', file);
      $('#perfilMsg').style.display=''; $('#perfilMsg').className='meta'; $('#perfilMsg').textContent='Salvando...';
      try{
        await postForm('/api/painel/update', fd);
        $('#perfilMsg').className='meta ok'; $('#perfilMsg').textContent='Perfil atualizado com sucesso.';
        flash('Perfil salvo.');
        await reload();
      }catch{
        $('#perfilMsg').className='meta warn'; $('#perfilMsg').textContent='Não foi possível salvar o perfil.';
      }
    });

    // ===== Reload principal =====
    async function reload(){
      try{
        const me = await apiJSON('/api/painel/me');
        ME = me || {};
        paintHeader(ME);
        paintMetrics(ME);
        paintRadar(ME);
        paintArea(ME);
        paintPayPrefs(ME);
        paintProfileForm(ME);
      }catch(e){
        const box = $('#flash');
        box.style.display='';
        box.className='panel warn';
        box.innerHTML = 'Sua sessão não foi reconhecida.<br>Abra <a href="/painel_login.html">/painel_login.html</a>, faça login com o mesmo WhatsApp (tente a variação com/sem 55) e volte.';
      }
    }

    (async function init(){
      // força atualização do SW no mobile
      if('serviceWorker' in navigator){
        try{ const regs=await navigator.serviceWorker.getRegistrations(); regs.forEach(r=>r.update()); }catch{}
      }
      await loadCidadesOnce();
      await reload();
    })();
  })();
  </script>
</body>
</html>