<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Buscar profissionais • Autônoma.app</title>
  <style>
    :root{
      --bg:#f5f7fb; --card:#fff; --text:#111827; --muted:#6b7280; --brand:#2d6cdf;
      --line:#e5e7eb; --ok:#10b981; --warn:#ef4444; --pill:#eef2ff; --pillText:#273a7a;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    a{color:var(--brand);text-decoration:none}
    header{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    header h1{margin:0;font-size:1.4rem}

    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 8px 20px rgba(0,0,0,.05)}
    .filters{padding:12px;display:grid;grid-template-columns:1.2fr 1fr 1fr 1fr 1fr 1fr auto;gap:10px}
    .filters input, .filters select{padding:10px;border:1px solid #d1d5db;border-radius:10px;outline:none}
    @media(max-width:900px){.filters{grid-template-columns:1fr 1fr 1fr}}
    .btn{appearance:none;border:none;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:6px}
    .primary{background:var(--brand);color:#fff}
    .ghost{background:#eef2ff;color:#273a7a}

    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px;margin-top:14px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .pro-card{display:flex;gap:14px;align-items:center;padding:14px;border:1px solid var(--line);border-radius:14px;background:#fff;transition:transform .12s ease}
    .pro-card:active{transform:scale(.995)}
    .foto{width:90px;height:90px;border-radius:999px;object-fit:cover;border:3px solid #eef2ff;background:#fafafa}
    .info{flex:1}
    .nome{font-weight:800;margin:0 0 4px 0}
    .meta{color:var(--muted);font-size:.94rem;margin-bottom:4px}
    .desc{margin:.2rem 0 8px 0}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .pill{display:inline-block;background:var(--pill);color:var(--pillText);border-radius:999px;padding:4px 10px;font-weight:700;font-size:.85rem;margin-right:6px}
    .star{color:#f59e0b}
    .wa{background:#25d366;color:#fff}
    .site{background:#eef2ff;color:#273a7a}
    .perfil{background:#2d6cdf;color:#fff}
    .price{font-weight:800}
    .badge{display:inline-flex;align-items:center;gap:6px;background:rgba(16,185,129,.12);color:#065f46;border:1px solid rgba(16,185,129,.35);padding:2px 8px;border-radius:999px;font-size:.8rem;font-weight:700;margin-left:6px}

    .toolbar{display:flex;justify-content:space-between;align-items:center;margin-top:10px;color:var(--muted)}
    .pagination{display:flex;gap:6px;align-items:center;justify-content:center;margin:16px 0}
    .page-btn{padding:8px 10px;border:1px solid var(--line);border-radius:10px;text-decoration:none;color:var(--text);background:#fff}
    .page-btn[disabled]{opacity:.5;pointer-events:none}
    .empty, .error{color:var(--muted);text-align:center;margin:20px 0}
    .error strong{color:var(--warn)}
    .loader{display:flex;gap:8px;align-items:center;justify-content:center;color:var(--muted);margin:20px 0}
    .loader .dot{width:8px;height:8px;border-radius:999px;background:#9ca3af;animation:b 1s infinite alternate}
    .loader .dot:nth-child(2){animation-delay:.2s}
    .loader .dot:nth-child(3){animation-delay:.4s}
    @keyframes b{to{transform:translateY(-6px);opacity:.6}}

    .topnav{display:flex;gap:10px;align-items:center}
    .topnav a.btn{padding:8px 10px}

    @media (prefers-reduced-motion: reduce){*{animation:none!important;transition:none!important}}
  </style>
  <link rel="preconnect" href="/" crossorigin>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="topnav">
        <a class="btn ghost" href="/index.html">← Início</a>
      </div>
      <h1>Buscar profissionais</h1>
    </header>

    <div class="card">
      <form id="form" class="filters">
        <input type="text" name="q" placeholder="Nome, profissão ou categoria…"/>
        <input type="text" name="cidade" placeholder="Cidade"/>
        <input type="text" name="bairro" placeholder="Bairro"/>
        <select name="servico">
          <option value="">Categoria</option>
          <option>Beleza</option><option>Construção</option><option>Manutenção</option><option>Tecnologia</option><option>Educação</option>
          <option>Saúde</option><option>Pets</option><option>Eventos</option><option>Transporte</option><option>Outros</option>
        </select>
        <select name="sort" title="Ordenar por">
          <option value="rating">Melhor avaliados</option>
          <option value="recent">Mais recentes</option>
          <option value="atendimentos">Mais atendimentos</option>
          <option value="nome">Nome A→Z</option>
        </select>
        <select name="dir" title="Direção">
          <option value="desc">Desc</option>
          <option value="asc">Asc</option>
        </select>
        <button class="btn primary" type="submit">Aplicar</button>
      </form>
    </div>

    <div class="toolbar">
      <div id="count">Carregando…</div>
      <div>
        <label style="font-size:.9rem;color:var(--muted)">Itens por página:</label>
        <select id="limitSel" style="padding:6px 8px;border:1px solid #d1d5db;border-radius:8px">
          <option>6</option><option selected>8</option><option>12</option><option>16</option><option>24</option>
        </select>
      </div>
    </div>

    <div id="list" class="grid"></div>
    <div id="pager" class="pagination"></div>

    <div style="text-align:center;margin:14px 0">
      <a href="/cadastro.html">É profissional? Cadastre-se grátis →</a>
    </div>
  </div>

  <script defer>
    const $ = (sel, root=document) => root.querySelector(sel);
    const el = (tag, cls) => { const x = document.createElement(tag); if (cls) x.className = cls; return x; };
    const usp = () => new URLSearchParams(location.search);
    const setSearch = (obj) => {
      const u = new URL(location.href);
      Object.entries(obj).forEach(([k,v])=>{
        if (v===undefined || v===null || String(v).trim()==="") u.searchParams.delete(k);
        else u.searchParams.set(k, String(v));
      });
      history.replaceState(null,"",u.toString());
    };
    const getQuery = () => {
      const u = usp();
      return {
        q: u.get("q")||"", cidade: u.get("cidade")||"", bairro: u.get("bairro")||"",
        servico: u.get("servico")||"", sort: u.get("sort")||"rating", dir: u.get("dir")||"desc",
        page: parseInt(u.get("page")||"1", 10), limit: parseInt(u.get("limit")||"8", 10),
      };
    };
    const stars = (n) => { const r = Math.round(Number(n)||0); return "★".repeat(Math.min(5, Math.max(0,r))) + "☆".repeat(5 - Math.min(5, Math.max(0,r))); };
    const esc = (s="") => String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");

    let state = { loading:false, error:null, items:[], page:1, pages:1, total:0, limit:8 };

    function syncFormFromURL() {
      const q = getQuery(), f = $("#form");
      f.q.value = q.q; f.cidade.value = q.cidade; f.bairro.value = q.bairro;
      f.servico.value = q.servico; f.sort.value = q.sort; f.dir.value = q.dir;
      $("#limitSel").value = String(q.limit);
    }

    function apiURL() {
      const q = getQuery(), u = new URL("/api/profissionais", location.origin);
      ["q","cidade","bairro","servico","sort","dir","page","limit"].forEach(k=>{
        if (q[k] !== undefined && q[k] !== null && String(q[k]).trim() !== "") u.searchParams.set(k, String(q[k]));
      });
      return u.toString();
    }

    // Preload da primeira chamada quando ocioso
    if ("requestIdleCallback" in window) {
      requestIdleCallback(()=>{ fetch(apiURL()).catch(()=>{}); });
    }

    async function load() {
      state.loading = true; state.error = null; render();
      try {
        const res = await fetch(apiURL(), { cache: "no-store" });
        if (!res.ok) throw new Error("Falha ao consultar API ("+res.status+")");
        const data = await res.json();
        state.items = data.items || [];
        state.page  = data.page  || 1;
        state.pages = data.pages || 1;
        state.total = data.total || 0;
        state.limit = data.limit || getQuery().limit || 8;
        state.loading = false; render();
      } catch (e) {
        state.loading = false; state.error = e.message || String(e); render();
      }
    }

    function render() {
      const list = $("#list"), pager = $("#pager"), count = $("#count");
      if (state.loading) count.textContent = "Carregando…";
      else if (state.error) count.innerHTML = `<strong>Erro:</strong> ${esc(state.error)}`;
      else {
        const ini = state.total ? ((state.page-1)*state.limit + 1) : 0;
        const fim = Math.min(state.total, state.page*state.limit);
        count.textContent = `${ini}–${fim} de ${state.total} resultado(s)`;
      }

      list.innerHTML = "";
      if (state.loading) {
        const l = el("div","loader"); l.innerHTML = `<span>Carregando</span><span class="dot"></span><span class="dot"></span><span class="dot"></span>`; list.appendChild(l);
      } else if (state.error) {
        const e = el("div","error"); e.innerHTML = `<strong>Ops.</strong> ${esc(state.error)} — <a href="#" id="retry">tentar novamente</a>`; list.appendChild(e);
        $("#retry").onclick = (ev)=>{ev.preventDefault(); load();};
      } else if (!state.items.length) {
        const v = el("div","empty"); v.textContent = "Nenhum resultado com os filtros atuais."; list.appendChild(v);
      } else {
        state.items.forEach(p => {
          const foto   = p.foto || "https://via.placeholder.com/120?text=Foto";
          const local  = [p.bairro, p.cidade].filter(Boolean).map(esc).join(" • ");
          const cat    = esc(p.servico || p.profissao || "");
          const preco  = p.precoBase ? ` • <span class="price">${esc(p.precoBase)}</span>` : "";
          const rating = Number(p.rating||0);
          const mediaTxt = rating ? `(${rating.toFixed(1)})` : "(sem avaliações)";
          const linha2 = [cat, esc(p.experiencia || "")].filter(Boolean).join(" • ");
          const wa = p.whatsapp ? `https://wa.me/${p.whatsapp}` : "";

          const card = el("div","pro-card");
          card.innerHTML = `
            <img class="foto" src="${foto}" alt="Foto de ${esc(p.nome)}" width="90" height="90" loading="lazy" decoding="async" fetchpriority="low"/>
            <div class="info">
              <div class="nome">${esc(p.nome)} ${p.verificado ? `<span class="badge">✅ Verificado</span>` : ""}</div>
              <div class="meta"><span class="pill">${cat || "Serviço"}</span>${local ? ` • ${local}` : ""}${preco}</div>
              <div class="meta"><span class="star">${stars(rating)}</span> ${mediaTxt} • ${p.atendimentos || 0} atendimentos</div>
              <div class="meta">${linha2}</div>
              <div class="desc">${p.descricao ? esc(p.descricao) : ""}</div>
              <div class="row">
                ${ wa ? `<a class="btn wa" href="${wa}" target="_blank" rel="noopener">WhatsApp</a>` : "" }
                ${ p.site ? `<a class="btn site" href="${esc(p.site)}" target="_blank" rel="noopener">Site/Instagram</a>` : "" }
                <a class="btn perfil" href="/profissional/${p.id}">Ver perfil</a>
              </div>
            </div>
          `;
          list.appendChild(card);
        });
      }

      pager.innerHTML = "";
      if (!state.loading && !state.error && state.pages > 1) {
        const makeBtn = (label, page, disabled=false) => {
          const a = document.createElement("button");
          a.className = "page-btn"; a.type = "button"; a.textContent = label;
          if (disabled) a.setAttribute("disabled","true");
          a.onclick = () => goPage(page);
          return a;
        };
        pager.appendChild(makeBtn("« Anterior", Math.max(1, state.page-1), state.page<=1));
        const around = 2, start = Math.max(1, state.page - around), end = Math.min(state.pages, state.page + around);
        for (let n = start; n <= end; n++) pager.appendChild(makeBtn(String(n), n, n===state.page));
        pager.appendChild(makeBtn("Próxima »", Math.min(state.pages, state.page+1), state.page>=state.pages));
      }
    }

    function goPage(n) {
      const q = getQuery();
      setSearch({ ...q, page: n });
      load();
      window.scrollTo({top:0,behavior:"smooth"});
    }

    $("#form").addEventListener("submit", (ev) => {
      ev.preventDefault();
      const f = ev.currentTarget;
      const params = {
        q: f.q.value.trim(), cidade: f.cidade.value.trim(), bairro: f.bairro.value.trim(),
        servico: f.servico.value, sort: f.sort.value, dir: f.dir.value,
        page: 1, limit: parseInt($("#limitSel").value,10)||8
      };
      setSearch(params); load();
    });

    $("#limitSel").addEventListener("change", () => {
      const q = getQuery(); setSearch({ ...q, page: 1, limit: parseInt($("#limitSel").value,10)||8 }); load();
    });

    // Inicialização
    syncFormFromURL(); load();
  </script>
</body>
</html>
