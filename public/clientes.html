<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Encontre profissionais • Autônoma.app</title>

  <!-- SEO / PWA -->
  <link rel="canonical" href="https://autonomaapp.com.br/clientes.html">
  <meta name="description" content="Busque profissionais perto de você. Filtre por serviço. Veja distância, avaliações e contato direto.">
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#0b1f63">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16.png">

  <!-- OpenGraph -->
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="Autônoma.app">
  <meta property="og:title" content="Encontre profissionais">
  <meta property="og:description" content="Profissionais por perto, com avaliações e contato direto.">
  <meta property="og:image" content="https://autonomaapp.com.br/img/og-cover.png">
  <meta property="og:url" content="https://autonomaapp.com.br/clientes.html">

  <link rel="stylesheet" href="/css/global.css?v=2.0">

  <style>
    /* HERO */
    .search-hero {
      background: linear-gradient(180deg, #2D81FF 0%, #1E6EF2 100%);
      color: #fff;
      margin: 0 0 14px;
      padding: 20px 14px 16px;
      border-radius: 18px;
      box-shadow: 0 10px 24px rgba(0,0,0,.10);
    }
    .search-hero h1 {
      margin: 0 0 10px;
      font-size: 26px;
      font-weight: 900;
      line-height: 1.15;
    }

    .gps-row {
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin: 8px 0 12px;
    }

    .pill {
      background:#ffffff20;
      border:1px solid #ffffff40;
      color:#fff;
      padding:6px 10px;
      border-radius:12px;
      font-size:13px;
    }

    .filters {
      display:grid;
      gap:10px;
      grid-template-columns:1fr;
      background:#fff;
      border-radius:14px;
      padding:12px;
    }

    @media(min-width:820px){
      .filters {
        grid-template-columns: 1.2fr 1fr 1fr .8fr auto;
      }
    }

    .filters label {
      font-weight:700;
      font-size:13px;
    }
  </style>
</head>

<body>

<!-- HEADER -->
<header class="header">
  <a class="nav-btn" href="/">Início</a>
  <a class="nav-btn" href="/top10.html">Top 10</a>
  <a class="nav-btn" href="/painel_login.html">Entrar</a>
</header>

<main class="wrap">

  <!-- HERO -->
  <section class="search-hero">
    <h1>Encontre profissionais qualificados</h1>

    <div class="gps-row">
      <label class="pill">
        <input id="useGPS" type="checkbox">
        Usar minha localização
      </label>
      <span id="gpsStatus" class="pill">GPS desativado</span>
    </div>

    <!-- FORM DE BUSCA -->
    <form id="formBusca" class="filters" novalidate>

      <div>
        <label for="cidade">Cidade</label>
        <input id="cidade" name="cidade" type="text" placeholder="Ex: Rio de Janeiro">
        <datalist id="listaCidades"></datalist>
      </div>

      <div>
        <label for="bairro">Bairro</label>
        <input id="bairro" name="bairro" type="text" placeholder="Ex: Copacabana">
        <datalist id="listaBairros"></datalist>
      </div>

      <div>
        <label for="servico">Serviço</label>
        <input id="servico" name="servico" type="text" placeholder="Ex: Diarista">
        <datalist id="listaServicos"></datalist>
      </div>

      <div>
        <label for="minRating">Avaliação mínima</label>
        <select id="minRating" name="minRating">
          <option value="">Qualquer</option>
          <option value="3">3+ ⭐</option>
          <option value="4">4+ ⭐</option>
          <option value="4.5">4.5+ ⭐</option>
        </select>
      </div>

      <div style="display:flex;gap:8px;align-items:flex-end">
        <button class="btn" type="submit">Buscar</button>
        <button class="btn ghost" type="button" id="btnLimpar">Limpar</button>
      </div>

    </form>

  </section>
  <script>
/* =========================================================
   AUTÔNOMA.APP — CLIENTES
   PARTE 2/4
   Estado global + Autocomplete + GPS + Busca base
========================================================= */

(function () {
  // ========================
  // HELPERS
  // ========================
  const $ = (id) => document.getElementById(id)
  const esc = (s) => String(s || '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;')

  const normalize = (s) =>
    String(s || '')
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .toLowerCase()

  // ========================
  // ESTADO GLOBAL
  // ========================
  let userLat = null
  let userLng = null
  let useGPS = false

  let currentPage = 1
  let totalPages = 1
  let searching = false

  let lastQuery = {
    cidade: '',
    bairro: '',
    servico: '',
    minRating: ''
  }

  const PAGE_SIZE_SEARCH = 15
  const PAGE_SIZE_INITIAL = 10

  // ========================
  // AUTOCOMPLETE — CIDADES
  // ========================
  async function carregarCidades() {
    try {
      const res = await fetch('/api/geo/cidades', { cache: 'no-store' })
      if (!res.ok) return
      const cidades = await res.json()
      $('listaCidades').innerHTML = cidades
        .map(c => `<option value="${esc(c)}">`)
        .join('')
    } catch (e) {
      console.warn('Erro cidades', e)
    }
  }

  // ========================
  // AUTOCOMPLETE — BAIRROS
  // ========================
  async function carregarBairros(cidade) {
    if (!cidade) return
    try {
      const res = await fetch(
        `/api/geo/bairros?cidade=${encodeURIComponent(cidade)}`,
        { cache: 'no-store' }
      )
      if (!res.ok) return
      const bairros = await res.json()
      $('listaBairros').innerHTML = bairros
        .map(b => `<option value="${esc(b)}">`)
        .join('')
    } catch (e) {
      console.warn('Erro bairros', e)
    }
  }

  // ========================
  // AUTOCOMPLETE — SERVIÇOS
  // ========================
  async function sugerirServicos(q) {
    if (!q || q.length < 2) return []
    try {
      const res = await fetch(
        `/api/servicos/suggest?q=${encodeURIComponent(q)}`,
        { cache: 'no-store' }
      )
      if (!res.ok) return []
      return await res.json()
    } catch (e) {
      return []
    }
  }

  $('servico').addEventListener('input', async (e) => {
    const q = e.target.value.trim()
    const lista = await sugerirServicos(q)
    $('listaServicos').innerHTML = lista
      .map(s => `<option value="${esc(s.nome || s)}">`)
      .join('')
  })

  // ========================
  // EVENTOS DE INPUT
  // ========================
  $('cidade').addEventListener('change', async (e) => {
    $('bairro').value = ''
    await carregarBairros(e.target.value)
  })

  // ========================
  // GPS
  // ========================
  function gpsPermitido() {
    return (
      location.hostname === 'localhost' ||
      location.hostname === '127.0.0.1' ||
      window.isSecureContext === true
    )
  }

  async function detectarCidadePorGPS(lat, lng) {
    try {
      const res = await fetch(
        `/api/geo/closest-city?lat=${lat}&lng=${lng}`,
        { cache: 'no-store' }
      )
      const json = await res.json()
      if (json?.cidade) {
        $('cidade').value = json.cidade
        await carregarBairros(json.cidade)
      }
    } catch {}
  }

  $('useGPS').addEventListener('change', async (e) => {
    useGPS = e.target.checked

    if (!useGPS) {
      userLat = null
      userLng = null
      $('gpsStatus').textContent = 'GPS desativado.'
      return
    }

    if (!gpsPermitido()) {
      $('gpsStatus').textContent =
        'Para usar GPS, acesse via HTTPS.'
      $('useGPS').checked = false
      useGPS = false
      return
    }

    navigator.geolocation.getCurrentPosition(
      async (pos) => {
        userLat = pos.coords.latitude
        userLng = pos.coords.longitude
        $('gpsStatus').textContent = 'Localização ativada.'
        if (!$('cidade').value) {
          await detectarCidadePorGPS(userLat, userLng)
        }
      },
      () => {
        $('gpsStatus').textContent =
          'Não foi possível obter localização.'
        $('useGPS').checked = false
        useGPS = false
      },
      { enableHighAccuracy: true, timeout: 10000 }
    )
  })

  // ========================
  // PREPARAR BUSCA
  // ========================
  function prepararBusca() {
    lastQuery = {
      cidade: $('cidade').value.trim(),
      bairro: $('bairro').value.trim(),
      servico: $('servico').value.trim(),
      minRating: $('minRating').value
    }

    currentPage = 1
    searching = !!lastQuery.servico
  }

  // ========================
  // INICIALIZAÇÃO
  // ========================
  async function init() {
    await carregarCidades()
  }

  init()

  // PARTE 3 CONTINUA…
})();
</script>
/* =========================================================
   AUTÔNOMA.APP — CLIENTES
   PARTE 3/4
   Renderização de cards + busca + paginação
========================================================= */

(function () {
  // ========================
  // UTILIDADES
  // ========================
  function estrelas(nota) {
    const r = Math.round((Number(nota) || 0) * 2) / 2
    const full = Math.floor(r)
    const half = r % 1 !== 0
    return '★'.repeat(full) + (half ? '½' : '') + '☆'.repeat(5 - full - (half ? 1 : 0))
  }

  function kmFormat(km) {
    if (km == null || !isFinite(km)) return '—'
    if (km < 1) return `${Math.round(km * 1000)} m`
    return `${km.toFixed(1)} km`
  }

  function haversine(lat1, lon1, lat2, lon2) {
    if (![lat1, lon1, lat2, lon2].every(v => isFinite(v))) return null
    const R = 6371
    const dLat = (lat2 - lat1) * Math.PI / 180
    const dLon = (lon2 - lon1) * Math.PI / 180
    const a =
      Math.sin(dLat / 2) ** 2 +
      Math.cos(lat1 * Math.PI / 180) *
      Math.cos(lat2 * Math.PI / 180) *
      Math.sin(dLon / 2) ** 2
    return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a))
  }

  // ========================
  // CARD HTML
  // ========================
  function renderCard(p) {
    const foto = p.foto || '/icons/icon-192.png'
    const nome = p.nome || 'Profissional'
    const local = [p.bairro, p.cidade].filter(Boolean).join(' • ')
    const rating = Number(p.avaliacao || p.rating || 0)
    const totalAval = Number(p.totalAvaliacoes || 0)

    let distancia = p.distanciaKm
    if (distancia == null && window.userLat && window.userLng && p.latitude && p.longitude) {
      distancia = haversine(userLat, userLng, p.latitude, p.longitude)
    }

    return `
      <article class="pro-card">
        <img class="pro-avatar"
             src="${foto}"
             alt="Foto de ${nome}"
             onerror="this.src='/icons/icon-192.png'">
        <div class="pro-main">
          <h3 class="pro-name">${nome}</h3>
          <div class="pro-sub">${p.servicos?.join(', ') || ''} • ${local || '—'}</div>
          <div class="meta-line">
            <span class="pill rating">⭐ ${estrelas(rating)} (${totalAval})</span>
            <span class="pill">Distância: ${kmFormat(distancia)}</span>
            ${p.verificado ? `<span class="pill">✔ Verificado</span>` : ''}
          </div>
        </div>
        <div class="right">
          <a class="btn" href="/profissional/${p.id}">Ver Perfil</a>
          <a class="btn ghost" target="_blank"
             href="https://wa.me/55${p.whatsapp?.replace(/\D/g, '')}">
             WhatsApp
          </a>
        </div>
      </article>
    `
  }

  // ========================
  // ORDENAÇÃO
  // ========================
  function pesoPlano(plano) {
    if (plano === 'PREMIUM') return 3
    if (plano === 'PRO') return 2
    return 1
  }

  function ordenarResultados(lista) {
    return lista.sort((a, b) => {
      const p1 = pesoPlano(a.plano)
      const p2 = pesoPlano(b.plano)
      if (p1 !== p2) return p2 - p1

      const d1 = a.distanciaKm ?? Infinity
      const d2 = b.distanciaKm ?? Infinity
      if (d1 !== d2) return d1 - d2

      return (b.avaliacao || 0) - (a.avaliacao || 0)
    })
  }

  // ========================
  // BUSCAR NO BACKEND
  // ========================
  async function buscarProfissionais() {
    const params = new URLSearchParams()

    if (lastQuery.cidade) params.set('cidade', lastQuery.cidade)
    if (lastQuery.bairro) params.set('bairro', lastQuery.bairro)
    if (lastQuery.servico) params.set('servico', lastQuery.servico)
    if (lastQuery.minRating) params.set('minRating', lastQuery.minRating)
    if (useGPS && userLat && userLng) {
      params.set('lat', userLat)
      params.set('lng', userLng)
    }

    params.set('page', currentPage)
    params.set('limit', searching ? PAGE_SIZE_SEARCH : PAGE_SIZE_INITIAL)

    $('loader').style.display = 'inline'
    const res = await fetch('/api/profissionais?' + params.toString(), { cache: 'no-store' })
    const json = await res.json()
    $('loader').style.display = 'none'

    return json
  }

  // ========================
  // RENDER RESULTADOS
  // ========================
  async function renderResultados() {
    const data = await buscarProfissionais()
    let lista = data.profissionais || []

    lista = ordenarResultados(lista)

    $('results').innerHTML = lista.length
      ? lista.map(renderCard).join('')
      : `<div class="card"><p class="muted">Nenhum profissional encontrado.</p></div>`

    totalPages = data.totalPages || 1
    $('pageInfo').textContent = `${currentPage}/${totalPages}`
    $('paginacao').style.display = totalPages > 1 ? '' : 'none'
  }

  // ========================
  // EVENTOS
  // ========================
  $('formBusca').addEventListener('submit', (e) => {
    e.preventDefault()
    prepararBusca()
    renderResultados()
  })

  $('prev').addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--
      renderResultados()
    }
  })

  $('next').addEventListener('click', () => {
    if (currentPage < totalPages) {
      currentPage++
      renderResultados()
    }
  })

  // PARTE 4 CONTINUA…
})();
</script>
/* =========================================================
   AUTÔNOMA.APP — CLIENTES
   PARTE 4/4
   Destaques + Inicialização + Service Worker
========================================================= */

(function () {

  // ========================
  // VARIÁVEIS GLOBAIS
  // ========================
  window.userLat = null
  window.userLng = null
  window.useGPS = false

  window.currentPage = 1
  window.totalPages = 1
  window.searching = false

  window.PAGE_SIZE_INITIAL = 10
  window.PAGE_SIZE_SEARCH = 15

  window.lastQuery = {
    cidade: '',
    bairro: '',
    servico: '',
    minRating: ''
  }

  // ========================
  // PREPARAR BUSCA
  // ========================
  window.prepararBusca = function () {
    lastQuery = {
      cidade: $('cidade').value.trim(),
      bairro: $('bairro').value.trim(),
      servico: $('servico').value.trim(),
      minRating: $('minRating').value
    }

    currentPage = 1
    searching = !!lastQuery.servico

    // Tags visuais
    $('tagCidade').style.display = lastQuery.cidade ? 'inline-flex' : 'none'
    $('tagCidade').textContent = `Cidade: ${lastQuery.cidade}`

    $('tagBairro').style.display = lastQuery.bairro ? 'inline-flex' : 'none'
    $('tagBairro').textContent = `Bairro: ${lastQuery.bairro}`

    $('tagServico').style.display = lastQuery.servico ? 'inline-flex' : 'none'
    $('tagServico').textContent = `Serviço: ${lastQuery.servico}`

    $('tagRating').style.display = lastQuery.minRating ? 'inline-flex' : 'none'
    $('tagRating').textContent = `Avaliação: ${lastQuery.minRating}+`
  }

  // ========================
  // GPS AUTOMÁTICO
  // ========================
  async function ativarGPS() {
    if (!navigator.geolocation) {
      $('gpsStatus').textContent = 'GPS não suportado'
      return
    }

    $('gpsStatus').textContent = 'Obtendo localização…'

    navigator.geolocation.getCurrentPosition(
      async (pos) => {
        userLat = pos.coords.latitude
        userLng = pos.coords.longitude
        useGPS = true

        $('gpsStatus').innerHTML = '<span class="gps-ok">Localização ativa</span>'

        // Resolver cidade pelo backend
        try {
          const r = await fetch(`/api/geo/closest-city?lat=${userLat}&lng=${userLng}`)
          const j = await r.json()
          if (j.ok && j.cidade) {
            $('cidade').value = j.cidade
            $('tagCidade').style.display = 'inline-flex'
            $('tagCidade').textContent = `Cidade: ${j.cidade}`
          }
        } catch {}
      },
      () => {
        $('gpsStatus').innerHTML = '<span class="gps-warn">GPS negado</span>'
        useGPS = false
      },
      { enableHighAccuracy: true, timeout: 10000 }
    )
  }

  $('useGPS').addEventListener('change', (e) => {
    if (e.target.checked) ativarGPS()
    else {
      useGPS = false
      userLat = null
      userLng = null
      $('gpsStatus').textContent = 'GPS desativado.'
    }
  })

  // ========================
  // DESTAQUES
  // ========================
  async function carregarDestaques() {
    const cont = $('destaques')
    const count = $('destCount')

    try {
      const r = await fetch('/api/profissionais?limit=6&featured=1', { cache: 'no-store' })
      const j = await r.json()
      const lista = j.profissionais || []

      count.textContent = lista.length ? `${lista.length} selecionados` : ''
      cont.innerHTML = lista.length
        ? lista.map(p => `
            <article class="pro-card">
              <img class="pro-avatar" src="${p.foto || '/icons/icon-192.png'}">
              <div class="pro-main">
                <h3 class="pro-name">${p.nome}</h3>
                <div class="pro-sub">${p.cidade}</div>
              </div>
              <div class="right">
                <a class="btn" href="/profissional/${p.id}">Ver</a>
              </div>
            </article>
          `).join('')
        : '<div class="muted">Sem destaques no momento.</div>'
    } catch {
      cont.innerHTML = '<div class="muted">Erro ao carregar destaques.</div>'
    }
  }

  // ========================
  // LIMPAR FILTROS
  // ========================
  $('btnLimpar').addEventListener('click', () => {
    $('cidade').value = ''
    $('bairro').value = ''
    $('servico').value = ''
    $('minRating').value = ''

    $('tagCidade').style.display = 'none'
    $('tagBairro').style.display = 'none'
    $('tagServico').style.display = 'none'
    $('tagRating').style.display = 'none'

    currentPage = 1
    searching = false

    carregarDestaques()
  })

  // ========================
  // BOOTSTRAP FINAL
  // ========================
  document.addEventListener('DOMContentLoaded', async () => {
    carregarDestaques()
  })

  // ========================
  // SERVICE WORKER
  // ========================
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js').catch(() => {})
    })
  }

})()
</script>
</body>
</html>