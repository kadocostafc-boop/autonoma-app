<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Encontre profissionais ‚Ä¢ Aut√¥noma.app</title>

  <!-- SEO/PWA b√°sicos -->
  <link rel="canonical" href="https://autonomaapp.com.br/clientes.html">
  <meta name="description" content="Busque profissionais perto de voc√™. Filtre por bairro e tipo de servi√ßo. Veja dist√¢ncia, atendimentos e avalia√ß√µes.">
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#2563eb">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">

  <!-- Favicons -->
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16.png">

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="Aut√¥noma.app">
  <meta property="og:title" content="Encontre profissionais">
  <meta property="og:description" content="Profissionais por perto, com avalia√ß√µes e contato direto.">
  <meta property="og:image" content="https://autonomaapp.com.br/img/og-cover.png">
  <meta property="og:url" content="https://autonomaapp.com.br/clientes.html">

  <link rel="stylesheet" href="/css/app.css">
  <style>
    /* Ajustes espec√≠ficos desta p√°gina */
    .filters{ display:grid; gap:10px; grid-template-columns:1fr; }
    @media(min-width:720px){ .filters{ grid-template-columns:1.2fr 1fr 1fr .8fr auto } }
    .results-grid{ display:grid; gap:12px; grid-template-columns:1fr; }
    @media(min-width:720px){ .results-grid{ grid-template-columns:1fr 1fr } }
    @media(min-width:1060px){ .results-grid{ grid-template-columns:1fr 1fr 1fr } }
    .pro-card{ cursor:pointer }
    .badge-pro{ background:#eef2ff; border-color:#c7d2fe; color:#3730a3; font-weight:700 }
    .badge-premium{ background:#fff7ed; border-color:#fed7aa; color:#9a3412; font-weight:700 }
    .distance{ font-variant-numeric:tabular-nums }
    .muted{ color:#64748b }
    .subtle{ color:#94a3b8 }
    .topbar-links{ margin-left:auto; display:flex; gap:8px; flex-wrap:wrap }
    .tag{ display:inline-flex; align-items:center; gap:6px; font-size:12px; padding:4px 8px; border:1px solid #e5e7eb; border-radius:999px; background:#f8fafc }
    .loader{ display:none; font-size:14px }
    .gps-ok{ color:#059669; }
    .gps-warn{ color:#b45309; }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="header" role="banner">
    <a href="/" aria-label="In√≠cio">
      <img class="logo" src="/img/logo.png" alt="Aut√¥noma.app" onerror="this.style.display='none'">
    </a>
    <nav class="topbar-links" aria-label="Navega√ß√£o principal">
      <a class="btn ghost" href="/">In√≠cio</a>
      <a class="btn ghost" href="/top10.html">üèÜ Top 10</a>
      <a class="btn ghost" href="/planos.html">‚≠ê Planos</a>
      <a class="btn outline" href="/painel_login.html">üîê Entrar no Painel</a>
      <a class="btn" href="/cadastro.html">‚ûï Cadastrar Profissional</a>
    </nav>
  </header>

  <main class="wrap" role="main">
    <div class="card">
      <h1 class="mt-0">Encontre profissionais</h1>
      <p class="meta">Deixe simples: escolha <strong>bairro</strong> e <strong>servi√ßo</strong>. Se permitir o GPS, mostramos quem est√° mais perto (com <span class="badge">Radar</span> ou endere√ßo fixo).</p>

      <!-- Prefer√™ncias/GPS -->
      <div class="row" style="gap:10px; align-items:center; flex-wrap:wrap; margin:8px 0 12px">
        <label class="pill" style="gap:8px">
          <input id="useGPS" type="checkbox" />
          Usar minha localiza√ß√£o
        </label>
        <span id="gpsStatus" class="small muted">GPS desativado.</span>
      </div>

      <!-- Filtros -->
      <form id="formBusca" class="filters" role="search" aria-label="Filtros de busca" novalidate>
        <div>
          <label for="cidade">Cidade</label>
          <input id="cidade" name="cidade" type="text" placeholder="Ex.: Rio de Janeiro/RJ" list="listaCidades" autocomplete="off">
          <datalist id="listaCidades"></datalist>
        </div>
        <div>
          <label for="bairro">Bairro</label>
          <input id="bairro" name="bairro" type="text" placeholder="Ex.: Copacabana" list="listaBairros" autocomplete="off">
          <datalist id="listaBairros"></datalist>
        </div>
        <div>
          <label for="servico">Servi√ßo</label>
          <input id="servico" name="servico" type="text" placeholder="Ex.: Eletricista" list="listaServicos" autocomplete="off">
          <datalist id="listaServicos"></datalist>
        </div>
        <div>
          <label for="minRating">Melhor avalia√ß√£o (opcional)</label>
          <select id="minRating" name="minRating">
            <option value="">Qualquer</option>
            <option value="3">3+ ‚≠ê</option>
            <option value="4">4+ ‚≠ê</option>
            <option value="4.5">4.5+ ‚≠ê</option>
          </select>
        </div>
        <div style="display:flex; gap:8px; align-items:flex-end">
          <button class="btn" type="submit" id="btnBuscar">Buscar</button>
          <button class="btn ghost" type="button" id="btnLimpar">Limpar</button>
        </div>
      </form>

      <!-- Estado -->
      <div class="row" style="margin-top:10px; align-items:center; gap:10px; flex-wrap:wrap">
        <span class="tag" id="tagCidade" style="display:none"></span>
        <span class="tag" id="tagBairro" style="display:none"></span>
        <span class="tag" id="tagServico" style="display:none"></span>
        <span class="tag" id="tagRating" style="display:none"></span>
        <span class="loader" id="loader">Carregando resultados‚Ä¶</span>
      </div>
    </div>

    <!-- Resultados -->
    <section id="results" class="results-grid" aria-live="polite"></section>

    <!-- Pagina√ß√£o -->
    <div class="card" id="paginacao" style="text-align:center; display:none">
      <button id="btnMais" class="btn">Carregar mais</button>
      <p id="contagem" class="small muted" style="margin-top:6px"></p>
    </div>

    <!-- Dicas -->
    <div class="card">
      <p class="small subtle">Dica: para ver mais detalhes, avalia√ß√µes e favoritar/recomendar, abra o perfil do profissional.</p>
      <div class="foot">
        <a href="/cadastro.html">Cadastrar meu perfil</a> ¬∑
        <a href="/favoritos.html">Meus Favoritos</a> ¬∑
        <a href="/top10.html">Top 10</a> ¬∑
        <a href="/planos.html">Planos</a>
      </div>
    </div>
  </main>

  <script>
  (function(){
    // ---------- Utils ----------
    const $ = (id)=> document.getElementById(id);
    const esc = (s)=> String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");
    const estrelas = (n)=> {
      const r = Math.round((Number(n)||0)*2)/2; // meia estrela se quiser no futuro
      const full = Math.floor(r), half = (r%1!==0);
      return "‚òÖ".repeat(full) + (half?"¬Ω":"") + "‚òÜ".repeat(5-full-(half?1:0));
    };
    const kmFmt = (d)=> (d==null ? "‚Äî" : (d<1 ? `${(d*1000).toFixed(0)} m` : `${d.toFixed(d<10?1:0)} km`));

    // ---------- Estado ----------
    let userLat = null, userLng = null, useGPS = false;
    let page = 1, limit = 20, total = 0, acumulados = 0;
    let lastQuery = { cidade:"", bairro:"", servico:"", minRating:"" };

    // ---------- Autocomplete ----------
    async function fillCidades(){
      try{
        const r = await fetch('/api/geo/cidades');
        const js = await r.json();
        const dl = $('listaCidades');
        dl.innerHTML = (js||[]).map(c=>`<option value="${esc(c)}">`).join('');
      }catch{}
    }
    async function suggestBairros(q){
      const cid = $('cidade').value.trim();
      if(!cid || !q) return [];
      const r = await fetch(`/api/geo/bairros/suggest?cidade=${encodeURIComponent(cid)}&q=${encodeURIComponent(q)}`);
      return r.ok ? (await r.json()) : [];
    }
    async function suggestServicos(q){
      if(!q) return [];
      const r = await fetch(`/api/geo/servicos/suggest?q=${encodeURIComponent(q)}`);
      return r.ok ? (await r.json()) : [];
    }
    // simples: a cada blur/change a gente atualiza datalist
    $('bairro').addEventListener('input', async (e)=>{
      const v = e.target.value.trim();
      const list = await suggestBairros(v);
      $('listaBairros').innerHTML = list.map(b=>`<option value="${esc(b)}">`).join('');
    });
    $('servico').addEventListener('input', async (e)=>{
      const v = e.target.value.trim();
      const list = await suggestServicos(v);
      $('listaServicos').innerHTML = list.map(s=>`<option value="${esc(s)}">`).join('');
    });

    // ---------- GPS / Cidade autom√°tica ----------
    async function resolveCityByGPS(lat,lng){
      try{
        const r = await fetch(`/api/geo/closest-city?lat=${lat}&lng=${lng}`);
        const js = await r.json();
        if(js && js.ok && js.cidade){
          $('cidade').value = js.cidade;
          showTag('tagCidade', 'Cidade: ' + js.cidade);
        }
      }catch{}
    }
    async function askGPS(){
      if(!('geolocation' in navigator)) { $('gpsStatus').textContent = 'Seu navegador n√£o suporta geolocaliza√ß√£o.'; return; }
      $('gpsStatus').textContent = 'Solicitando localiza√ß√£o‚Ä¶';
      navigator.geolocation.getCurrentPosition(async (pos)=>{
        userLat = pos.coords.latitude;
        userLng = pos.coords.longitude;
        $('gpsStatus').innerHTML = '<span class="gps-ok">Localiza√ß√£o ativada.</span>';
        if(!$('cidade').value.trim()){
          await resolveCityByGPS(userLat,userLng);
        }
        // dispara busca auto se j√° tem algum filtro
        if(useGPS && ( $('bairro').value || $('servico').value )){
          submitBusca();
        }
      }, (err)=>{
        $('gpsStatus').innerHTML = '<span class="gps-warn">N√£o foi poss√≠vel obter a localiza√ß√£o.</span>';
        useGPS = false;
        $('useGPS').checked = false;
      }, { enableHighAccuracy:true, timeout:12000, maximumAge:30000 });
    }
    $('useGPS').addEventListener('change', (e)=>{
      useGPS = !!e.target.checked;
      if(useGPS) askGPS();
      else { $('gpsStatus').textContent = 'GPS desativado.'; userLat=null; userLng=null; }
    });

    // ---------- UI helpers ----------
    function showLoader(on){ $('loader').style.display = on? '' : 'none'; }
    function showTag(id, txt){ const el=$(id); el.textContent = txt; el.style.display='inline-flex'; }
    function hideTags(){ ['tagCidade','tagBairro','tagServico','tagRating'].forEach(id=>{ $(id).style.display='none'; }); }
    function resetResults(){
      $('results').innerHTML = '';
      page = 1; total = 0; acumulados = 0;
      $('paginacao').style.display='none';
      $('contagem').textContent='';
    }
    function applyStateTags(q){
      hideTags();
      if(q.cidade) showTag('tagCidade', 'Cidade: ' + q.cidade);
      if(q.bairro) showTag('tagBairro', 'Bairro: ' + q.bairro);
      if(q.servico) showTag('tagServico', 'Servi√ßo: ' + q.servico);
      if(q.minRating) showTag('tagRating', 'Avalia√ß√£o: ' + q.minRating + '+');
    }

    // ---------- Busca ----------
    async function fetchProfissionais(isLoadMore=false){
      const params = new URLSearchParams();
      if(lastQuery.cidade) params.set('cidade', lastQuery.cidade);
      if(lastQuery.bairro) params.set('bairro', lastQuery.bairro);
      if(lastQuery.servico) params.set('servico', lastQuery.servico);
      if(lastQuery.minRating) params.set('minRating', lastQuery.minRating);
      params.set('sort','score');
      params.set('dir','desc');
      params.set('page', String(page));
      params.set('limit', String(limit));
      if(useGPS && userLat!=null && userLng!=null){
        params.set('userLat', String(userLat));
        params.set('userLng', String(userLng));
      }

      showLoader(true);
      try{
        const r = await fetch('/api/profissionais?'+params.toString());
        const js = await r.json();
        total = js.total||0;
        renderResults(js.items||[], isLoadMore);
        acumulados += (js.items||[]).length;

        if(acumulados < total){
          $('paginacao').style.display='';
          $('contagem').textContent = `${acumulados}/${total} exibidos`;
        } else {
          $('paginacao').style.display='none';
        }
      }catch(_){
        if(!isLoadMore) $('results').innerHTML = `<div class="card"><p class="err">Falha ao carregar resultados. Tente novamente.</p></div>`;
      }finally{
        showLoader(false);
      }
    }

    function badgeHTML(plano){
      if(plano==='premium') return `<span class="badge badge-premium">PREMIUM</span>`;
      if(plano==='pro') return `<span class="badge badge-pro">PRO</span>`;
      return '';
    }

    function renderResults(items, isLoadMore){
      const grid = $('results');
      const map = (p)=> {
        const dist = kmFmt(p.distanceKm);
        const rating = Number(p.rating||0);
        const stars = estrelas(rating);
        const aval = Number(p.avaliacoes||0);
        const atend = Number(p.atendimentos||0);
        const local = [p.bairro||'', p.cidade||''].filter(Boolean).join(' ‚Äì ');
        return `
          <article class="pro-card" tabindex="0" role="link" aria-label="Abrir perfil de ${esc(p.nome)}" onclick="location.href='/perfil.html?id=${p.id}'" onkeypress="if(event.key==='Enter'){location.href='/perfil.html?id=${p.id}'}">
            <img src="${p.foto ? esc(p.foto) : 'https://via.placeholder.com/140x140?text=Foto'}" alt="Foto de ${esc(p.nome)}" width="72" height="72" loading="lazy">
            <div class="pro-info">
              <h3>${esc(p.nome)} ${badgeHTML(p.plano)}</h3>
              <div class="meta">${esc(p.servico||'')} ‚Ä¢ <span class="muted">${esc(local||'‚Äî')}</span></div>
              <div class="meta">
                <span class="star">${stars}</span>
                <span class="muted">(${aval})</span> ¬∑
                <span class="muted">Atendimentos: <strong>${atend}</strong></span> ¬∑
                <span class="muted distance">Dist√¢ncia: <strong>${dist}</strong></span>
              </div>
            </div>
          </article>
        `;
      };
      const html = (items||[]).map(map).join('');
      if(isLoadMore) grid.insertAdjacentHTML('beforeend', html);
      else grid.innerHTML = html || `<div class="card"><p class="meta">Nenhum profissional encontrado com os filtros atuais.</p></div>`;
    }

    // ---------- Eventos ----------
    function submitBusca(){
      lastQuery = {
        cidade: $('cidade').value.trim(),
        bairro: $('bairro').value.trim(),
        servico: $('servico').value.trim(),
        minRating: $('minRating').value.trim()
      };
      applyStateTags(lastQuery);
      resetResults();
      fetchProfissionais(false);
    }
    $('formBusca').addEventListener('submit', (e)=>{ e.preventDefault(); submitBusca(); });
    $('btnLimpar').addEventListener('click', ()=>{
      $('cidade').value = '';
      $('bairro').value = '';
      $('servico').value = '';
      $('minRating').value = '';
      hideTags();
      resetResults();
      fetchProfissionais(false);
    });
    $('btnMais').addEventListener('click', ()=>{
      if(acumulados < total){ page++; fetchProfissionais(true); }
    });

    // ---------- Boot ----------
    (async function init(){
      await fillCidades();

      // Se veio cidade/servi√ßo via URL, mantemos
      const u = new URL(location.href);
      const cid = u.searchParams.get('cidade') || '';
      const bai = u.searchParams.get('bairro') || '';
      const ser = u.searchParams.get('servico') || '';
      const mr  = u.searchParams.get('minRating') || '';
      if(cid) $('cidade').value = cid;
      if(bai) $('bairro').value = bai;
      if(ser) $('servico').value = ser;
      if(mr)  $('minRating').value = mr;

      // Tenta GPS leve (opt-in) se n√£o houver cidade definida
      if(!cid){
        // deixe o checkbox desmarcado; o usu√°rio opta
      }

      // Primeira carga
      submitBusca();
    })();
  })();
  </script>
</body>
</html>